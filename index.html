// --- ATUALIZAÇÃO DO SISTEMA DE MOVIMENTO E MIRA ---

function update() {
    if(!G.play || !p.alive) return;

    // 1. Movimentação Lord da Luz
    let mx = joy.active ? joy.x : (keys.has('a')?-1:keys.has('d')?1:0);
    let my = joy.active ? joy.y : (keys.has('w')?-1:keys.has('s')?1:0);
    
    p.x = Math.max(60, Math.min(G.w-60, p.x + mx * 7.2));
    p.y = Math.max(60, Math.min(G.h-60, p.y + my * 7.2));

    // 2. Verificação de Disparo (Setas ou Mobile)
    let ax = (keys.has('arrowleft')?-1:keys.has('arrowright')?1:0);
    let ay = (keys.has('arrowup')?-1:keys.has('arrowdown')?1:0);
    
    // Suporte mobile para os botões de ataque
    if(mobAtk.up) ay=-1; if(mobAtk.down) ay=1; if(mobAtk.left) ax=-1; if(mobAtk.right) ax=1;

    // 3. LÓGICA DE PRIORIDADE:
    // Se estiver atirando (ax ou ay diferente de 0), a rotação foca no tiro.
    // Se NÃO estiver atirando e estiver se movendo, a rotação foca no movimento.
    if (ax !== 0 || ay !== 0) {
        p.rot = Math.atan2(ay, ax); // Prioridade: Direção do Tiro
        fire(ax, ay);
    } else if (mx !== 0 || my !== 0) {
        p.rot = Math.atan2(my, mx); // Secundário: Direção do Movimento
    }

    // Animação das pernas baseada no movimento real
    if(mx !== 0 || my !== 0) {
        p.leg += 0.25;
    }

    // Lógica de Recarga
    if(p.rel) { 
        p.relT++; 
        if(p.relT > 60) { 
            G.inv[G.weapon].a = G.inv[G.weapon].m; 
            p.rel = false; 
            p.relT = 0; 
        }
    }

    // --- RESTANTE DO CÓDIGO (Inimigos, Projéteis, etc) ---
    // (Mantenha o resto da função update original abaixo daqui)
    
    // Inimigos...
    enemies.forEach((e, i) => {
        // ... (código original de IA dos inimigos)
    });

    // Projéteis...
    projectiles.forEach((pr, i) => {
        // ... (código original de colisão)
    });

    // ... (restante das detecções de sala e buffs)
    
    if(p.iframe > 0) p.iframe--;
    if(G.hp <= 0 && p.alive) { 
        p.alive = false; 
        document.getElementById('death-screen').style.display='flex'; 
    }
    p.t++;
}
