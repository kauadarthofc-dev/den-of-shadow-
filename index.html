<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow üíÄ</title>
    <style>
        :root {
            --rarity-comum: #3498db; --rarity-incomum: #2ecc71; --rarity-raro: #f1c40f;
            --rarity-epico: #9b59b6; --rarity-lendario: linear-gradient(45deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
        }
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #121212; color: white; font-family: 'Courier New', Courier, monospace; overflow: hidden; }
        canvas { display: block; image-rendering: pixelated; }

        /* UI SCREENS */
        .screen { position: absolute; inset: 0; background: rgba(0,0,0,0.92); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .title-container { border: 4px solid #fff; padding: 20px; background: #2c3e50; box-shadow: 0 0 20px #e74c3c; margin-bottom: 20px; }
        .title-text { font-size: 48px; color: #e74c3c; margin: 0; text-transform: uppercase; }
        .btn { padding: 15px 40px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 18px; margin: 10px; transition: 0.2s; }
        .btn-play { background: #2ecc71; color: white; }
        .btn-save { background: #34495e; color: #ecf0f1; border: 2px solid #fff; width: 200px; }

        /* SAVE SLOTS */
        .save-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .slot { width: 120px; height: 120px; background: #1a1a1a; border: 3px solid #555; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .slot.active { border-color: #2ecc71; box-shadow: 0 0 10px #2ecc71; }

        /* UPGRADE CARDS */
        #upgrade-screen { display: none; z-index: 3000; background: rgba(5,5,15,0.98); }
        .card-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; padding: 20px; }
        .card { width: 220px; height: 320px; border: 5px solid #fff; border-radius: 15px; padding: 20px; position: relative; cursor: pointer; transition: 0.3s; background: #0f172a; overflow: hidden; }
        .card::before { content: 'üíÄ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 120px; opacity: 0.05; z-index: 0; }
        .card:hover { transform: scale(1.05); }

        /* HUD & MOBILE */
        #hud { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 1000; }
        #boss-ui { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 60%; display: none; }
        .hp-bar { height: 20px; background: #333; border: 2px solid #fff; border-radius: 10px; overflow: hidden; }
        .hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: 0.2s; }
        
        #mobile-controls { position: absolute; inset: 0; pointer-events: none; display: none; }
        .joy-area { position: absolute; bottom: 50px; left: 50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        .atk-grid { position: absolute; bottom: 40px; right: 40px; display: grid; grid-template-columns: repeat(3, 90px); gap: 10px; pointer-events: auto; }
        .btn-round { width: 90px; height: 90px; background: rgba(255,255,255,0.1); border: 4px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; }
        #swap-btn { position: absolute; bottom: 50px; right: 350px; width: 100px; height: 100px; background: #f1c40f; pointer-events: auto; border: 3px solid #fff; border-radius: 15px; color: #000; font-weight: bold; }
        #fs-btn { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: #333; color: #fff; border: 2px solid #fff; pointer-events: auto; z-index: 2500; border-radius: 20px; }
        
        #weapon-popup { position: absolute; bottom: 200px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 2px solid #f1c40f; padding: 15px; border-radius: 10px; display: none; text-align: center; }
    </style>
</head>
<body>

<div id="start-screen" class="screen">
    <div class="title-container">
        <h1 class="title-text">Den of Shadow üíÄ</h1>
    </div>
    <div id="platform-tips" style="color: #f1c40f; margin-bottom: 20px;"></div>
    
    <div class="save-grid">
        <div class="slot" onclick="selectSlot(0)" id="slot-0">SLOT 1<br><span id="data-0">Vazio</span></div>
        <div class="slot" onclick="selectSlot(1)" id="slot-1">SLOT 2<br><span id="data-1">Vazio</span></div>
        <div class="slot" onclick="selectSlot(2)" id="slot-2">SLOT 3<br><span id="data-2">Vazio</span></div>
    </div>

    <button class="btn btn-play" id="btn-start">CARREGAR JOGO</button>
    
    <div style="margin-top: 30px;">
        <a href="mailto:kauadarthofc@gmail.com" style="color: #bdc3c7; text-decoration: none;">üìß kauadarthofc@gmail.com</a><br><br>
        <a href="https://youtube.com/@kaua_darth" target="_blank" style="color: #ff0000; text-decoration: none; font-weight: bold;">üé¨ YouTube: @kaua_darth</a>
    </div>
</div>

<div id="loading-screen" class="screen" style="display:none;">
    <h2 id="load-text">CALIBRANDO SOMBRAS...</h2>
    <div style="width: 300px; height: 20px; border: 2px solid #fff;"><div id="load-bar" style="width: 0%; height: 100%; background: #2ecc71;"></div></div>
</div>

<div id="fs-btn" onclick="toggleFS()">TELA CHEIA</div>
<div id="hud">
    <div id="room-tag" style="font-size: 24px; font-weight: bold;">SALA: 0 (Tutorial)</div>
    <div id="weapon-tag" style="font-size: 18px; color: #f1c40f;"></div>
    <div id="hp-container" style="display: flex; gap: 5px; margin-top: 10px;"></div>
</div>

<div id="boss-ui">
    <div id="boss-name" style="text-align: center; font-weight: bold; margin-bottom: 5px;">BOSS</div>
    <div class="hp-bar"><div id="boss-hp-fill" class="hp-fill"></div></div>
</div>

<div id="upgrade-screen" class="screen">
    <h2 style="color: #f1c40f;">UPGRADE DISPON√çVEL</h2>
    <div id="card-box" class="card-container"></div>
</div>

<div id="weapon-popup"></div>
<canvas id="gameCanvas"></canvas>

<div id="mobile-controls">
    <div class="joy-area" id="joy-base"><div id="joy-stick" style="width: 60px; height: 60px; background: #fff; border-radius: 50%; position: absolute; left: 45px; top: 45px;"></div></div>
    <div class="atk-grid">
        <div></div><div class="btn-round" data-dir="up">‚ñ≤</div><div></div>
        <div class="btn-round" data-dir="left">‚óÄ</div><div class="btn-round" data-dir="down">‚ñº</div><div class="btn-round" data-dir="right">‚ñ∂</div>
    </div>
    <button id="swap-btn">SWAP üîÑ</button>
</div>

<script>
/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// --- CONFIGURA√á√ÉO GLOBAL ---
let G = {
    play: false, currentSlot: 0, room: 0, kills: 0, 
    hp: 12, maxHp: 12, mode: 'normal',
    weapon: 'magnum',
    hasFire: false, hasShot: false, hasStaff: false,
    triple: 0, ric: 0, dual: false, vamp: 0,
    w: 2400, h: 1800, cx: 0, cy: 0,
    inv: {
        magnum: { n: "Magnum", a: 20, m: 20, d: 15, cd: 15, c: "#00eaff" },
        fire: { n: "Lan√ßa-Chamas", a: 25, m: 25, d: 4, cd: 2, c: "#ff6a00" }, // Baforada cad√™ncia alta
        shotgun: { n: "Shotgun", a: 8, m: 8, d: 14, cd: 60, c: "#f1c40f" },
        staff: { n: "Cajado M√≠stico", a: 12, m: 12, d: 6, cd: 30, c: "#9b59b6" }
    }
};

let p = { x: 1200, y: 900, r: 50, speed: 8.5, rot: 0, leg: 0, iframe: 0, rel: false, relT: 0, isAtk: false };
let enemies = [], projectiles = [], drops = [], pedestals = [], warns = [], particles = [];
const keys = new Set();
const mobAtk = { up: false, down: false, left: false, right: false };

// --- SISTEMA DE SALVAMENTO ---
function selectSlot(i) {
    G.currentSlot = i;
    document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
    document.getElementById(`slot-${i}`).classList.add('active');
}

function saveGame() {
    const data = { room: G.room, kills: G.kills, hasFire: G.hasFire, hasShot: G.hasShot, hasStaff: G.hasStaff, maxHp: G.maxHp };
    localStorage.setItem(`denOfShadow_slot_${G.currentSlot}`, JSON.stringify(data));
    updateSlotUI();
}

function updateSlotUI() {
    for(let i=0; i<3; i++) {
        let raw = localStorage.getItem(`denOfShadow_slot_${i}`);
        document.getElementById(`data-${i}`).innerText = raw ? `Sala ${JSON.parse(raw).room}` : "Vazio";
    }
}
updateSlotUI();

// --- INICIALIZA√á√ÉO ---
if(isMobile) {
    document.getElementById('mobile-controls').style.display = 'block';
} else {
    document.getElementById('platform-tips').innerText = "Dica: Use WASD para andar e SETAS para atirar. Q troca arma.";
}

function spawnRoom() {
    enemies = []; projectiles = []; drops = []; warns = []; pedestals = [];
    if(G.room === 0) return; // Tutorial vazio

    if(G.room % 10 === 0 && G.mode !== 'heal') {
        // BOSS
        let hp = 2000 + (G.room * 150);
        enemies.push({ type: 'boss', x: G.w/2, y: G.h/2-300, r: 180, hp: hp, max: hp, name: "Sombra Gigante", t: 0 });
        document.getElementById('boss-ui').style.display = 'block';
    } else if(G.mode === 'heal') {
        drops.push({ x: G.w/2, y: G.h/2, type: 'full_heal' });
    } else {
        let count = 5 + Math.floor(G.room/2);
        for(let i=0; i<count; i++) {
            let ex, ey;
            do { ex = Math.random()*G.w; ey = Math.random()*G.h; } while(Math.hypot(ex-p.x, ey-p.y) < 600);
            let t = G.room === 1 ? 'stalker' : (Math.random() < 0.2 ? 'kamikaze' : (Math.random() < 0.2 ? 'dasher' : 'stalker'));
            enemies.push({ type: t, x: ex, y: ey, r: 55, hp: 100 + G.room*10, spd: (t==='kamikaze'?1.5:2.5), f: Math.floor(Math.random()*4), hit:0 });
        }
    }

    if(G.room === 5 && !G.hasFire) pedestals.push({ x: G.w/2, y: G.h/2, type: 'fire', d: "Baforada de Fogo: Dano 4 + 2 Queima" });
    if(G.room === 15 && !G.hasShot) pedestals.push({ x: G.w/2, y: G.h/2, type: 'shotgun', d: "Shotgun: 17 Dano, alcance curto" });
    if(G.room === 25 && !G.hasStaff) pedestals.push({ x: G.w/2, y: G.h/2, type: 'staff', d: "Cajado: Tiros Teleguiados" });
}

function fire(dx, dy) {
    const w = G.inv[G.weapon];
    if(p.rel || w.a <= 0) return;
    
    if(p.t % w.cd === 0) {
        let ang = Math.atan2(dy, dx);
        p.rot = ang; p.isAtk = true;
        
        let n = (1 + G.triple) * (G.dual ? 2 : 1);
        for(let i=0; i<n; i++) {
            let spread = (i - (n-1)/2) * 0.2;
            let a = ang + spread;
            
            if(G.weapon === 'fire') {
                for(let j=0; j<3; j++) projectiles.push({ x: p.x, y: p.y, dx: Math.cos(a+(Math.random()-0.5)*0.4)*20, dy: Math.sin(a+(Math.random()-0.5)*0.4)*20, type:'fire', life:15, dmg:4 });
            } else if(G.weapon === 'shotgun') {
                for(let j=-1; j<=1; j++) projectiles.push({ x: p.x, y: p.y, dx: Math.cos(a+j*0.2)*25, dy: Math.sin(a+j*0.2)*25, type:'shotgun', life:12, dmg:17 });
            } else if(G.weapon === 'staff') {
                projectiles.push({ x: p.x, y: p.y, dx: Math.cos(a)*15, dy: Math.sin(a)*15, type:'staff', life:120, dmg:6, home: true });
            } else {
                projectiles.push({ x: p.x, y: p.y, dx: Math.cos(a)*25, dy: Math.sin(a)*25, type:'magnum', life:80, dmg:15 });
            }
        }
        w.a--; if(w.a <= 0) p.rel = true;
    }
}

function update() {
    if(!G.play) return;

    // Movimento
    let mx = 0, my = 0;
    if(keys.has('a')) mx = -1; if(keys.has('d')) mx = 1;
    if(keys.has('w')) my = -1; if(keys.has('s')) my = 1;
    if(joy.active) { mx = joy.vx; my = joy.vy; }

    p.x = Math.max(60, Math.min(G.w-60, p.x + mx * p.speed));
    p.y = Math.max(60, Math.min(G.h-60, p.y + my * p.speed));

    // Ataque & Rota√ß√£o
    let ax = 0, ay = 0;
    if(keys.has('arrowleft')) ax = -1; if(keys.has('arrowright')) ax = 1;
    if(keys.has('arrowup')) ay = -1; if(keys.has('arrowdown')) ay = 1;
    if(mobAtk.up) ay = -1; if(mobAtk.down) ay = 1; if(mobAtk.left) ax = -1; if(mobAtk.right) ax = 1;

    p.isAtk = (ax !== 0 || ay !== 0);
    if(p.isAtk) {
        p.rot = Math.atan2(ay, ax);
        fire(ax, ay);
    } else if(mx !== 0 || my !== 0) {
        p.rot = Math.atan2(my, mx);
        p.leg += 0.2;
    }

    if(p.rel) { p.relT++; if(p.relT > 60){ G.inv[G.weapon].a = G.inv[G.weapon].m; p.rel=false; p.relT=0; }}

    // Inimigos
    enemies.forEach((e, i) => {
        let dist = Math.hypot(p.x-e.x, p.y-e.y);
        let ang = Math.atan2(p.y-e.y, p.x-e.x);

        if(e.type === 'boss') {
            e.t++; e.x += Math.cos(e.t/50)*5;
            if(e.t % 100 === 0) warns.push({ x: p.x, y: p.y, t: 90 });
            document.getElementById('boss-hp-fill').style.width = (e.hp/e.max)*100 + "%";
        } else {
            let s = e.spd;
            if(e.type === 'dasher') { e.dt = (e.dt||0)+1; if(e.dt>80){ s=15; if(e.dt>95)e.dt=0; } }
            e.x += Math.cos(ang)*s; e.y += Math.sin(ang)*s;
        }

        // Colis√£o Player (Empurr√£o e Dano)
        if(dist < p.r + e.r) {
            let push = Math.atan2(e.y-p.y, e.x-p.x);
            e.x += Math.cos(push)*30; e.y += Math.sin(push)*30;
            if(p.iframe <= 0) { G.hp -= (e.type==='kamikaze'?2:1); p.iframe=60; if(e.type==='kamikaze') e.hp=0; }
        }

        // Impedir sobreposi√ß√£o
        enemies.forEach(o => { if(e!==o && Math.hypot(e.x-o.x, e.y-o.y) < e.r+o.r){ let a=Math.atan2(o.y-e.y, o.x-e.x); o.x+=Math.cos(a)*2; o.y+=Math.sin(a)*2; }});

        if(e.hp <= 0) {
            if(e.type === 'kamikaze') {
                enemies.forEach(o => { if(Math.hypot(e.x-o.x, e.y-o.y) < 250) o.hp -= 200; });
                for(let k=0; k<15; k++) particles.push({x:e.x, y:e.y, dx:(Math.random()-0.5)*20, dy:(Math.random()-0.5)*20, c:"#ff4500", l:30});
            }
            G.kills++; if(G.vamp > 0 && G.kills % 10 === 0) G.hp = Math.min(G.maxHp, G.hp+1);
            if(Math.random() < 0.15) drops.push({ x:e.x, y:e.y, type:'heal' });
            if(Math.random() < 0.1) drops.push({ x:e.x, y:e.y, type:'ammo' });
            if(e.type === 'boss') { 
                G.mode = 'heal_open'; 
                document.getElementById('boss-ui').style.display='none';
                showUpgrades(); 
            }
            enemies.splice(i, 1);
        }
    });

    // Proj√©teis
    projectiles.forEach((pr, i) => {
        if(pr.home) {
            let target = enemies[0];
            if(target) { let ta = Math.atan2(target.y-pr.y, target.x-pr.x); pr.dx += Math.cos(ta)*0.8; pr.dy += Math.sin(ta)*0.8; }
        }
        pr.x += pr.dx; pr.y += pr.dy; pr.life--;
        enemies.forEach(e => {
            if(Math.hypot(pr.x-e.x, pr.y-e.y) < e.r + 20) {
                e.hp -= pr.dmg; if(pr.type==='fire') e.hp -= 2; // Dano queima
                if(G.ric > 0 && !pr.ric) { pr.dx *= -1; pr.dy *= -1; pr.ric=true; } else projectiles.splice(i, 1);
            }
        });
        if(pr.life <= 0) projectiles.splice(i,1);
    });

    // Portas e Pedestais
    if(enemies.length === 0) {
        if(Math.hypot(p.x - G.w/2, p.y) < 120) { G.room++; G.mode='normal'; spawnRoom(); p.y=G.h-200; saveGame(); }
        if(G.mode==='heal_open' && p.x < 100) { G.mode='heal'; spawnRoom(); p.x=G.w-200; }
    }

    pedestals.forEach((ped, i) => {
        if(Math.hypot(p.x-ped.x, p.y-ped.y) < 150) {
            document.getElementById('weapon-popup').style.display = 'block';
            document.getElementById('weapon-popup').innerText = ped.d;
            if(Math.hypot(p.x-ped.x, p.y-ped.y) < 70) { G['has'+ped.type.charAt(0).toUpperCase()+ped.type.slice(1)] = true; pedestals.splice(i,1); }
        } else document.getElementById('weapon-popup').style.display = 'none';
    });

    drops.forEach((d, i) => {
        if(Math.hypot(p.x-d.x, p.y-d.y) < 70) {
            if(d.type==='heal') G.hp = Math.min(G.maxHp, G.hp+2);
            if(d.type==='full_heal') G.hp = G.maxHp;
            if(d.type==='ammo') G.inv[G.weapon].a = G.inv[G.weapon].m;
            drops.splice(i,1);
        }
    });

    if(p.iframe > 0) p.iframe--;
    if(G.hp <= 0) { G.play = false; document.getElementById('start-screen').style.display='flex'; }
    p.t++;
}

// --- RENDER ---
function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    if(!G.play) return;

    ctx.save();
    G.cx += (p.x - canvas.width/2 - G.cx) * 0.1;
    G.cy += (p.y - canvas.height/2 - G.cy) * 0.1;
    ctx.translate(-G.cx, -G.cy);

    // Cen√°rio profissional
    ctx.fillStyle = G.mode==='heal'?"#1abc9c":(G.room%10===0?"#c0392b":"#2c3e50");
    ctx.fillRect(0,0, G.w, G.h);
    ctx.strokeStyle="rgba(255,255,255,0.05)";
    for(let i=0; i<G.w; i+=120){ ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,G.h); ctx.stroke(); }

    // Lorde da Luz (Player)
    let ly = Math.sin(p.leg)*15;
    ctx.fillStyle="#fff"; ctx.fillRect(p.x-20, p.y+30+ly, 12, 18); ctx.fillRect(p.x+8, p.y+30-ly, 12, 18);
    ctx.shadowBlur = 25; ctx.shadowColor = "#00eaff";
    ctx.fillStyle = p.iframe>0 ? "#ff4d6d" : "#fff";
    ctx.fillRect(p.x-40, p.y-50, 80, 90); ctx.shadowBlur = 0;
    
    // Arma
    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot);
    ctx.fillStyle="#95a5a6"; ctx.fillRect(35, -10, 45, 20); ctx.restore();

    // Inimigos com Rostos
    enemies.forEach(e => {
        ctx.fillStyle = e.type==='kamikaze'?"#e74c3c":(e.type==='dasher'?"#9b59b6":"#34495e");
        ctx.fillRect(e.x-e.r, e.y-e.r, e.r*2, e.r*2);
        ctx.fillStyle=e.type==='kamikaze'?"#ff0000":"#fff"; ctx.font="30px Arial";
        ctx.fillText(e.type==='kamikaze'?"√≤_√≥":["o_o","-_-",">_<","o.o"][e.f], e.x-25, e.y+10);
    });

    projectiles.forEach(pr => { ctx.fillStyle=G.inv[pr.type].c; ctx.beginPath(); ctx.arc(pr.x, pr.y, 15, 0, 7); ctx.fill(); });
    drops.forEach(d => { ctx.fillStyle="#ff4d6d"; ctx.fillRect(d.x-25, d.y-25, 50, 50); });
    pedestals.forEach(ped => { ctx.fillStyle="#f1c40f"; ctx.fillRect(ped.x-60, ped.y-60, 120, 120); });

    // Portas
    if(enemies.length === 0) {
        ctx.fillStyle="#f1c40f"; ctx.fillRect(G.w/2-100, -20, 200, 50);
        if(G.mode==='heal_open') ctx.fillRect(-20, G.h/2-100, 50, 200);
    }

    ctx.restore();

    // Minimapa
    const ms=180, mx=canvas.width-200, my=20;
    ctx.fillStyle="rgba(0,0,0,0.7)"; ctx.fillRect(mx, my, ms, ms);
    enemies.forEach(e => { ctx.fillStyle="red"; ctx.fillRect(mx+(e.x/G.w)*ms, my+(e.y/G.h)*ms, 5, 5); });
    ctx.fillStyle="#00eaff"; ctx.fillRect(mx+(p.x/G.w)*ms, my+(p.y/G.h)*ms, 8, 8);

    // HUD Update
    document.getElementById('weapon-tag').innerText = `${G.inv[G.weapon].n}: ${G.inv[G.weapon].a}/${G.inv[G.weapon].m}`;
    document.getElementById('hp-container').innerHTML = '‚ù§Ô∏è'.repeat(G.hp/2);

    requestAnimationFrame(() => { update(); draw(); });
}

// --- UPGRADES ---
function showUpgrades() {
    G.play = false; document.getElementById('upgrade-screen').style.display='flex';
    const box = document.getElementById('card-box'); box.innerHTML='';
    const pool = [
        {n:"TIRO TRIPLO", d:"Dispara em 3 dire√ß√µes.", r:"comum", f:()=>G.triple++},
        {n:"VAMPIRISMO", d:"Cura a cada 10 mortes.", r:"incomum", f:()=>G.vamp++},
        {n:"RICOCHETE", d:"Balas quicam nos inimigos.", r:"raro", f:()=>G.ric++},
        {n:"DUAL WIELD", d:"Use duas armas ao mesmo tempo!", r:"lendario", f:()=>G.dual=true}
    ];
    for(let i=0; i<3; i++) {
        let u = pool[Math.floor(Math.random()*pool.length)];
        let div = document.createElement('div'); div.className='card';
        div.style.borderColor = `var(--rarity-${u.r})`;
        div.innerHTML = `<h3>${u.n}</h3><p>${u.d}</p><br><b>${u.r.toUpperCase()}</b>`;
        div.onclick = () => { u.f(); G.play=true; document.getElementById('upgrade-screen').style.display='none'; };
        box.appendChild(div);
    }
}

// --- CONTROLES ---
const joy = { active: false, vx: 0, vy: 0 };
document.getElementById('joy-base').ontouchstart = (e) => { joy.active=true; };
document.getElementById('joy-base').ontouchmove = (e) => {
    let t = e.touches[0]; let b = document.getElementById('joy-base').getBoundingClientRect();
    let dx = t.clientX - (b.left + 75); let dy = t.clientY - (b.top + 75);
    let dist = Math.min(Math.hypot(dx,dy), 50); let ang = Math.atan2(dy,dx);
    joy.vx = (Math.cos(ang)*dist)/50; joy.vy = (Math.sin(ang)*dist)/50;
    document.getElementById('joy-stick').style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
};
document.getElementById('joy-base').ontouchend = () => { joy.active=false; joy.vx=0; joy.vy=0; document.getElementById('joy-stick').style.transform='none'; };

document.querySelectorAll('.btn-round').forEach(b => {
    b.ontouchstart = () => mobAtk[b.dataset.dir] = true;
    b.ontouchend = () => mobAtk[b.dataset.dir] = false;
});

function swap() {
    let list = ['magnum']; if(G.hasFire) list.push('fire'); if(G.hasShot) list.push('shotgun'); if(G.hasStaff) list.push('staff');
    G.weapon = list[(list.indexOf(G.weapon)+1)%list.length];
}
document.getElementById('swap-btn').onclick = swap;
window.onkeydown=e=>{ keys.add(e.key.toLowerCase()); if(e.key==='q') swap(); };
window.onkeyup=e=>keys.delete(e.key.toLowerCase());

document.getElementById('btn-start').onclick = () => {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('loading-screen').style.display = 'flex';
    let p = 0; let bar = document.getElementById('load-bar');
    let inter = setInterval(() => {
        p += 5; bar.style.width = p + "%";
        if(p>=100){ clearInterval(inter); document.getElementById('loading-screen').style.display='none'; G.play=true; spawnRoom(); draw(); }
    }, 50);
};

function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
window.onresize = () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }; window.onresize();
</script>
</body>
</html>
