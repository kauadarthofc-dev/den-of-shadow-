<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow</title>
    <style>
        * { touch-action: none !important; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }
        html, body { background: #050505; margin: 0; padding: 0; overflow: hidden; height: 100%; width: 100%; position: fixed; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #fff; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        /* Overlay Systems */
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .btn-ui { padding: 15px 50px; border: 3px solid #ff4d6d; background: #111; color: #fff; font-size: 22px; font-weight: bold; border-radius: 50px; cursor: pointer; transition: 0.3s; }
        .btn-ui:hover { background: #ff4d6d; box-shadow: 0 0 20px #ff4d6d; }

        /* Mobile UI Improvement */
        #mobile-ui { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        #joy-bound { position: absolute; bottom: 10%; left: 5%; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border: 3px solid rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; left: 50px; top: 50px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.4; pointer-events: none; }
        
        #shoot-ctrl { position: absolute; bottom: 8%; right: 5%; display: grid; grid-template-columns: repeat(3, 85px); gap: 15px; pointer-events: auto; }
        .atk-btn { width: 85px; height: 85px; background: rgba(52,152,219,0.1); border: 3px solid #3498db; border-radius: 50%; color: #3498db; display: flex; justify-content: center; align-items: center; font-size: 32px; cursor: pointer; }
        
        #swap-btn { position: absolute; bottom: 10%; right: 35%; width: 100px; height: 100px; background: rgba(241,196,15,0.1); border: 4px solid #f1c40f; border-radius: 20px; color: #f1c40f; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; pointer-events: auto; z-index: 1100; }
        #fs-btn { position: absolute; top: 20px; right: 20px; padding: 12px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 10px; z-index: 2500; cursor: pointer; display: none; pointer-events: auto; font-weight: bold; }

        /* Upgrade Cards */
        #card-screen { display: none; z-index: 3000; }
        .card-container { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; justify-content: center; }
        .card { width: 140px; height: 200px; background: #1a1a1a; border: 3px solid #f1c40f; border-radius: 15px; cursor: pointer; padding: 15px; }
    </style>
</head>
<body>

<div id="fs-btn" onclick="toggleFS()">⛶ TELA CHEIA</div>

<div id="start-screen" class="overlay">
    <h1 style="color:#ff4d6d; font-size:50px; margin:0; text-shadow: 0 0 30px red;">DEN OF SHADOW</h1>
    <p style="letter-spacing: 2px; color: #aaa;">SALA 5: FOGO | SALA 15: ÁCIDO</p>
    <div class="btn-ui" id="btn-start">INICIAR JORNADA</div>
</div>

<div id="card-screen" class="overlay">
    <h2 style="color:#f1c40f">UPGRADE CONCEDIDO</h2>
    <div class="card-container" id="cards"></div>
</div>

<div id="death-screen" class="overlay" style="display:none;">
    <h1 style="color:red; font-size: 60px;">VOCÊ CAIU</h1>
    <div class="btn-ui" onclick="location.reload()">REENTRAR NO COVIL</div>
</div>

<div id="game-container">
    <canvas id="game"></canvas>
    <div id="mobile-ui">
        <div id="joy-bound"><div id="joy-stick"></div></div>
        <div id="shoot-ctrl">
            <div></div><div class="atk-btn" data-dir="up">▲</div><div></div>
            <div class="atk-btn" data-dir="left">◀</div><div class="atk-btn" data-dir="down">▼</div><div class="atk-btn" data-dir="right">▶</div>
        </div>
        <div id="swap-btn">TROCAR<br>ARMA</div>
    </div>
</div>

<script>
/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
if(isMobile) document.getElementById('fs-btn').style.display = 'block';

// Configurações Globais
const Game = {
    started: false, paused: false, room: 0, isHealRoom: false,
    roomW: 1400, roomH: 1000, camX: 0, camY: 0,
    lives: 6, maxLives: 6, weapon: 'normal',
    dmgMult: 1, atkSpd: 16, moveSpd: 6,
    hasFire: false, hasAcid: false,
    ammo: 6, maxAmmo: 6, reloading: false, reloadTimer: 0,
    doorPos: { x: 0, y: 0, side: 'top', open: false },
    healDoor: { x: 0, y: 0, open: false }
};

const Weapons = {
    normal: { dmg: 10, max: 6, color: "#0ff", name: "MAGNUM" },
    fire: { dmg: 18, max: 12, color: "#ff4500", name: "FOGO" },
    acid: { dmg: 22, max: 8, color: "#32cd32", name: "ÁCIDO" }
};

const UpgradePool = [
    { name: "Coração", desc: "+2 HP Máx", action: () => { Game.maxLives += 2; Game.lives += 2; } },
    { name: "Dano", desc: "+40% Força", action: () => { Game.dmgMult += 0.4; } },
    { name: "Rapidez", desc: "-3ms Delay", action: () => { Game.atkSpd = Math.max(6, Game.atkSpd - 3); } },
    { name: "Sapatos", desc: "+1.2 Speed", action: () => { Game.moveSpd += 1.2; } }
];

let enemies = [], projectiles = [], particles = [], pools = [], pedestal = null;
let p = { x: 700, y: 500, iframe: 0, timer: 0, dead: false };
const keys = new Set();
const attackDir = { up: false, down: false, left: false, right: false };
const joy = { active: false, x: 0, y: 0, startX: 0, startY: 0 };
let audioCtx = null;

// Sistema de Audio
function playSfx(f, type, dur, vol=0.1) {
    if(!audioCtx) return;
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = type; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.setValueAtTime(vol, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + dur);
}

function spawnParticles(x, y, color, count=10) {
    for(let i=0; i<count; i++) particles.push({ x, y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, life:1.0, color, size:Math.random()*5+2 });
}

// Inicializar Sala
function initRoom() {
    enemies = []; projectiles = []; pools = []; pedestal = null;
    p.x = Game.roomW/2; p.y = Game.roomH/2; p.iframe = 40;
    Game.doorPos.open = false; Game.healDoor.open = false;

    if(Game.isHealRoom) {
        pedestal = { type: 'heart', x: Game.roomW/2, y: Game.roomH/2 };
        Game.doorPos.side = 'top'; Game.doorPos.x = Game.roomW/2-60; Game.doorPos.y = 0;
    } else {
        // Criar Portas
        const sides = ['top', 'bottom', 'left', 'right'];
        Game.doorPos.side = sides[Math.floor(Math.random()*4)];
        if(Game.doorPos.side==='top'){ Game.doorPos.x=Game.roomW/2-60; Game.doorPos.y=0; }
        else if(Game.doorPos.side==='bottom'){ Game.doorPos.x=Game.roomW/2-60; Game.doorPos.y=Game.roomH-20; }
        else if(Game.doorPos.side==='left'){ Game.doorPos.x=0; Game.doorPos.y=Game.roomH/2-60; }
        else { Game.doorPos.x=Game.roomW-20; Game.doorPos.y=Game.roomH/2-60; }

        // Inimigos e Bosses
        if(Game.room > 0 && Game.room % 10 === 0) {
            Game.healDoor.x = 0; Game.healDoor.y = Game.roomH/2-60;
            const subs = { 10:'stalker', 20:'shooter', 30:'assassin', 40:'stalker', 50:'kamikaze' };
            enemies.push({ type:'boss', sub:subs[Game.room]||'shooter', x:Game.roomW/2-75, y:200, hp:500+Game.room*20, maxHp:500+Game.room*20, w:150, h:150, hit:0, timer:0 });
        } else if(Game.room > 0) {
            let n = 3 + Math.floor(Game.room/2);
            for(let i=0; i<n; i++) {
                let ex, ey;
                do { ex = Math.random()*(Game.roomW-200)+100; ey = Math.random()*(Game.roomH-200)+100; } while(Math.hypot(ex-p.x, ey-p.y) < 350);
                enemies.push({ type: Math.random()<0.25?'kamikaze':'stalker', x:ex, y:ey, hp:50+Game.room*6, w:40, h:40, hit:0 });
            }
        }
        // Armas Pedestais
        if(Game.room === 5 && !Game.hasFire) pedestal = { type:'fire', x:Game.roomW/2, y:300 };
        if(Game.room === 15 && !Game.hasAcid) pedestal = { type:'acid', x:Game.roomW/2, y:300 };
    }
}

function showCards() {
    Game.paused = true;
    const cont = document.getElementById('cards'); cont.innerHTML = '';
    document.getElementById('card-screen').style.display = 'flex';
    UpgradePool.sort(()=>0.5-Math.random()).slice(0,3).forEach(u => {
        const d = document.createElement('div'); d.className = 'card';
        d.innerHTML = `<h3>${u.name}</h3><p>${u.desc}</p>`;
        d.onclick = () => { u.action(); Game.paused = false; document.getElementById('card-screen').style.display = 'none'; };
        cont.appendChild(d);
    });
}

function cycleWeapon() {
    const list = ['normal']; if(Game.hasFire) list.push('fire'); if(Game.hasAcid) list.push('acid');
    let idx = (list.indexOf(Game.weapon) + 1) % list.length;
    Game.weapon = list[idx];
    Game.maxAmmo = Weapons[Game.weapon].max; Game.ammo = Game.maxAmmo; Game.reloading = false;
    playSfx(400, 'triangle', 0.1);
}

function drawBackground() {
    // Escolhe cor do cenário por andar
    let floorColor = "#111", gridColor = "#1a1a1a";
    if(Game.room >= 40) floorColor = "#1a0505";
    else if(Game.room >= 20) floorColor = "#05051a";
    else if(Game.isHealRoom) floorColor = "#051a05";

    ctx.fillStyle = floorColor; ctx.fillRect(0,0, Game.roomW, Game.roomH);
    ctx.strokeStyle = gridColor; ctx.lineWidth = 2;
    for(let x=0; x<=Game.roomW; x+=100) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x, Game.roomH); ctx.stroke(); }
    for(let y=0; y<=Game.roomH; y+=100) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(Game.roomW, y); ctx.stroke(); }
}

function drawMiniMap() {
    const s = 120, x = canvas.width - s - 20, y = 20;
    ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(x,y,s,s);
    ctx.strokeStyle = "#fff"; ctx.strokeRect(x,y,s,s);
    // Player
    ctx.fillStyle = "#fff"; ctx.fillRect(x + (p.x/Game.roomW)*s - 2, y + (p.y/Game.roomH)*s - 2, 4, 4);
    // Inimigos
    ctx.fillStyle = "red"; enemies.forEach(e => ctx.fillRect(x + (e.x/Game.roomW)*s - 1.5, y + (e.y/Game.roomH)*s - 1.5, 3, 3));
    // Portas
    if(Game.doorPos.open) { ctx.fillStyle = "#f1c40f"; ctx.fillRect(x + (Game.doorPos.x/Game.roomW)*s, y + (Game.doorPos.y/Game.roomH)*s, 8, 4); }
}

function loop() {
    if(!Game.started || Game.paused) return requestAnimationFrame(loop);
    ctx.clearRect(0,0, canvas.width, canvas.height);
    
    ctx.save();
    Game.camX += (p.x - canvas.width/2 - Game.camX) * 0.1;
    Game.camY += (p.y - canvas.height/2 - Game.camY) * 0.1;
    ctx.translate(-Game.camX, -Game.camY);

    drawBackground();

    // Player
    if(!p.dead) {
        let mx = joy.active ? joy.x : (keys.has('a')?-1:keys.has('d')?1:0);
        let my = joy.active ? joy.y : (keys.has('w')?-1:keys.has('s')?1:0);
        p.x = Math.max(20, Math.min(Game.roomW-50, p.x + mx * Game.moveSpd));
        p.y = Math.max(20, Math.min(Game.roomH-50, p.y + my * Game.moveSpd));
        if(p.iframe > 0) p.iframe--;
        ctx.fillStyle = p.iframe%4<2?"#fff":"#ff4d6d"; 
        ctx.fillRect(p.x, p.y, 30, 30);
        
        // Arma Sprite (Magnum)
        ctx.fillStyle = "#444"; ctx.fillRect(p.x+10, p.y+10, 25, 10);

        p.timer++;
        if(Game.reloading) { Game.reloadTimer++; if(Game.reloadTimer > 50){ Game.ammo=Game.maxAmmo; Game.reloading=false; Game.reloadTimer=0; }}
        
        let sx = (keys.has('arrowleft')?-1:keys.has('arrowright')?1:0);
        let sy = (keys.has('arrowup')?-1:keys.has('arrowdown')?1:0);
        if(attackDir.up) sy=-1; if(attackDir.down) sy=1; if(attackDir.left) sx=-1; if(attackDir.right) sx=1;

        if((sx||sy) && p.timer % Game.atkSpd === 0 && !Game.reloading) {
            projectiles.push({x:p.x+15, y:p.y+15, dx:sx, dy:sy, type:Game.weapon, owner:'player'});
            Game.ammo--; if(Game.ammo<=0) Game.reloading=true; playSfx(200, 'square', 0.05);
        }
    }

    // Inimigos
    enemies.forEach((e, i) => {
        let ang = Math.atan2(p.y-e.y, p.x-e.x);
        if(e.type === 'boss') {
            e.timer++;
            if(e.sub==='shooter' && e.timer % 40 === 0) {
                for(let a=0; a<Math.PI*2; a+=Math.PI/4) projectiles.push({x:e.x+e.w/2, y:e.y+e.h/2, dx:Math.cos(a), dy:Math.sin(a), type:'normal', owner:'enemy'});
            }
            if(e.sub==='assassin' || e.sub==='stalker') { e.x += Math.cos(ang)*3.5; e.y += Math.sin(ang)*3.5; }
            ctx.fillStyle="#222"; ctx.fillRect(e.x, e.y-25, e.w, 12);
            ctx.fillStyle="#f1c40f"; ctx.fillRect(e.x, e.y-25, (e.hp/e.maxHp)*e.w, 12);
        } else {
            let spd = e.type === 'kamikaze' ? 3.8 : 2.8;
            e.x += Math.cos(ang)*spd; e.y += Math.sin(ang)*spd;
        }

        ctx.fillStyle = e.hit > 0 ? "#fff" : (e.type==='boss'?"#444":e.type==='kamikaze'?"#f1c40f":"#3498db");
        if(e.hit>0) e.hit--; ctx.fillRect(e.x, e.y, e.w, e.h);

        if(e.hp <= 0) {
            spawnParticles(e.x+e.w/2, e.y+e.h/2, ctx.fillStyle, 15);
            if(e.type==='boss') showCards();
            enemies.splice(i,1);
        }
        if(p.iframe <= 0 && Math.hypot(p.x-e.x, p.y-e.y) < 40) {
            Game.lives -= (e.type==='kamikaze' ? 2 : 1); p.iframe = 60;
            if(e.type==='kamikaze') { spawnParticles(e.x, e.y, "#f1c40f", 20); enemies.splice(i,1); }
        }
    });

    // Projéteis
    projectiles.forEach((pr, i) => {
        pr.x += pr.dx*10; pr.y += pr.dy*10;
        ctx.fillStyle = Weapons[pr.type].color; ctx.fillRect(pr.x, pr.y, 10, 10);
        if(pr.owner==='player') {
            enemies.forEach(e => {
                if(pr.x > e.x && pr.x < e.x+e.w && pr.y > e.y && pr.y < e.y+e.h) {
                    e.hp -= Weapons[pr.type].dmg * Game.dmgMult; e.hit=5; projectiles.splice(i,1);
                }
            });
        } else if(Math.hypot(pr.x-p.x, pr.y-p.y) < 25 && p.iframe <= 0) { Game.lives--; p.iframe=60; projectiles.splice(i,1); }
        if(pr.x<0||pr.x>Game.roomW||pr.y<0||pr.y>Game.roomH) projectiles.splice(i,1);
    });

    // Partículas
    particles.forEach((pt, i) => { pt.x += pt.vx; pt.y += pt.vy; pt.life -= 0.02; ctx.globalAlpha = pt.life; ctx.fillStyle = pt.color; ctx.fillRect(pt.x, pt.y, pt.size, pt.size); if(pt.life <= 0) particles.splice(i,1); });
    ctx.globalAlpha = 1;

    // Portas
    if(enemies.length === 0 && !pedestal) {
        Game.doorPos.open = true;
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(Game.doorPos.x, Game.doorPos.y, (Game.doorPos.side==='left'||Game.doorPos.side==='right'?20:120), (Game.doorPos.side==='top'||Game.doorPos.side==='bottom'?20:120));
        if(Math.hypot(p.x-Game.doorPos.x, p.y-Game.doorPos.y) < 80) { Game.isHealRoom = false; Game.room++; initRoom(); }
        
        if(Game.room > 0 && Game.room % 10 === 0) {
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(Game.healDoor.x, Game.healDoor.y, 20, 120);
            if(Math.hypot(p.x-Game.healDoor.x, p.y-Game.healDoor.y) < 80) { Game.isHealRoom = true; initRoom(); }
        }
    }

    if(pedestal) {
        ctx.fillStyle = pedestal.type==='heart'?"#ff4d6d" : pedestal.type==='fire'?"#ff4500":"#32cd32";
        ctx.fillRect(pedestal.x-20, pedestal.y-20, 40, 40);
        if(Math.hypot(p.x-pedestal.x, p.y-pedestal.y) < 60) {
            if(pedestal.type==='heart') Game.lives = Game.maxLives;
            else if(pedestal.type==='fire') Game.hasFire = true;
            else Game.hasAcid = true;
            pedestal = null; playSfx(600, 'sine', 0.3);
        }
    }

    ctx.restore();
    
    // UI HUD
    for(let i=0; i<Game.maxLives; i++) {
        ctx.fillStyle = i < Game.lives ? "#ff4d6d" : "#222";
        ctx.beginPath(); ctx.arc(40 + i*35, 40, 12, 0, Math.PI*2); ctx.fill();
    }
    ctx.fillStyle="#fff"; ctx.font="bold 16px Arial"; ctx.fillText(`${Weapons[Game.weapon].name}: ${Game.ammo}/${Game.maxAmmo}`, 30, 80);
    drawMiniMap();

    if(Game.lives <= 0 && !p.dead) { p.dead = true; document.getElementById('death-screen').style.display='flex'; playSfx(100, 'sawtooth', 1.0); }
    requestAnimationFrame(loop);
}

// Mobile Handlers Corrigidos
const jb = document.getElementById('joy-bound'), js = document.getElementById('joy-stick');
jb.ontouchstart = (e) => { joy.active = true; const r = jb.getBoundingClientRect(); joy.startX = r.left + r.width/2; joy.startY = r.top + r.height/2; };
jb.ontouchmove = (e) => {
    if(!joy.active) return;
    const t = e.touches[0]; let dx = t.clientX - joy.startX, dy = t.clientY - joy.startY;
    const d = Math.min(Math.hypot(dx, dy), 50); const a = Math.atan2(dy, dx);
    joy.x = (Math.cos(a)*d)/50; joy.y = (Math.sin(a)*d)/50;
    js.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
};
jb.ontouchend = () => { joy.active = false; joy.x = joy.y = 0; js.style.transform = `translate(0,0)`; };

document.querySelectorAll('.atk-btn').forEach(b => {
    b.ontouchstart = (e) => { e.preventDefault(); attackDir[b.dataset.dir] = true; };
    b.ontouchend = (e) => { e.preventDefault(); attackDir[b.dataset.dir] = false; };
});

document.getElementById('swap-btn').ontouchstart = (e) => { e.preventDefault(); cycleWeapon(); };

window.addEventListener('keydown', e => { keys.add(e.key.toLowerCase()); if(e.key==='q') cycleWeapon(); });
window.addEventListener('keyup', e => keys.delete(e.key.toLowerCase()));
document.getElementById('btn-start').onclick = () => { audioCtx = new AudioContext(); Game.started = true; document.getElementById('start-screen').style.display='none'; document.getElementById('mobile-ui').style.display='block'; initRoom(); loop(); };
function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }; window.onresize();
</script>
</body>
</html>
