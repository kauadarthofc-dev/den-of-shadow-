<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow 3D ðŸ’€ V4.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&family=Special+Elite&display=swap');
        
        * { touch-action: none; user-select: none; box-sizing: border-box; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; width: 100vw; height: 100vh; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: auto; }

        /* Interface Inicial */
        .ui-screen { position: absolute; inset: 0; background: radial-gradient(circle at center, #220000 0%, #000000 100%); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #start-screen h1 { font-family: 'Nosifer'; color: #ff0000; font-size: clamp(30px, 8vw, 60px); text-shadow: 0 0 20px #000; margin-bottom: 10px; }
        
        .social-box { margin-bottom: 30px; }
        .social-box a { color: #888; text-decoration: none; font-size: 12px; margin: 0 10px; border: 1px solid #444; padding: 5px 10px; transition: 0.3s; }
        .social-box a:hover { color: #f00; border-color: #f00; box-shadow: 0 0 10px #f00; }

        .btn-main { padding: 15px 50px; font-size: 18px; background: #000; border: 2px solid #f00; color: #fff; cursor: pointer; font-family: 'Orbitron'; letter-spacing: 2px; }
        .btn-main:hover { background: #f00; color: #000; box-shadow: 0 0 30px #f00; }

        /* Tela de Morte */
        #death-screen { display: none; background: rgba(0,0,0,0.95); z-index: 5000; backdrop-filter: blur(10px); }
        .death-msg { color: #f00; font-family: 'Nosifer'; font-size: 45px; animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: translate(0,0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(2px, -2px); } 100% { transform: translate(0,0); } }

        /* HUD */
        #hud { position: absolute; top: 20px; left: 20px; z-index: 1000; display: none; pointer-events: none; }
        .hud-group { margin-bottom: 10px; }
        .bar-bg { width: 200px; height: 12px; background: rgba(255,255,255,0.1); border: 1px solid #444; }
        #hp-fill { height: 100%; background: linear-gradient(90deg, #800, #f00); width: 100%; transition: 0.3s; }

        /* Controles Mobile (Mantidos) */
        .mobile-ui { position: absolute; inset: 0; display: none; z-index: 2000; pointer-events: none; }
        #joy-container { position: absolute; bottom: 40px; left: 40px; width: 130px; height: 130px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 40px; left: 40px; width: 50px; height: 50px; background: #f00; border-radius: 50%; opacity: 0.4; }
        #btn-shoot-mobile { position: absolute; bottom: 40px; right: 40px; width: 90px; height: 90px; background: rgba(255,0,0,0.2); border: 2px solid #f00; border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: auto; }

        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #f00; font-size: 24px; pointer-events: none; z-index: 1500; font-weight: 100; }
        #blood-vignette { position: absolute; inset: 0; background: radial-gradient(circle, transparent 40%, rgba(150,0,0,0.4) 100%); pointer-events: none; display: none; }
    </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
    <h1>DEN OF SHADOW</h1>
    <div class="social-box">
        <a href="mailto:kauadarth@gmail.com">kauadarth@gmail.com</a>
        <a href="https://youtube.com/@kaua_darth" target="_blank">YouTube @kaua_darth</a>
    </div>
    <button class="btn-main" onclick="requestStart()">ACEITAR O FARDO</button>
</div>

<div id="death-screen" class="ui-screen">
    <div class="death-msg">VOCÃŠ FOI CONSUMIDO</div>
    <p style="font-family:'Special Elite'; margin: 20px;">A sombra nÃ£o perdoa hesitaÃ§Ã£o.</p>
    <button class="btn-main" onclick="location.reload()">REENCARNAR</button>
</div>

<div id="blood-vignette"></div>

<div id="hud">
    <div class="hud-group">
        <div>VITALIDADE</div>
        <div class="bar-bg"><div id="hp-fill"></div></div>
    </div>
    <div style="font-size: 14px; color: #660;">ALMA: <span id="ammo-txt">40</span> | SALA: <span id="room-txt">0</span></div>
</div>

<div id="crosshair">+</div>

<div id="mobile-controls" class="mobile-ui">
    <div id="joy-container"><div id="joy-stick"></div></div>
    <div id="btn-shoot-mobile">FOGO</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- CONSTANTES ---
const TILE_SIZE = 64;
const MAP_SIZE = 16;
let map = [];
let bullets = [];
let enemies = [];
let items = [];

const G = {
    play: false, room: 0, hp: 100, maxHp: 100, ammo: 40,
    lastShot: 0, kadtr: false
};

const player = {
    x: 100, y: 100, angle: 0,
    moveDir: { x: 0, y: 0 },
    fov: Math.PI / 3,
    sensitivity: 0.002
};

// --- INICIALIZAÃ‡ÃƒO ---
function requestStart() {
    // Tenta travar o mouse para PC
    if(!('ontouchstart' in window)) {
        canvas.requestPointerLock = canvas.requestPointerLock || canvas.mozRequestPointerLock;
        canvas.requestPointerLock();
    }
    initGame();
}

function initGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    if('ontouchstart' in window) document.getElementById('mobile-controls').style.display = 'block';
    G.play = true;
    generateMap();
    spawnEnemies();
    loop();
}

function generateMap() {
    map = Array(MAP_SIZE * MAP_SIZE).fill(0);
    for(let i=0; i<MAP_SIZE; i++) {
        map[i] = 1; map[i + (MAP_SIZE*(MAP_SIZE-1))] = 1;
        map[i * MAP_SIZE] = 1; map[i * MAP_SIZE + (MAP_SIZE-1)] = 1;
    }
    map[Math.floor(MAP_SIZE/2)] = 2; // SaÃ­da
}

function spawnEnemies() {
    enemies = [];
    let n = 4 + Math.floor(G.room * 0.5);
    for(let i=0; i<n; i++) {
        enemies.push({
            x: (3 + Math.random() * 10) * TILE_SIZE,
            y: (3 + Math.random() * 10) * TILE_SIZE,
            hp: 60 + (G.room * 10),
            alive: true
        });
    }
}

// --- COMANDOS MOUSE (PC) ---
document.addEventListener('mousemove', e => {
    if(document.pointerLockElement === canvas) {
        player.angle += e.movementX * player.sensitivity;
    }
});

document.addEventListener('mousedown', e => {
    if(G.play && document.pointerLockElement === canvas) {
        if(e.button === 0) shoot(); // Esquerdo
        if(e.button === 2) interact(); // Direito
    }
});
window.addEventListener('contextmenu', e => e.preventDefault());

// --- COMANDOS TECLADO ---
const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => delete keys[e.key.toLowerCase()];

// --- MOBILE INPUTS (IDENTIFICADOS POR ID) ---
let moveTouchId = null;
const joyContainer = document.getElementById('joy-container');
const joyStick = document.getElementById('joy-stick');

joyContainer.addEventListener('touchstart', e => {
    moveTouchId = e.changedTouches[0].identifier;
});

window.addEventListener('touchmove', e => {
    if(moveTouchId !== null) {
        for(let t of e.changedTouches) {
            if(t.identifier === moveTouchId) {
                const rect = joyContainer.getBoundingClientRect();
                const dx = t.clientX - (rect.left + rect.width/2);
                const dy = t.clientY - (rect.top + rect.height/2);
                const dist = Math.min(45, Math.hypot(dx, dy));
                const ang = Math.atan2(dy, dx);
                joyStick.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
                player.moveDir.x = Math.cos(ang) * (dist/45);
                player.moveDir.y = Math.sin(ang) * (dist/45);
            }
        }
    }
});

window.addEventListener('touchend', e => {
    for(let t of e.changedTouches) {
        if(t.identifier === moveTouchId) {
            moveTouchId = null;
            player.moveDir = { x: 0, y: 0 };
            joyStick.style.transform = `translate(0,0)`;
        }
    }
});

document.getElementById('btn-shoot-mobile').addEventListener('touchstart', e => {
    e.preventDefault();
    shoot();
});

// --- LÃ“GICA DE JOGO ---
function shoot() {
    if(G.ammo <= 0 || Date.now() - G.lastShot < 200) return;
    G.ammo--;
    G.lastShot = Date.now();
    bullets.push({
        x: player.x, y: player.y,
        vx: Math.cos(player.angle) * 15, vy: Math.sin(player.angle) * 15,
        life: 100
    });
}

function interact() {
    // Verifica se estÃ¡ perto da porta (Tile 2)
    let tx = Math.floor((player.x + Math.cos(player.angle) * 50) / TILE_SIZE);
    let ty = Math.floor((player.y + Math.sin(player.angle) * 50) / TILE_SIZE);
    if(map[ty * MAP_SIZE + tx] === 2) {
        if(enemies.filter(e => e.alive).length === 0) {
            G.room++;
            player.x = 100; player.y = 100;
            spawnEnemies();
        }
    }
}

function update() {
    if(!G.play) return;

    let mvX = 0, mvY = 0;
    // Teclado W A S D
    if(keys['w']) { mvX += Math.cos(player.angle); mvY += Math.sin(player.angle); }
    if(keys['s']) { mvX -= Math.cos(player.angle); mvY -= Math.sin(player.angle); }
    if(keys['a']) { mvX += Math.cos(player.angle - Math.PI/2); mvY += Math.sin(player.angle - Math.PI/2); }
    if(keys['d']) { mvX += Math.cos(player.angle + Math.PI/2); mvY += Math.sin(player.angle + Math.PI/2); }

    // Joystick Mobile
    mvX += (Math.cos(player.angle) * -player.moveDir.y + Math.cos(player.angle + Math.PI/2) * player.moveDir.x);
    mvY += (Math.sin(player.angle) * -player.moveDir.y + Math.sin(player.angle + Math.PI/2) * player.moveDir.x);

    let nX = player.x + mvX * 4;
    let nY = player.y + mvY * 4;

    const checkWall = (x, y) => map[Math.floor(y/TILE_SIZE)*MAP_SIZE + Math.floor(x/TILE_SIZE)];
    if(checkWall(nX, nY) === 0) { player.x = nX; player.y = nY; }

    // Balas e Inimigos
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy; b.life--;
        if(checkWall(b.x, b.y) > 0 || b.life <= 0) bullets.splice(i,1);
        enemies.forEach(en => {
            if(en.alive && Math.hypot(b.x-en.x, b.y-en.y) < 30) {
                en.hp -= 40; bullets.splice(i,1);
                if(en.hp <= 0) en.alive = false;
            }
        });
    });

    enemies.forEach(en => {
        if(!en.alive) return;
        let d = Math.hypot(player.x-en.x, player.y-en.y);
        if(d < 40) {
            G.hp -= 0.5;
            document.getElementById('blood-vignette').style.display = 'block';
            setTimeout(() => document.getElementById('blood-vignette').style.display = 'none', 100);
        } else {
            en.x += (player.x-en.x)/d * 1.5; en.y += (player.y-en.y)/d * 1.5;
        }
    });

    if(G.hp <= 0) { G.play = false; document.getElementById('death-screen').style.display = 'flex'; document.exitPointerLock(); }
    if(G.ammo < 40) G.ammo += 0.03;
}

function draw() {
    // Visibilidade Aumentada (Cores menos saturadas de preto)
    ctx.fillStyle = "#110000"; ctx.fillRect(0,0,canvas.width, canvas.height/2); // Teto
    ctx.fillStyle = "#221111"; ctx.fillRect(0,canvas.height/2, canvas.width, canvas.height/2); // ChÃ£o

    const rays = canvas.width / 2;
    const step = player.fov / rays;

    for(let i=0; i<rays; i++) {
        let ang = (player.angle - player.fov/2) + (i * step);
        let dist = 0, hit = false;
        let cos = Math.cos(ang), sin = Math.sin(ang);

        while(!hit && dist < 1000) {
            dist += 4;
            let tx = Math.floor((player.x + cos*dist)/TILE_SIZE);
            let ty = Math.floor((player.y + sin*dist)/TILE_SIZE);
            if(map[ty * MAP_SIZE + tx] > 0) {
                hit = true;
                let wallH = (TILE_SIZE * canvas.height) / (dist * Math.cos(player.angle - ang));
                let color = (map[ty*MAP_SIZE+tx] === 2) ? 255 : 140;
                let lum = Math.max(30, color - (dist/6)); // Luz viaja mais longe
                ctx.fillStyle = `rgb(${lum}, ${lum*0.2}, ${lum*0.2})`;
                ctx.fillRect(i*2, (canvas.height-wallH)/2, 2, wallH);
            }
        }
    }

    // Inimigos (Sprites Sombrios)
    enemies.forEach(en => {
        if(!en.alive) return;
        let ang = Math.atan2(en.y - player.y, en.x - player.x) - player.angle;
        while(ang < -Math.PI) ang += Math.PI*2;
        while(ang > Math.PI) ang -= Math.PI*2;
        if(Math.abs(ang) < player.fov) {
            let d = Math.hypot(player.x - en.x, player.y - en.y);
            let sx = (0.5 * (ang / (player.fov/2)) + 0.5) * canvas.width;
            let sh = (TILE_SIZE * canvas.height) / d;
            ctx.fillStyle = "black";
            ctx.shadowBlur = 15; ctx.shadowColor = "red";
            ctx.fillRect(sx - sh/4, (canvas.height-sh)/2, sh/2, sh);
            ctx.shadowBlur = 0;
        }
    });

    document.getElementById('hp-fill').style.width = G.hp + "%";
    document.getElementById('ammo-txt').innerText = Math.floor(G.ammo);
    document.getElementById('room-txt').innerText = G.room;
}

function loop() {
    if(G.play) { update(); draw(); }
    requestAnimationFrame(loop);
}

window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize();
</script>
</body>
</html>
