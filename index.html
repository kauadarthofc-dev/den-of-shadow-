<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Fox of Isaac: Den of Shadows</title>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: 'Courier New', monospace; overflow: hidden; height: 100vh; display: flex; flex-direction: row; touch-action: none; user-select: none; }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        .btn-ui { padding: 15px 30px; border: 3px solid #fff; background: none; color: #fff; cursor: pointer; font-size: 18px; margin: 10px; width: 250px; }

        #game-container { position: relative; flex: 1; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { background: #111; image-rendering: pixelated; height: 100%; max-width: 100%; aspect-ratio: 4/3; border-left: 2px solid #333; border-right: 2px solid #333; }

        /* Controles Mobile Horizontais */
        .mobile-ctrl { position: absolute; inset: 0; pointer-events: none; display: none; }
        
        /* Analógico (Esquerda) */
        #joy-bound { position: absolute; bottom: 10%; left: 5%; width: 130px; height: 130px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; left: 40px; top: 40px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.4; }

        /* Botões de Tiro (Direita) */
        #shoot-ctrl { position: absolute; bottom: 10%; right: 5%; display: grid; grid-template-columns: repeat(3, 60px); gap: 10px; pointer-events: auto; }
        .atk-btn { width: 60px; height: 60px; background: rgba(52,152,219,0.1); border: 2px solid #3498db; border-radius: 50%; color: #3498db; display: flex; justify-content: center; align-items: center; font-size: 20px; }
    </style>
</head>
<body>

<div id="start-screen" class="overlay">
    <h1 style="color:#ff4d6d">COVIL DAS SOMBRAS</h1>
    <p style="color:#666">Vire o celular para o modo HORIZONTAL</p>
    <button class="btn-ui" onclick="startGame()">INICIAR JOGO</button>
</div>

<div id="upgrade-screen" class="overlay" style="display:none">
    <h1 style="color:#f1c40f">UPGRADE DISPONÍVEL</h1>
    <div id="upgrade-container"></div>
</div>

<div id="death-screen" class="overlay" style="display:none;">
    <h1>GAME OVER</h1>
    <button class="btn-ui" onclick="location.reload()">TENTAR NOVAMENTE</button>
</div>

<div id="game-container">
    <canvas id="game"></canvas>
    
    <div id="mobile-ui" class="mobile-ctrl">
        <div id="joy-bound"><div id="joy-stick"></div></div>
        <div id="shoot-ctrl">
            <div></div><div class="atk-btn" id="fUp">▲</div><div></div>
            <div class="atk-btn" id="fLf">◀</div><div class="atk-btn" id="fDw">▼</div><div class="atk-btn" id="fRt">▶</div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = 400; canvas.height = 300;

const Game = { started: false, lives: 6, maxLives: 6, room: 0, active: true, cleared: true, roomW: 800, roomH: 600, camX: 0, camY: 0, paused: false };
const Stats = { atkSpeed: 15, multiShot: false, moveSpeed: 4 };
const input = { x: 0, y: 0 };
const attack = { up: false, down: false, left: false, right: false };

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    if(/Android|iPhone|iPad/i.test(navigator.userAgent)) {
        document.getElementById('mobile-ui').style.display = 'block';
    }
    Game.started = true;
    initRoom();
    loop();
}

// LÓGICA DO JOYSTICK
const jBound = document.getElementById('joy-bound');
const jStick = document.getElementById('joy-stick');
let jActive = false;

jBound.addEventListener('touchstart', (e) => { jActive = true; updateJoy(e); });
window.addEventListener('touchmove', (e) => { if(jActive) updateJoy(e); }, {passive: false});
window.addEventListener('touchend', () => { jActive = false; input.x = 0; input.y = 0; jStick.style.left = '40px'; jStick.style.top = '40px'; });

function updateJoy(e) {
    if(!jActive) return;
    const t = e.touches[0];
    const r = jBound.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    const dx = t.clientX - cx;
    const dy = t.clientY - cy;
    const dist = Math.min(60, Math.hypot(dx, dy));
    const ang = Math.atan2(dy, dx);
    input.x = (Math.cos(ang) * dist) / 60;
    input.y = (Math.sin(ang) * dist) / 60;
    jStick.style.left = (40 + Math.cos(ang) * dist/1.2) + 'px';
    jStick.style.top = (40 + Math.sin(ang) * dist/1.2) + 'px';
}

// TECLADO PC
window.onkeydown = (e) => {
    let k = e.key.toLowerCase();
    if(k=='w') input.y = -1; if(k=='s') input.y = 1; if(k=='a') input.x = -1; if(k=='d') input.x = 1;
    if(k=='i') attack.up=true; if(k=='k') attack.down=true; if(k=='j') attack.left=true; if(k=='l') attack.right=true;
};
window.onkeyup = (e) => {
    let k = e.key.toLowerCase();
    if(k=='w'||k=='s') input.y = 0; if(k=='a'||k=='d') input.x = 0;
    if(k=='i') attack.up=false; if(k=='k') attack.down=false; if(k=='j') attack.left=false; if(k=='l') attack.right=false;
};

// TIRO MOBILE
const bAtk = (id, k) => {
    const el = document.getElementById(id);
    el.ontouchstart = (e) => { e.preventDefault(); attack[k] = true; };
    el.ontouchend = (e) => { e.preventDefault(); attack[k] = false; };
};
bAtk('fUp', 'up'); bAtk('fDw', 'down'); bAtk('fLf', 'left'); bAtk('fRt', 'right');

class Projectile {
    constructor(x, y, dx, dy, enemy=false) { this.x = x; this.y = y; this.dx = dx; this.dy = dy; this.enemy = enemy; this.active = true; }
    update() {
        this.x += this.dx * (this.enemy ? 3 : 6);
        this.y += this.dy * (this.enemy ? 3 : 6);
        if(this.x < 0 || this.x > Game.roomW || this.y < 0 || this.y > Game.roomH) this.active = false;
    }
    draw() { ctx.fillStyle = this.enemy ? "#f0f" : "#0ff"; ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill(); }
}

class Player {
    constructor() { this.x = 400; this.y = 300; this.iframe = 0; this.atkTicks = 0; }
    update() {
        this.x += input.x * Stats.moveSpeed;
        this.y += input.y * Stats.moveSpeed;
        this.x = Math.max(40, Math.min(this.x, Game.roomW-60));
        this.y = Math.max(40, Math.min(this.y, Game.roomH-60));
        if(this.atkTicks <= 0) {
            let dx=0, dy=0;
            if(attack.up) dy=-1; else if(attack.down) dy=1; else if(attack.left) dx=-1; else if(attack.right) dx=1;
            if(dx||dy) {
                projectiles.push(new Projectile(this.x+10, this.y+10, dx, dy));
                if(Stats.multiShot) {
                    let a = Math.atan2(dy, dx);
                    projectiles.push(new Projectile(this.x+10, this.y+10, Math.cos(a+0.2), Math.sin(a+0.2)));
                }
                this.atkTicks = Stats.atkSpeed;
            }
        }
        if(this.atkTicks > 0) this.atkTicks--;
        if(this.iframe > 0) this.iframe--;
    }
    draw() { ctx.fillStyle = (this.iframe > 0 && Math.floor(Date.now()/100)%2) ? "#fff" : "#e67e22"; ctx.fillRect(this.x, this.y, 20, 20); }
}

class Enemy {
    constructor(boss=false) {
        this.boss = boss; this.size = boss ? 60 : 24; this.hp = boss ? 200 : 20; this.alive = true;
        this.x = Math.random()*600+100; this.y = Math.random()*400+100;
        this.vx = (Math.random()-0.5)*3; this.vy = (Math.random()-0.5)*3;
        this.shootTicks = 60;
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if(this.x < 40 || this.x > Game.roomW-40-this.size) this.vx *= -1;
        if(this.y < 40 || this.y > Game.roomH-40-this.size) this.vy *= -1;
        if(--this.shootTicks <= 0) {
            let a = Math.atan2(p.y - this.y, p.x - this.x);
            projectiles.push(new Projectile(this.x+this.size/2, this.y+this.size/2, Math.cos(a), Math.sin(a), true));
            this.shootTicks = this.boss ? 45 : 100;
        }
    }
    draw() { ctx.fillStyle = this.boss ? "#8e44ad" : "#ff4757"; ctx.fillRect(this.x, this.y, this.size, this.size); }
}

let p = new Player();
let enemies = [], projectiles = [];

function initRoom() {
    projectiles = []; enemies = [];
    if(Game.room > 0) {
        Game.cleared = false;
        if(Game.room % 10 === 0) enemies.push(new Enemy(true));
        else {
            let n = 2 + Math.floor(Game.room/4);
            for(let i=0; i<n; i++) enemies.push(new Enemy());
        }
    }
}

function showUpgradeMenu() {
    Game.paused = true;
    const container = document.getElementById('upgrade-container');
    container.innerHTML = '';
    const opts = [
        { t: 'VELOCIDADE TIRO', f: () => Stats.atkSpeed = Math.max(7, Stats.atkSpeed - 3) },
        { t: 'DISPARO DUPLO', f: () => Stats.multiShot = true },
        { t: 'VIDA MÁXIMA', f: () => { Game.maxLives += 2; Game.lives = Game.maxLives; } },
        { t: 'AGILIDADE', f: () => Stats.moveSpeed += 0.8 }
    ];
    opts.sort(() => 0.5 - Math.random()).slice(0, 3).forEach(o => {
        const b = document.createElement('button');
        b.className = 'btn-ui'; b.innerText = o.t;
        b.onclick = () => { o.f(); Game.paused = false; document.getElementById('upgrade-screen').style.display = 'none'; };
        container.appendChild(b);
    });
    document.getElementById('upgrade-screen').style.display = 'flex';
}

function loop() {
    if(!Game.active || !Game.started || Game.paused) { requestAnimationFrame(loop); return; }
    Game.camX += ((p.x - canvas.width/2) - Game.camX) * 0.1;
    Game.camY += ((p.y - canvas.height/2) - Game.camY) * 0.1;
    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(Math.round(-Game.camX), Math.round(-Game.camY));
    // Chão Ladrilhado
    for(let x=0; x<Game.roomW; x+=50) {
        for(let y=0; y<Game.roomH; y+=50) {
            ctx.fillStyle = (x+y)/50 % 2 == 0 ? "#111" : "#161616";
            ctx.fillRect(x,y,50,50);
        }
    }
    ctx.strokeStyle = "#333"; ctx.lineWidth = 40; ctx.strokeRect(0,0, Game.roomW, Game.roomH);
    if(Game.cleared) {
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(Game.roomW/2-30, 0, 60, 20);
        if(p.y < 45 && Math.abs(p.x - Game.roomW/2) < 40) {
            if(Game.room > 0 && Game.room % 10 === 0) showUpgradeMenu();
            Game.room++; initRoom(); p.y = Game.roomH - 80;
        }
    }
    p.update(); p.draw();
    projectiles.forEach((proj, i) => {
        proj.update(); proj.draw();
        if(!proj.enemy) {
            enemies.forEach(e => {
                if(e.alive && Math.hypot(proj.x-(e.x+e.size/2), proj.y-(e.y+e.size/2)) < e.size/1.5) {
                    e.hp -= 10; proj.active = false;
                    if(e.hp <= 0) e.alive = false;
                }
            });
        } else if(p.iframe <= 0 && Math.hypot(proj.x-(p.x+10), proj.y-(p.y+10)) < 12) {
            Game.lives--; p.iframe = 60; proj.active = false;
        }
        if(!proj.active) projectiles.splice(i, 1);
    });
    enemies.forEach(e => { if(e.alive) { e.update(); e.draw(); if(p.iframe <= 0 && Math.hypot(p.x-e.x, p.y-e.y) < 20) { Game.lives--; p.iframe = 60; } } });
    if(enemies.filter(e => e.alive).length === 0) Game.cleared = true;
    if(Game.lives <= 0) { Game.active = false; document.getElementById('death-screen').style.display='flex'; }
    ctx.restore();
    
    // HUD fixa
    ctx.fillStyle = "#fff"; ctx.font = "bold 12px Courier New";
    ctx.fillText(Game.room === 0 ? "SALA SEGURA" : "SALA " + Game.room, 10, 20);
    for(let i=0; i<Game.lives; i++) { ctx.fillStyle = "#ff4d6d"; ctx.fillRect(10 + (i*10), 28, 7, 7); }
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
