<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow ðŸ’€</title>
    <style>
        :root {
            --c-comum: #3498db; --c-incomum: #2ecc71; --c-raro: #f1c40f; 
            --c-epico: #9b59b6; --c-lendario: linear-gradient(45deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
        }
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #0a0a12; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        canvas { display: block; image-rendering: pixelated; }

        /* UI Screens */
        .ui-screen { position: absolute; inset: 0; background: rgba(5, 5, 15, 0.98); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .title-box { border: 4px solid #fff; padding: 20px; border-radius: 15px; background: rgba(231, 76, 60, 0.1); margin-bottom: 20px; }
        .title-text { font-size: clamp(30px, 8vw, 60px); color: #e74c3c; margin: 0; text-transform: uppercase; letter-spacing: 5px; }
        .btn-main { padding: 15px 50px; background: #2ecc71; border: none; color: white; font-size: 22px; font-weight: bold; border-radius: 50px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px #1c8d4c; }
        .btn-main:active { transform: translateY(3px); box-shadow: none; }

        /* HUD Compacta */
        #hud-top { position: absolute; top: 15px; left: 15px; pointer-events: none; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .hp-bar-container { width: 200px; height: 18px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 10px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: #ff4d6d; transition: 0.3s; }
        .stats-text { font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px #000; }

        /* Minimapa Reduzido */
        #minimap-container { position: absolute; top: 15px; right: 15px; width: 120px; height: 120px; background: rgba(0,0,0,0.7); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden; }

        /* Mobile Controls - Reajustado */
        #mobile-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; width: 50px; height: 50px; background: #fff; border-radius: 50%; left: 35px; top: 35px; }
        #atk-grid { position: absolute; bottom: 40px; right: 40px; display: grid; grid-template-columns: repeat(3, 75px); gap: 10px; pointer-events: auto; }
        .btn-atk { width: 75px; height: 75px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; color: white; }
        
        /* NOVO LUGAR DO SWAP: Centro Baixo */
        #swap-mob { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 120px; height: 50px; background: #f1c40f; border: 2px solid #fff; border-radius: 25px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; font-size: 16px; box-shadow: 0 4px #9e820a; }

        #weapon-tag { position: absolute; bottom: 200px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); border: 2px solid #f1c40f; padding: 12px; border-radius: 10px; display: none; z-index: 500; text-align: center; font-size: 13px; color: white; width: 220px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="hud-top">
    <div class="hp-bar-container"><div id="hp-fill"></div></div>
    <div class="stats-text">ðŸ’€ <span id="room-count">0</span> | ðŸ’° <span id="coin-count">0</span></div>
    <div id="ammo-hud" style="color: #00eaff; font-size: 18px;">Magnum: --/--</div>
</div>

<div id="minimap-container">
    <canvas id="minimapCanvas" width="120" height="120"></canvas>
</div>

<div id="start-screen" class="ui-screen">
    <div class="title-box">
        <h1 class="title-text">Den of Shadow ðŸ’€</h1>
    </div>
    <div id="plat-info" style="color:#2ecc71; margin-bottom: 20px; font-weight: bold;"></div>
    <button class="btn-main" id="btn-play">INICIAR JORNADA</button>
    <div style="margin-top: 40px; font-size: 14px; opacity: 0.7;">
        kauadarthofc@gmail.com | @kaua_darth
    </div>
</div>

<div id="upgrade-screen" class="ui-screen" style="display:none;">
    <h2 style="color:#f1c40f; margin-bottom:30px;">ESCOLHA SEU PODER</h2>
    <div id="cards-container" style="display:flex; gap:20px;"></div>
</div>

<div id="weapon-tag"></div>
<canvas id="gameCanvas"></canvas>

<div id="mobile-hud">
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="atk-grid">
        <div></div><div class="btn-atk" data-dir="up">â–²</div><div></div>
        <div class="btn-atk" data-dir="left">â—€</div><div class="btn-atk" data-dir="down">â–¼</div><div class="btn-atk" data-dir="right">â–¶</div>
    </div>
    <div id="swap-mob">SWAP ðŸ”„</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mCanvas = document.getElementById('minimapCanvas');
const mCtx = mCanvas.getContext('2d');
const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);

// --- CONFIGURAÃ‡ÃƒO GLOBAL ---
const G = {
    play: false, room: 0, w: 2400, h: 1800,
    hp: 12, maxHp: 12, coins: 0,
    weapon: 'magnum',
    inv: {
        magnum: { a: 20, m: 20, d: 15, c: "#00eaff", n: "Magnum", cd: 15, info: "Pistola de Energia\nDano: 15 | EstÃ¡vel" },
        fire: { a: 40, m: 40, d: 4, c: "#ff6a00", n: "LanÃ§a-Chamas", cd: 2, info: "Baforada de Fogo\nDano: 4 + Queimadura" },
        shotgun: { a: 8, m: 8, d: 10, c: "#f1c40f", n: "Shotgun", cd: 50, info: "Disparo Triplo\nDano: 10x3 | Curto Alcance" },
        staff: { a: 15, m: 15, d: 7, c: "#9b59b6", n: "Cajado MÃ­stico", cd: 25, info: "ProjÃ©til Teleguiado\nDano: 7 | Busca Inimigos" }
    },
    owned: ['magnum'],
    upgrades: { triple: 0, ric: 0, vamp: 0, dual: false }
};

let p = { x: 1200, y: 900, r: 35, rot: 0, spd: 8, iframe: 0, t: 0, leg: 0 };
let enemies = [], projectiles = [], drops = [], pedestals = [], warns = [], particles = [];
const keys = new Set();
const mobAtk = { up: false, down: false, left: false, right: false };
const joy = { active: false, x: 0, y: 0, sx: 0, sy: 0 };

// --- MOTOR DE JOGO ---
function spawnRoom() {
    enemies = []; projectiles = []; drops = []; pedestals = []; warns = [];
    p.x = G.w/2; p.y = G.h/2;
    
    if(G.room === 0) return; // Sala Inicial

    // LÃ³gica de Spawn
    if(G.room % 10 === 0) {
        enemies.push({ type:'boss', x:G.w/2, y:400, hp:2000+G.room*100, max:2000+G.room*100, r:120, t:0, name: "LORD SHADOW" });
    } else {
        let count = 6 + Math.floor(G.room/2);
        for(let i=0; i<count; i++) {
            let ex, ey;
            do { ex = 200+Math.random()*(G.w-400); ey = 200+Math.random()*(G.h-400); } while(Math.hypot(ex-p.x, ey-p.y)<600);
            enemies.push({ type: Math.random()<0.2?'kamikaze':'stalker', x:ex, y:ey, r:40, hp:80+G.room*15, hit:0 });
        }
    }

    // Pedestais de Armas
    if(G.room === 5 && !G.owned.includes('fire')) pedestals.push({x:G.w/2, y:300, type:'fire'});
    if(G.room === 12 && !G.owned.includes('shotgun')) pedestals.push({x:G.w/2, y:300, type:'shotgun'});
}

function update() {
    if(!G.play) return;

    // Movimento Player
    let mx = joy.active ? joy.x : (keys.has('a')?-1:keys.has('d')?1:0);
    let my = joy.active ? joy.y : (keys.has('w')?-1:keys.has('s')?1:0);
    p.x = Math.max(80, Math.min(G.w-80, p.x + mx * p.spd));
    p.y = Math.max(80, Math.min(G.h-80, p.y + my * p.spd));

    // RotaÃ§Ã£o e Tiro
    let ax = (keys.has('arrowleft')?-1:keys.has('arrowright')?1:0);
    let ay = (keys.has('arrowup')?-1:keys.has('arrowdown')?1:0);
    if(isMobile) { if(mobAtk.up) ay=-1; if(mobAtk.down) ay=1; if(mobAtk.left) ax=-1; if(mobAtk.right) ax=1; }

    if(ax || ay) {
        p.rot = Math.atan2(ay, ax);
        if(p.t % G.inv[G.weapon].cd === 0 && G.inv[G.weapon].a > 0) shoot(ax, ay);
    } else if(mx || my) {
        p.rot = Math.atan2(my, mx);
        p.leg += 0.2;
    }

    // Inimigos e Boss (Com travas de mapa)
    enemies.forEach((e, i) => {
        let dist = Math.hypot(p.x-e.x, p.y-e.y);
        let ang = Math.atan2(p.y-e.y, p.x-e.x);

        if(e.type === 'boss') {
            e.t++;
            e.x = Math.max(e.r+100, Math.min(G.w-e.r-100, e.x + Math.cos(e.t/40)*4));
            e.y = Math.max(e.r+100, Math.min(G.h-e.r-100, e.y + Math.sin(e.t/60)*2));
            if(e.t % 120 === 0) warns.push({x: p.x, y: p.y, t: 80});
        } else {
            e.x += Math.cos(ang) * 2.5; e.y += Math.sin(ang) * 2.5;
            // Trava de borda para inimigos comuns
            e.x = Math.max(e.r, Math.min(G.w-e.r, e.x));
            e.y = Math.max(e.r, Math.min(G.h-e.r, e.y));
        }

        if(dist < p.r + e.r && p.iframe <= 0) {
            G.hp -= (e.type==='kamikaze'?2:1);
            p.iframe = 60;
            if(e.type==='kamikaze') e.hp = 0;
        }

        if(e.hp <= 0) {
            if(e.type==='boss') showUpgrades();
            if(Math.random()<0.15) drops.push({x:e.x, y:e.y, type:'heal'});
            enemies.splice(i, 1);
        }
    });

    // ProjÃ©teis
    projectiles.forEach((pr, i) => {
        pr.x += pr.dx; pr.y += pr.dy; pr.life--;
        enemies.forEach(e => {
            if(Math.hypot(pr.x-e.x, pr.y-e.y) < e.r + 10) {
                e.hp -= pr.dmg;
                projectiles.splice(i, 1);
            }
        });
        if(pr.life <= 0) projectiles.splice(i, 1);
    });

    // DetecÃ§Ã£o de Pedestais
    let pedInfo = "";
    pedestals.forEach((ped, i) => {
        let d = Math.hypot(p.x-ped.x, p.y-ped.y);
        if(d < 150) pedInfo = `<b>${G.inv[ped.type].n}</b><br>${G.inv[ped.type].info.replace('\n', '<br>')}`;
        if(d < 60) { G.owned.push(ped.type); pedestals.splice(i, 1); }
    });
    const tag = document.getElementById('weapon-tag');
    tag.innerHTML = pedInfo; tag.style.display = pedInfo ? 'block' : 'none';

    // Itens
    drops.forEach((d, i) => {
        if(Math.hypot(p.x-d.x, p.y-d.y) < 60) {
            if(d.type==='heal') G.hp = Math.min(G.maxHp, G.hp+2);
            drops.splice(i, 1);
        }
    });

    // Porta PrÃ³xima Sala
    if(enemies.length === 0 && Math.hypot(p.x-G.w/2, p.y-50) < 100) {
        G.room++; spawnRoom();
    }

    if(p.iframe > 0) p.iframe--;
    p.t++;
    updateUI();
}

function shoot(ax, ay) {
    let w = G.inv[G.weapon];
    w.a--;
    let ang = Math.atan2(ay, ax);
    if(G.weapon === 'shotgun') {
        for(let j=-1; j<=1; j++) projectiles.push({x:p.x, y:p.y, dx:Math.cos(ang+j*0.2)*20, dy:Math.sin(ang+j*0.2)*20, dmg:w.d, life:20});
    } else {
        projectiles.push({x:p.x, y:p.y, dx:Math.cos(ang)*20, dy:Math.sin(ang)*20, dmg:w.d, life:60});
    }
}

function updateUI() {
    document.getElementById('hp-fill').style.width = (G.hp/G.maxHp)*100 + "%";
    document.getElementById('room-count').innerText = G.room;
    document.getElementById('ammo-hud').innerText = `${G.inv[G.weapon].n}: ${G.inv[G.weapon].a}/${G.inv[G.weapon].m}`;
    
    // Minimapa
    mCtx.fillStyle = "rgba(0,0,0,0.5)";
    mCtx.fillRect(0,0,120,120);
    let s = 120/G.w;
    mCtx.fillStyle = "#00eaff"; mCtx.fillRect(p.x*s-2, p.y*s-2, 4, 4);
    mCtx.fillStyle = "red"; enemies.forEach(e => mCtx.fillRect(e.x*s-1, e.y*s-1, 3, 3));
    mCtx.fillStyle = "green"; if(enemies.length===0) mCtx.fillRect(G.w/2*s-5, 20*s, 10, 5);
}

function draw() {
    ctx.fillStyle = "#1a1a2e";
    ctx.fillRect(0,0,canvas.width, canvas.height);

    ctx.save();
    let cx = p.x - canvas.width/2;
    let cy = p.y - canvas.height/2;
    ctx.translate(-cx, -cy);

    // ChÃ£o
    ctx.fillStyle = "#16213e";
    ctx.fillRect(0,0,G.w, G.h);
    ctx.strokeStyle = "#0f3460";
    for(let i=0; i<G.w; i+=100) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,G.h); ctx.stroke(); }
    for(let i=0; i<G.h; i+=100) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(G.w,i); ctx.stroke(); }

    // Porta
    if(enemies.length === 0) {
        ctx.fillStyle = "#2ecc71";
        ctx.fillRect(G.w/2-80, 0, 160, 40);
    }

    // Pedestais
    pedestals.forEach(ped => {
        ctx.fillStyle = "#f1c40f";
        ctx.fillRect(ped.x-40, ped.y-40, 80, 80);
    });

    // Inimigos
    enemies.forEach(e => {
        ctx.fillStyle = e.type==='boss'?'#533483':(e.type==='kamikaze'?'#e94560':'#0f3460');
        ctx.fillRect(e.x-e.r, e.y-e.r, e.r*2, e.r*2);
        if(e.type==='boss') {
            // Barra de vida do Boss
            ctx.fillStyle = "red";
            ctx.fillRect(e.x-100, e.y-e.r-20, (e.hp/e.max)*200, 10);
        }
    });

    // Player (Lord da Luz)
    ctx.save();
    ctx.translate(p.x, p.y);
    // Perninhas
    ctx.fillStyle = "#fff";
    let ly = Math.sin(p.leg)*10;
    ctx.fillRect(-15, 25+ly, 10, 15); ctx.fillRect(5, 25-ly, 10, 15);
    // Corpo
    ctx.rotate(p.rot);
    ctx.fillStyle = (p.iframe>0 && p.t%4<2)?"red":"#fff";
    ctx.shadowBlur = 15; ctx.shadowColor = "#00eaff";
    ctx.fillRect(-30, -30, 60, 60);
    // Arma
    ctx.fillStyle = "#333"; ctx.fillRect(20, -5, 30, 10);
    ctx.restore();

    // ProjÃ©teis
    projectiles.forEach(pr => {
        ctx.fillStyle = "#fff";
        ctx.beginPath(); ctx.arc(pr.x, pr.y, 10, 0, 7); ctx.fill();
    });

    ctx.restore();
    if(G.play) { update(); requestAnimationFrame(draw); }
}

// --- UPGRADES ---
function showUpgrades() {
    G.play = false;
    document.getElementById('upgrade-screen').style.display = 'flex';
    const cont = document.getElementById('cards-container');
    cont.innerHTML = '';
    const ups = [
        {n:"TIRO TRIPLO", d:"Sua arma dispara 3 projÃ©teis.", a:()=>G.upgrades.triple++},
        {n:"VAMPIRISMO", d:"Recupera vida ao matar.", a:()=>G.upgrades.vamp++},
        {n:"VELOCIDADE", d:"Corre muito mais rÃ¡pido.", a:()=>p.spd+=3}
    ];
    ups.forEach(u => {
        let d = document.createElement('div');
        d.className = 'btn-main'; d.style.margin = "10px"; d.innerHTML = `<b>${u.n}</b><br><small>${u.d}</small>`;
        d.onclick = () => { u.a(); document.getElementById('upgrade-screen').style.display='none'; G.play=true; draw(); };
        cont.appendChild(d);
    });
}

// --- INPUTS ---
function swap() {
    let idx = G.owned.indexOf(G.weapon);
    G.weapon = G.owned[(idx+1)%G.owned.length];
}
document.getElementById('swap-mob').onclick = swap;

window.onkeydown = e => { keys.add(e.key.toLowerCase()); if(e.key==='q') swap(); };
window.onkeyup = e => keys.delete(e.key.toLowerCase());

if(isMobile) {
    document.getElementById('mobile-hud').style.display = 'block';
    const b = document.getElementById('joy-base'), s = document.getElementById('joy-stick');
    b.ontouchstart = e => { joy.active=true; let r=b.getBoundingClientRect(); joy.sx=r.left+60; joy.sy=r.top+60; };
    b.ontouchmove = e => {
        if(!joy.active) return; let t=e.touches[0];
        let dx=t.clientX-joy.sx, dy=t.clientY-joy.sy;
        let d=Math.min(Math.hypot(dx,dy), 40); let a=Math.atan2(dy,dx);
        joy.x=(Math.cos(a)*d)/40; joy.y=(Math.sin(a)*d)/40;
        s.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    };
    b.ontouchend = () => { joy.active=false; joy.x=0; joy.y=0; s.style.transform='none'; };
    document.querySelectorAll('.btn-atk').forEach(btn => {
        btn.ontouchstart = () => mobAtk[btn.dataset.dir] = true;
        btn.ontouchend = () => mobAtk[btn.dataset.dir] = false;
    });
}

document.getElementById('btn-play').onclick = () => {
    G.play = true; document.getElementById('start-screen').style.display='none';
    spawnRoom(); draw();
};

window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize();
</script>
</body>
</html>
