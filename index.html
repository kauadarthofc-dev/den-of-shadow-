<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow üíÄ Lord of Light</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&family=Special+Elite&display=swap');
        
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        canvas { display: block; width: 100vw; height: 100vh; }

        /* HUD ESTILO ISAAC */
        #hud-container { position: absolute; inset: 0; pointer-events: none; z-index: 1000; display: none; padding: 15px; }
        
        .hud-left { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 5px; }
        .hud-right { position: absolute; top: 15px; right: 15px; text-align: right; }
        
        .stat-row { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 4px 10px; border-radius: 5px; }
        .bar-outer { width: 120px; height: 10px; background: #222; border: 1px solid #444; overflow: hidden; }
        .bar-inner { height: 100%; transition: width 0.3s; }

        /* MINIMAPA */
        #minimap-canvas { 
            width: 120px; height: 80px; 
            background: rgba(255, 0, 0, 0.05); 
            border: 2px solid rgba(255, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        /* JOYSTICKS */
        .touch-zone { position: absolute; bottom: 0; width: 50%; height: 50%; pointer-events: auto; }
        #left-zone { left: 0; }
        #right-zone { right: 0; }

        /* TELAS E OUTROS */
        .ui-screen { 
            position: absolute; inset: 0; 
            background: radial-gradient(circle at center, #4a0404 0%, #000000 100%);
            z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        #start-screen h1 { font-family: 'Nosifer', cursive; font-size: clamp(30px, 8vw, 60px); color: #ff0000; text-shadow: 0 0 20px #ff0000; margin: 10px; text-align: center; }
        .btn-main { padding: 15px 40px; font-size: 18px; background: transparent; border: 2px solid #ff0000; color: #fff; cursor: pointer; font-family: 'Orbitron'; margin: 10px; transition: 0.3s; z-index: 3100; }
        .social-links a { color: #ff0000; text-decoration: none; font-size: 12px; display: block; margin: 5px; }
        #cutscene-screen { background: #000; text-align: center; padding: 20px; display: none; }
        #msg-popup { position: absolute; top: 25%; width: 100%; text-align: center; font-size: 24px; color: #ff0000; display: none; z-index: 2000; font-family: 'Nosifer'; pointer-events: none; }
    </style>
</head>
<body>

<div id="hud-container">
    <div class="hud-left">
        <div class="stat-row">
            <span style="color:#ff0000; font-size:12px;">HP</span>
            <div class="bar-outer"><div id="hp-bar" class="bar-inner" style="background:#ff0000; width:100%;"></div></div>
        </div>
        <div class="stat-row">
            <span style="color:#f1c40f; font-size:12px;">AM</span>
            <div class="bar-outer"><div id="ammo-bar" class="bar-inner" style="background:#f1c40f; width:100%;"></div></div>
        </div>
        <div style="font-size: 14px; color: #ff0000; margin-top:5px;">SALA: <span id="room-txt">0</span></div>
    </div>

    <div class="hud-right">
        <canvas id="minimap-canvas"></canvas>
    </div>

    <div id="left-zone" class="touch-zone"></div>
    <div id="right-zone" class="touch-zone"></div>
</div>

<div id="start-screen" class="ui-screen">
    <h1>DEN OF SHADOW</h1>
    <p id="subtitle" style="letter-spacing: 5px; color: #ff0000; margin-bottom: 20px;">LORD OF LIGHT</p>
    <button class="btn-main" onclick="initCutscene()">JOGAR</button>
    <div class="social-links">
        <a href="mailto:kauaderthofc@gmail.com">kauaderthofc@gmail.com</a>
        <a href="https://youtube.com/@kaua_darth" target="_blank">YouTube: @kaua_darth</a>
    </div>
</div>

<div id="cutscene-screen" class="ui-screen" onclick="nextHistory()">
    <div id="cutscene-text" style="font-family: 'Special Elite'; font-size: 1.2rem; max-width: 80%; line-height: 1.5;"></div>
    <div style="position: absolute; bottom: 40px; font-size: 10px; opacity: 0.5;">TOQUE PARA CONTINUAR</div>
</div>

<div id="msg-popup"></div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mCanvas = document.getElementById('minimap-canvas');
const mCtx = mCanvas.getContext('2d');

const ROOM = { w: 1600, h: 1000, wallSize: 70 };
const G = { 
    play: false, room: 0, hp: 100, ammo: 30, maxAmmo: 30, 
    reloading: false, enemiesDefeated: false, 
    hasFireWpn: false, lastShot: 0,
    clearedRooms: new Set() // Armazena IDs das salas limpas
};

// Controles Touch
let touchMove = { x: 0, y: 0, active: false };
let touchShoot = { x: 0, y: 0, active: false };

const texts = {
    pt: {
        sub: "LORDE DA LUZ", boss: "GUARDI√ÉO!", weapon: "REL√çQUIA OBTIDA!",
        history: [
            "O Lorde da Luz foi tra√≠do por sua pr√≥pria sombra...",
            "Agora ele rasteja no Den of Shadow para recuperar seu poder.",
            "Na Sala 5, uma arma de fogo antiga o espera.",
            "Use o lado esquerdo para andar e o direito para atirar."
        ]
    }
};

let player = { x: 800, y: 800, r: 25, spd: 9 };
let enemies = [], projectiles = [], drops = [], pedestal = null;
const keys = {};

function initCutscene() {
    document.getElementById('start-screen').style.display='none';
    document.getElementById('cutscene-screen').style.display='flex';
    nextHistory();
}

let hIdx = 0;
function nextHistory() {
    if (hIdx < texts.pt.history.length) {
        document.getElementById('cutscene-text').innerText = texts.pt.history[hIdx++];
    } else {
        startGame();
    }
}

function startGame() {
    document.getElementById('cutscene-screen').style.display='none';
    document.getElementById('hud-container').style.display='block';
    G.play = true;
    G.clearedRooms.add(0); // Sala 0 j√° conta como limpa
    initRoom('bottom'); // Come√ßa entrando por baixo
}

// direction: 'bottom' (entra por baixo, indo pra cima) ou 'top' (entra por cima, voltando)
function initRoom(entrySide) {
    enemies = []; projectiles = []; drops = []; pedestal = null;
    
    // Posicionamento do Jogador ao entrar
    if (entrySide === 'bottom') {
        player.x = ROOM.w / 2;
        player.y = ROOM.h - ROOM.wallSize - 60;
    } else {
        player.x = ROOM.w / 2;
        player.y = ROOM.wallSize + 60;
    }

    // Verifica se a sala j√° foi limpa
    if (G.clearedRooms.has(G.room)) {
        G.enemiesDefeated = true;
    } else {
        G.enemiesDefeated = false;
        
        // Spawn Inimigos apenas se sala n√£o foi limpa
        if (G.room > 0) {
            let isBoss = G.room % 10 === 0;
            if (isBoss) {
                enemies.push({ x: ROOM.w/2, y: 300, hp: 1000 + (G.room * 50), r: 90, spd: 2.8, isBoss: true, offset: 0 });
                showPopup(texts.pt.boss);
            } else {
                let count = 4 + Math.floor(G.room * 0.7);
                for(let i=0; i<count; i++) {
                    enemies.push({ 
                        x: Math.random()*(ROOM.w-300)+150, y: Math.random()*(ROOM.h-500)+150, 
                        hp: 70 + G.room*15, r: 32, spd: 2 + (G.room*0.12), offset: Math.random()*10
                    });
                }
            }
        } else {
            G.enemiesDefeated = true; // Sala 0
        }
    }

    // Pedestal logic (permanece se arma n√£o foi pega e sala √© a correta)
    if ((G.room === 5 || (G.room % 10 === 0 && G.room !== 0)) && !G.hasFireWpn && G.enemiesDefeated) {
         pedestal = { x: ROOM.w/2, y: ROOM.h/2 };
    }
}

function showPopup(t) {
    const p = document.getElementById('msg-popup');
    p.innerText = t; p.style.display = 'block';
    setTimeout(() => p.style.display = 'none', 2000);
}

const setupTouch = (id, obj) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', e => { 
        obj.active = true;
        const t = e.touches[0];
        obj.startX = t.clientX; obj.startY = t.clientY;
    });
    el.addEventListener('touchmove', e => {
        const t = Array.from(e.touches).find(tt => id === 'left-zone' ? tt.clientX < window.innerWidth/2 : tt.clientX > window.innerWidth/2);
        if(t) {
            obj.x = (t.clientX - obj.startX);
            obj.y = (t.clientY - obj.startY);
        }
    });
    el.addEventListener('touchend', () => { obj.active = false; obj.x = 0; obj.y = 0; });
};
setupTouch('left-zone', touchMove);
setupTouch('right-zone', touchShoot);

function update() {
    if(!G.play) return;

    // Movimento
    let mx = 0, my = 0;
    if(keys['w']) my = -1; if(keys['s']) my = 1; if(keys['a']) mx = -1; if(keys['d']) mx = 1;
    if(touchMove.active) {
        let dist = Math.hypot(touchMove.x, touchMove.y);
        if(dist > 10) { mx = touchMove.x/dist; my = touchMove.y/dist; }
    }
    player.x = Math.max(ROOM.wallSize+25, Math.min(ROOM.w-ROOM.wallSize-25, player.x + mx*player.spd));
    player.y = Math.max(ROOM.wallSize+25, Math.min(ROOM.h-ROOM.wallSize-25, player.y + my*player.spd));

    // Tiro
    let ax = 0, ay = 0;
    if(keys['arrowup']) ay = -1; if(keys['arrowdown']) ay = 1; if(keys['arrowleft']) ax = -1; if(keys['arrowright']) ax = 1;
    if(touchShoot.active) {
        let dist = Math.hypot(touchShoot.x, touchShoot.y);
        if(dist > 20) { ax = touchShoot.x/dist; ay = touchShoot.y/dist; }
    }

    if((ax || ay) && !G.reloading) {
        if(G.ammo > 0) {
            if(Date.now() - G.lastShot > 160) {
                projectiles.push({ x: player.x, y: player.y, vx: ax*20, vy: ay*20, r: G.hasFireWpn ? 18 : 10, dmg: G.hasFireWpn ? 90 : 40, color: G.hasFireWpn ? "#ff4500" : "#fff" });
                G.ammo--; G.lastShot = Date.now();
            }
        } else {
            G.reloading = true;
            setTimeout(() => { G.ammo = G.maxAmmo; G.reloading = false; }, 1000);
        }
    }

    // Inimigos
    enemies.forEach((en) => {
        let dx = player.x - en.x, dy = player.y - en.y, dist = Math.hypot(dx, dy);
        let mX = dx/dist, mY = dy/dist;
        if(!en.isBoss) { mX += Math.cos(Date.now()*0.005 + en.offset)*0.25; mY += Math.sin(Date.now()*0.005 + en.offset)*0.25; }
        en.x += mX * en.spd; en.y += mY * en.spd;
        if(dist < player.r + en.r) G.hp -= en.isBoss ? 0.9 : 0.6;
    });

    // Colis√µes
    projectiles.forEach((p, pi) => {
        p.x += p.vx; p.y += p.vy;
        enemies.forEach((en, ei) => {
            if(Math.hypot(p.x-en.x, p.y-en.y) < en.r) {
                en.hp -= p.dmg; projectiles.splice(pi, 1);
                if(en.hp <= 0) {
                    if(Math.random() < 0.4) drops.push({x: en.x, y: en.y});
                    enemies.splice(ei, 1);
                }
            }
        });
    });

    drops.forEach((d, i) => { if(Math.hypot(player.x-d.x, player.y-d.y) < 50) { G.hp = Math.min(100, G.hp+25); drops.splice(i, 1); } });

    // Limpeza da Sala
    if(enemies.length === 0 && !G.enemiesDefeated) {
        G.enemiesDefeated = true;
        G.clearedRooms.add(G.room); // Marca como limpa
        if(G.room === 5 || (G.room % 10 === 0 && G.room !== 0)) pedestal = { x: ROOM.w/2, y: ROOM.h/2 };
    }

    if(pedestal && Math.hypot(player.x-pedestal.x, player.y-pedestal.y) < 60) { G.hasFireWpn = true; pedestal = null; showPopup(texts.pt.weapon); }

    // SISTEMA DE PORTAS (AVAN√áAR E VOLTAR)
    if (G.enemiesDefeated) {
        const doorW = 200;
        // Porta de Cima (Pr√≥xima Sala)
        if (player.y < ROOM.wallSize + 30 && player.x > ROOM.w/2 - doorW/2 && player.x < ROOM.w/2 + doorW/2) {
            G.room++; 
            initRoom('bottom');
        }
        // Porta de Baixo (Voltar) - S√≥ aparece se room > 0
        if (G.room > 0 && player.y > ROOM.h - ROOM.wallSize - 30 && player.x > ROOM.w/2 - doorW/2 && player.x < ROOM.w/2 + doorW/2) {
            G.room--; 
            initRoom('top');
        }
    }

    if(G.hp <= 0) location.reload();
}

function drawMinimap() {
    mCtx.clearRect(0,0,mCanvas.width, mCanvas.height);
    const sw = mCanvas.width / ROOM.w;
    const sh = mCanvas.height / ROOM.h;

    // Jogador
    mCtx.fillStyle = "#fff";
    mCtx.fillRect(player.x * sw, player.y * sh, 4, 4);

    // Inimigos
    mCtx.fillStyle = "#f00";
    enemies.forEach(en => mCtx.fillRect(en.x * sw, en.y * sh, 3, 3));

    // Pedestal
    if(pedestal) { mCtx.fillStyle = "#f1c40f"; mCtx.fillRect(pedestal.x * sw, pedestal.y * sh, 5, 5); }

    // Portas
    if(G.enemiesDefeated) {
        mCtx.strokeStyle = "#f00";
        // Porta Cima
        mCtx.strokeRect((ROOM.w/2-50)*sw, 0, 100*sw, 10*sh);
        // Porta Baixo (se room > 0)
        if(G.room > 0) {
            mCtx.strokeRect((ROOM.w/2-50)*sw, mCanvas.height - 10*sh, 100*sw, 10*sh);
        }
    }
}

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
    if(!G.play) { requestAnimationFrame(draw); return; }
    update();
    drawMinimap();

    ctx.save();
    let s = Math.min(canvas.width/ROOM.w, canvas.height/ROOM.h);
    ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(s,s); ctx.translate(-ROOM.w/2, -ROOM.h/2);

    // Arena
    ctx.fillStyle = "#0d0000"; ctx.fillRect(0,0,ROOM.w,ROOM.h);
    ctx.fillStyle = "#1a0000"; 
    ctx.fillRect(0,0,ROOM.w,ROOM.wallSize); ctx.fillRect(0,ROOM.h-ROOM.wallSize,ROOM.w,ROOM.wallSize);
    ctx.fillRect(0,0,ROOM.wallSize,ROOM.h); ctx.fillRect(ROOM.w-ROOM.wallSize,0,ROOM.wallSize,ROOM.h);

    if(G.enemiesDefeated) {
        ctx.fillStyle = "#ff0000"; ctx.shadowBlur = 30; ctx.shadowColor = "#f00";
        // Porta Cima
        ctx.fillRect(ROOM.w/2-100, 0, 200, ROOM.wallSize + 15);
        // Porta Baixo
        if (G.room > 0) {
            ctx.fillRect(ROOM.w/2-100, ROOM.h - ROOM.wallSize - 15, 200, ROOM.wallSize + 15);
        }
        ctx.shadowBlur = 0;
    }

    if(pedestal) {
        ctx.fillStyle = "#333"; ctx.fillRect(pedestal.x-50, pedestal.y-40, 100, 80);
        ctx.fillStyle = "#ff4500"; ctx.font = "45px Arial"; ctx.fillText("üî´", pedestal.x-22, pedestal.y+15);
    }

    drops.forEach(d => { ctx.fillStyle = "#fff"; ctx.font = "35px Orbitron"; ctx.fillText("‚ûï", d.x-15, d.y+15); });

    enemies.forEach(en => {
        ctx.fillStyle = en.isBoss ? "#600" : "#f00";
        ctx.beginPath(); ctx.arc(en.x, en.y, en.r, 0, Math.PI*2); ctx.fill();
        let hpPct = en.hp / (en.isBoss ? 1000+(G.room*50) : 70+G.room*15);
        ctx.fillStyle = "#222"; ctx.fillRect(en.x-40, en.y-en.r-20, 80, 8);
        ctx.fillStyle = "#f00"; ctx.fillRect(en.x-40, en.y-en.r-20, 80 * hpPct, 8);
    });

    ctx.fillStyle = G.reloading ? "#444" : "#fff";
    ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();
    if(G.hasFireWpn) { ctx.strokeStyle = "#ff4500"; ctx.lineWidth = 5; ctx.stroke(); }
    
    projectiles.forEach(p => { 
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill(); 
    });

    ctx.restore();
    
    document.getElementById('hp-bar').style.width = G.hp + "%";
    document.getElementById('ammo-bar').style.width = (G.ammo/G.maxAmmo*100) + "%";
    document.getElementById('room-txt').innerText = G.room;
    
    requestAnimationFrame(draw);
}

window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => delete keys[e.key.toLowerCase()]);
window.onresize = () => { 
    canvas.width = window.innerWidth; canvas.height = window.innerHeight; 
    mCanvas.width = 120; mCanvas.height = 80;
};
window.onresize(); draw();
</script>
</body>
</html>
