<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow ðŸ’€ V15.25 PRO FIX</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&display=swap');
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }

        /* UI Screens */
        .ui-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .glass-panel { background: #0a0000; border: 2px solid #f00; padding: 25px; width: 85%; max-width: 400px; text-align: center; border-radius: 10px; }
        .btn-main { padding: 15px; background: #111; border: 1px solid #f00; color: #fff; cursor: pointer; width: 100%; margin: 8px 0; font-family: 'Orbitron'; text-transform: uppercase; }

        /* HUD */
        #hud { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; z-index: 4000; pointer-events: none; }
        .hp-bar { background: #300; height: 12px; width: 100%; border: 1px solid #f00; }
        #hp-fill { background: #f00; height: 100%; width: 100%; transition: 0.2s; }

        /* MOBILE CONTROLS - FIXED */
        #mobile-controls { position: absolute; inset: 0; z-index: 3000; display: none; }
        #move-zone { position: absolute; bottom: 0; left: 0; width: 50%; height: 60%; pointer-events: auto; }
        #look-zone { position: absolute; bottom: 0; right: 0; width: 50%; height: 100%; pointer-events: auto; }
        
        #joy-base { position: absolute; bottom: 60px; left: 60px; width: 100px; height: 100px; background: rgba(255,0,0,0.1); border: 2px solid #f00; border-radius: 50%; pointer-events: none; }
        #stick { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: #f00; border-radius: 50%; pointer-events: none; }

        .action-btns { position: absolute; bottom: 40px; right: 20px; display: flex; flex-direction: column; gap: 15px; }
        .btn-act { width: 75px; height: 75px; background: rgba(0,0,0,0.7); border: 2px solid #f00; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; pointer-events: auto; }

        #weapon-view { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 300px; height: 200px; pointer-events: none; z-index: 2500; }
    </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
    <div class="glass-panel">
        <h1 style="font-family:'Nosifer'; color:#f00;">DEN OF SHADOW</h1>
        <button class="btn-main" onclick="loadAndStart(1)">JOGAR AGORA</button>
        <p style="font-size: 10px; color: #555;">V15.25 MOBILE STABLE</p>
    </div>
</div>

<div id="hud" style="display:none;">
    <div style="margin-bottom:5px;">SALA <span id="room-txt">1</span> | ALMAS: <span id="soul-txt">0</span></div>
    <div class="hp-bar"><div id="hp-fill"></div></div>
</div>

<div id="mobile-controls">
    <div id="move-zone">
        <div id="joy-base"><div id="stick"></div></div>
    </div>
    <div id="look-zone"></div>
    <div class="action-btns">
        <div class="btn-act" id="btn-fire">ðŸ”¥</div>
        <div class="btn-act" id="btn-jump" style="width:60px; height:60px;">PULAR</div>
        <div class="btn-act" id="btn-buy" style="font-size:12px; height:50px;">LOJA</div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const G = { 
    play: false, room: 1, hp: 100, souls: 0, ammo: 40, weapon: 1, 
    res: 8, isMobile: false, speed: 4.5, jumpV: 0, z: 0, recoil: 0 
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 64, MAP_SIZE = 24;
let map = [], enemies = [], items = [], bullets = [], keys = {};
let player = { x: 0, y: 0, angle: 0, pitch: 0, fov: Math.PI / 3 };

// Controles Mobile Refatorados (IndependÃªncia de Dedos)
let joyId = null, lookId = null;
let moveJoy = { startX: 0, startY: 0, curX: 0, curY: 0, active: false };
let lastLookX = 0, lastLookY = 0;

function loadAndStart(slot) {
    G.isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    if(G.isMobile) document.getElementById('mobile-controls').style.display = 'block';
    
    setupRoom();
    G.play = true;
    loop();
}

function setupRoom() {
    map = Array(MAP_SIZE * MAP_SIZE).fill(0);
    enemies = []; items = [];
    const isShop = (G.room % 5 === 0);
    
    // Paredes
    for(let i=0; i<MAP_SIZE; i++){ map[i]=1; map[i+(MAP_SIZE*(MAP_SIZE-1))]=1; map[i*MAP_SIZE]=1; map[i*MAP_SIZE+(MAP_SIZE-1)]=1; }

    if(isShop) {
        // Pedestais (Shopping)
        spawnItem(10, 12, 'HP', 10);
        spawnItem(14, 12, 'GUN', 30);
    } else {
        for(let i=0; i<20; i++) map[Math.floor(Math.random()*map.length)] = 1;
        for(let i=0; i<2+G.room; i++) enemies.push({x:(8+Math.random()*8)*TILE, y:(8+Math.random()*8)*TILE, hp: 50, alive:true});
    }
    map[Math.floor(MAP_SIZE/2)] = 2; // SaÃ­da
    player.x = 12*TILE; player.y = 20*TILE;
}

function spawnItem(tx, ty, type, price) {
    map[ty*MAP_SIZE+tx] = 3; // Bloco de Pedestal
    items.push({ x: tx*TILE + 32, y: ty*TILE + 32, type, price, active: true });
}

// LÃ³gica de Movimento Mobile Fixa
const moveZone = document.getElementById('move-zone');
moveZone.addEventListener('touchstart', e => {
    for(let t of e.changedTouches) {
        if(!moveJoy.active) {
            joyId = t.identifier;
            moveJoy.active = true;
            moveJoy.startX = t.clientX; moveJoy.startY = t.clientY;
        }
    }
});

moveZone.addEventListener('touchmove', e => {
    for(let t of e.changedTouches) {
        if(t.identifier === joyId) {
            let dx = t.clientX - moveJoy.startX, dy = t.clientY - moveJoy.startY;
            let dist = Math.min(40, Math.hypot(dx, dy));
            let ang = Math.atan2(dy, dx);
            moveJoy.curX = Math.cos(ang) * (dist/40);
            moveJoy.curY = Math.sin(ang) * (dist/40);
            document.getElementById('stick').style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
        }
    }
});

moveZone.addEventListener('touchend', e => {
    for(let t of e.changedTouches) {
        if(t.identifier === joyId) {
            moveJoy.active = false; moveJoy.curX = 0; moveJoy.curY = 0;
            joyId = null;
            document.getElementById('stick').style.transform = `translate(0,0)`;
        }
    }
});

// LÃ³gica de Olhar Mobile Fixa
const lookZone = document.getElementById('look-zone');
lookZone.addEventListener('touchstart', e => {
    for(let t of e.changedTouches) {
        if(lookId === null) {
            lookId = t.identifier;
            lastLookX = t.clientX; lastLookY = t.clientY;
        }
    }
});

lookZone.addEventListener('touchmove', e => {
    for(let t of e.changedTouches) {
        if(t.identifier === lookId) {
            player.angle += (t.clientX - lastLookX) * 0.007;
            player.pitch = Math.max(-200, Math.min(200, player.pitch - (t.clientY - lastLookY) * 1.5));
            lastLookX = t.clientX; lastLookY = t.clientY;
        }
    }
});

lookZone.addEventListener('touchend', e => {
    for(let t of e.changedTouches) if(t.identifier === lookId) lookId = null;
});

// AÃ§Ãµes
document.getElementById('btn-fire').ontouchstart = e => { e.preventDefault(); shoot(); };
document.getElementById('btn-jump').ontouchstart = e => { e.preventDefault(); jump(); };
document.getElementById('btn-buy').ontouchstart = e => { e.preventDefault(); buy(); };

window.onkeydown = e => { keys[e.key.toLowerCase()] = true; if(e.key === ' ') jump(); };
window.onkeyup = e => delete keys[e.key.toLowerCase()];

function jump() { if(G.z === 0) G.jumpV = 10; }

function shoot() {
    G.recoil = 20;
    const b = (a) => bullets.push({x: player.x, y: player.y, vx: Math.cos(a)*20, vy: Math.sin(a)*20, life: 50});
    b(player.angle);
    if(G.weapon === 2) { b(player.angle-0.1); b(player.angle+0.1); }
}

function buy() {
    items.forEach(it => {
        if(it.active && Math.hypot(player.x-it.x, player.y-it.y) < 100) {
            if(G.souls >= it.price) {
                G.souls -= it.price; it.active = false;
                if(it.type === 'HP') G.hp = 100;
                if(it.type === 'GUN') G.weapon = 2;
            }
        }
    });
}

function update() {
    if(!G.play) return;
    
    // Gravidade / Pulo
    G.z += G.jumpV;
    G.jumpV -= 1;
    if(G.z <= 0) { G.z = 0; G.jumpV = 0; }
    if(G.recoil > 0) G.recoil -= 2;

    // Movimento
    let mx = 0, my = 0;
    if(keys['w']) { mx += Math.cos(player.angle); my += Math.sin(player.angle); }
    if(keys['s']) { mx -= Math.cos(player.angle); my -= Math.sin(player.angle); }
    if(moveJoy.active) {
        mx += Math.cos(player.angle) * (-moveJoy.curY) + Math.cos(player.angle + Math.PI/2) * moveJoy.curX;
        my += Math.sin(player.angle) * (-moveJoy.curY) + Math.sin(player.angle + Math.PI/2) * moveJoy.curX;
    }
    
    let nx = player.x + mx*G.speed, ny = player.y + my*G.speed;
    if(map[Math.floor(ny/TILE)*MAP_SIZE + Math.floor(nx/TILE)] === 0) { player.x = nx; player.y = ny; }

    // Inimigos com ColisÃ£o
    enemies.forEach(en => {
        if(!en.alive) return;
        let d = Math.hypot(player.x-en.x, player.y-en.y);
        let ex = (player.x-en.x)/d * 2, ey = (player.y-en.y)/d * 2;
        // Checagem de parede para inimigo
        if(map[Math.floor((en.y+ey)/TILE)*MAP_SIZE + Math.floor((en.x+ex)/TILE)] === 0) {
            en.x += ex; en.y += ey;
        }
        if(d < 40) G.hp -= 0.5;
    });

    bullets = bullets.filter(b => {
        b.x += b.vx; b.y += b.vy; b.life--;
        let hit = false;
        enemies.forEach(en => { if(en.alive && Math.hypot(b.x-en.x, b.y-en.y)<30){ en.hp-=20; hit=true; if(en.hp<=0){en.alive=false; G.souls+=5;} } });
        return !hit && b.life > 0 && map[Math.floor(b.y/TILE)*MAP_SIZE+Math.floor(b.x/TILE)] === 0;
    });

    if(map[Math.floor(player.y/TILE)*MAP_SIZE+Math.floor(player.x/TILE)] === 2) { G.room++; setupRoom(); }
    
    document.getElementById('hp-fill').style.width = G.hp + "%";
    document.getElementById('soul-txt').innerText = G.souls;
}

function draw() {
    ctx.fillStyle = "#050000"; ctx.fillRect(0,0,canvas.width, canvas.height/2 + player.pitch + G.z);
    ctx.fillStyle = "#110505"; ctx.fillRect(0,canvas.height/2 + player.pitch + G.z, canvas.width, canvas.height);

    const zBuf = [];
    for(let i=0; i<canvas.width; i+=G.res) {
        let ang = (player.angle - player.fov/2) + (i/canvas.width)*player.fov;
        let d=0, cos=Math.cos(ang), sin=Math.sin(ang), hit=0;
        while(hit===0 && d<800) {
            d += 5;
            let tx = Math.floor((player.x+cos*d)/TILE), ty = Math.floor((player.y+sin*d)/TILE);
            if(map[ty*MAP_SIZE+tx] > 0) {
                hit = map[ty*MAP_SIZE+tx];
                let dist = d * Math.cos(player.angle-ang);
                zBuf[i] = dist;
                let h = (TILE * canvas.height) / dist;
                ctx.fillStyle = hit===1 ? "#200" : (hit===2 ? "#0f0" : "#444");
                ctx.fillRect(i, (canvas.height-h)/2 + player.pitch + G.z, G.res, h);
            }
        }
    }

    // Desenhar Inimigos e Itens
    [...enemies, ...items].forEach(s => {
        if(s.alive===false || s.active===false) return;
        let dx = s.x - player.x, dy = s.y - player.y;
        let dist = Math.hypot(dx, dy);
        let ang = Math.atan2(dy, dx) - player.angle;
        if(ang < -Math.PI) ang += Math.PI*2; if(ang > Math.PI) ang -= Math.PI*2;
        if(Math.abs(ang) < player.fov && dist < (zBuf[Math.floor(canvas.width/2)] || 999)) {
            let sx = (0.5 * (ang/(player.fov/2)) + 0.5) * canvas.width;
            let sh = (TILE * canvas.height) / dist;
            ctx.fillStyle = s.price ? "#ff0" : "#f00";
            ctx.fillRect(sx-sh/4, (canvas.height/2) + player.pitch + G.z - sh/4, sh/2, sh/2);
        }
    });

    // ARMA FPS
    ctx.fillStyle = "#333";
    let gunX = canvas.width/2 - 50, gunY = canvas.height - 150 + G.recoil - G.z/2;
    ctx.fillRect(gunX, gunY, 100, 200); // Corpo da arma
    ctx.fillStyle = "#f00";
    ctx.fillRect(gunX+40, gunY-20, 20, 40); // Cano
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize();
</script>
</body>
</html>
