<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow</title>
    <style>
        * { touch-action: none !important; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }
        html, body { background: #1a1a2e; margin: 0; padding: 0; overflow: hidden; height: 100%; width: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #fff; }
        canvas { display: block; image-rendering: pixelated; background: #242442; }

        /* UI Overlays */
        .overlay { position: absolute; inset: 0; background: rgba(15, 15, 35, 0.95); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .btn-ui { padding: 15px 40px; background: #4ecca3; border: none; color: #1a1a2e; font-size: 24px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 #3b9a7a; }
        .btn-ui:active { transform: translateY(4px); box-shadow: none; }
        
        /* Mobile UI - Organização Estratégica */
        #mobile-ui { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        #joy-zone { position: absolute; bottom: 0; left: 0; width: 40%; height: 60%; pointer-events: auto; }
        #atk-zone { position: absolute; bottom: 0; right: 0; width: 45%; height: 65%; pointer-events: auto; }
        #joy-bound { position: absolute; bottom: 15%; left: 15%; width: 140px; height: 140px; background: rgba(255,255,255,0.1); border: 3px solid #fff; border-radius: 50%; }
        #joy-stick { position: absolute; left: 45px; top: 45px; width: 50px; height: 50px; background: #4ecca3; border-radius: 50%; }
        
        #btn-grid { position: absolute; bottom: 10%; right: 5%; display: grid; grid-template-columns: repeat(3, 100px); gap: 15px; }
        .atk-btn { width: 100px; height: 100px; background: rgba(78, 204, 163, 0.2); border: 4px solid #4ecca3; border-radius: 50%; color: #4ecca3; display: flex; justify-content: center; align-items: center; font-size: 40px; pointer-events: auto; }
        
        #swap-btn { position: absolute; bottom: 12%; right: 40%; width: 90px; height: 90px; background: #f1c40f; color: #1a1a2e; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; pointer-events: auto; font-size: 14px; border: 4px solid #fff; }
        #fs-btn { position: absolute; top: 10px; right: 10px; padding: 10px; background: #333; color: white; border-radius: 5px; pointer-events: auto; font-size: 10px; border: 1px solid #666; }

        /* Upgrade Cards */
        #card-screen { display: none; flex-direction: row; flex-wrap: wrap; padding: 20px; z-index: 3000; }
        .card { width: 150px; height: 220px; background: #16213e; border-radius: 10px; margin: 10px; padding: 15px; border: 4px solid #fff; cursor: pointer; }
        .c-com { border-color: #3498db; } .c-inc { border-color: #2ecc71; } .c-rar { border-color: #f1c40f; } .c-epi { border-color: #9b59b6; }
        .c-len { border-color: #ff00ff; animation: glow 1s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px #ff00ff; } to { box-shadow: 0 0 25px #ff00ff; } }
    </style>
</head>
<body>

<div id="fs-btn" onclick="toggleFS()">⛶ FULLSCREEN</div>

<div id="start-screen" class="overlay">
    <h1 style="color:#4ecca3; font-size:45px; margin:0;">DEN OF SHADOW</h1>
    <p id="platform-hint" style="color:#888; margin-bottom:20px;"></p>
    <div class="btn-ui" id="btn-start">INICIAR</div>
</div>

<div id="card-screen" class="overlay">
    <h2 style="color:#f1c40f; width:100%">UPGRADE DISPONÍVEL</h2>
    <div id="cards-box" style="display:flex;"></div>
</div>

<canvas id="game"></canvas>

<div id="mobile-ui">
    <div id="joy-zone"><div id="joy-bound"><div id="joy-stick"></div></div></div>
    <div id="atk-zone">
        <div id="btn-grid">
            <div></div><div class="atk-btn" data-dir="up">▲</div><div></div>
            <div class="atk-btn" data-dir="left">◀</div><div class="atk-btn" data-dir="down">▼</div><div class="atk-btn" data-dir="right">▶</div>
        </div>
    </div>
    <div id="swap-btn">SWAP</div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

const Game = {
    started: false, room: 0, roomW: 1600, roomH: 1200,
    camX: 0, camY: 0, lives: 6, maxLives: 6,
    weapon: 'normal', dmgMult: 1, moveSpd: 5.5,
    triple: 0, ric: 0, dual: false, vamping: 0, pets: 0,
    hasFire: false, hasShot: false, hasStaff: false,
    weapons: {
        normal: { ammo: 8, max: 8, dmg: 10, color: "#0ff", name: "Magnum", type: "single" },
        fire: { ammo: 25, max: 25, dmg: 6, burn: 2, color: "#ff4500", name: "Fire Breath", type: "breath" },
        shotgun: { ammo: 5, max: 5, dmg: 17, color: "#f1c40f", name: "Shotgun", type: "spread" },
        staff: { ammo: 12, max: 12, dmg: 22, color: "#9b59b6", name: "Magic Staff", type: "homing" }
    }
};

let enemies = [], projectiles = [], particles = [], drops = [], pets = [], pedestals = [];
let p = { x: 800, y: 600, iframe: 0, timer: 0, legPhase: 0, reloading: false, reloadT: 0 };
const keys = new Set();
const atkDir = { up: false, down: false, left: false, right: false };
const joy = { active: false, x: 0, y: 0, sx: 0, sy: 0 };

if(isMobile) {
    document.getElementById('platform-hint').innerText = "Mobile: Controle à esquerda, Ataque à direita";
    document.getElementById('mobile-ui').style.display = 'block';
} else {
    document.getElementById('platform-hint').innerText = "PC: WASD para Mover | SETAS para Atirar | Q troca Arma";
}

function initRoom() {
    enemies = []; projectiles = []; drops = []; pedestals = [];
    p.x = Game.roomW/2; p.y = Game.roomH/2;

    if(Game.room === 0) return; // Tutorial vazio

    if(Game.room % 10 === 0) {
        enemies.push({ type:'boss', x:Game.roomW/2-100, y:300, hp:700+Game.room*50, max:700+Game.room*50, w:200, h:200, hit:0, timer:0 });
    } else {
        let n = 3 + Math.floor(Game.room/3);
        for(let i=0; i<n; i++) {
            let ex, ey;
            do { ex = Math.random()*Game.roomW; ey = Math.random()*Game.roomH; } while(Math.hypot(ex-p.x, ey-p.y) < 500);
            
            let type = 'stalker';
            if(Game.room >= 2) type = Math.random() < 0.3 ? 'dasher' : 'stalker';
            if(Game.room >= 5) type = Math.random() < 0.2 ? 'kamikaze' : type;
            enemies.push({ type, x: ex, y: ey, hp: 45+Game.room*10, w:55, h:55, hit:0, fTick:0, dTimer:0 });
        }
    }

    if(Game.room === 5) pedestals.push({x: Game.roomW/2, y: 400, type:'fire', info: "Baforada: 6 Dano + 2 Queima"});
    if(Game.room === 15) pedestals.push({x: Game.roomW/2, y: 400, type:'shotgun', info: "Shotgun: 17 Dano, Alcance Curto"});
    if(Game.room === 25) pedestals.push({x: Game.roomW/2, y: 400, type:'staff', info: "Cajado: 22 Dano, Persegue Inimigos"});
}

function fire(dx, dy) {
    const w = Game.weapons[Game.weapon];
    if(p.reloading || w.ammo <= 0) return;

    const count = (1 + Game.triple) * (Game.dual ? 2 : 1);
    const baseAng = Math.atan2(dy, dx);

    for(let i=0; i<count; i++) {
        let ang = baseAng + (i - (count-1)/2) * 0.15;
        if(w.type === 'breath') {
            for(let j=0; j<2; j++) projectiles.push({x:p.x+20, y:p.y+20, dx:Math.cos(ang)+(Math.random()-0.5)*0.3, dy:Math.sin(ang)+(Math.random()-0.5)*0.3, type:Game.weapon, life:40});
        } else if(w.type === 'spread') {
            for(let j=-2; j<=2; j++) projectiles.push({x:p.x+20, y:p.y+20, dx:Math.cos(ang+j*0.2), dy:Math.sin(ang+j*0.2), type:Game.weapon, life:25});
        } else {
            projectiles.push({x:p.x+20, y:p.y+20, dx:Math.cos(ang), dy:Math.sin(ang), type:Game.weapon, life:100});
        }
    }
    w.ammo--; if(w.ammo <= 0) p.reloading = true;
}

function update() {
    if(!Game.started || p.dead) return;

    // Player Move
    let mx = joy.active ? joy.x : (keys.has('a')?-1:keys.has('d')?1:0);
    let my = joy.active ? joy.y : (keys.has('w')?-1:keys.has('s')?1:0);
    p.x += mx * Game.moveSpd; p.y += my * Game.moveSpd;
    if(mx !== 0 || my !== 0) p.legPhase += 0.2;

    // Player Atk
    let ax = (keys.has('arrowleft')?-1:keys.has('arrowright')?1:0);
    let ay = (keys.has('arrowup')?-1:keys.has('arrowdown')?1:0);
    if(atkDir.up) ay=-1; if(atkDir.down) ay=1; if(atkDir.left) ax=-1; if(atkDir.right) ax=1;
    if((ax||ay) && p.timer % 15 === 0) fire(ax, ay);

    if(p.reloading) { p.reloadT++; if(p.reloadT > 60){ Game.weapons[Game.weapon].ammo = Game.weapons[Game.weapon].max; p.reloading=false; p.reloadT=0; }}

    // Inimigos
    enemies.forEach((e, i) => {
        let ang = Math.atan2(p.y-e.y, p.x-e.x);
        let dist = Math.hypot(p.x-e.x, p.y-e.y);

        if(e.type === 'dasher') {
            e.dTimer++;
            if(e.dTimer > 100) { e.x += Math.cos(ang)*15; e.y += Math.sin(ang)*15; if(e.dTimer > 115) e.dTimer=0; }
            else { e.x += Math.cos(ang)*2; e.y += Math.sin(ang)*2; }
        } else if(e.type === 'kamikaze') {
            e.x += Math.cos(ang)*1.5; e.y += Math.sin(ang)*1.5;
        } else {
            e.x += Math.cos(ang)*2.2; e.y += Math.sin(ang)*2.2;
        }

        if(p.iframe <= 0 && dist < 50) {
            if(e.type === 'kamikaze') {
                Game.lives -= 2;
                enemies.forEach(o => { if(o!==e && Math.hypot(e.x-o.x, e.y-o.y) < 200) o.hp -= 100; });
                enemies.splice(i,1);
            } else Game.lives--;
            p.iframe = 60;
        }
        if(e.hp <= 0) { 
            if(Math.random() < 0.2) drops.push({x:e.x, y:e.y, type:'heal'});
            if(e.type === 'boss') showUpgrade(); 
            enemies.splice(i,1); 
        }
        if(e.fTick > 0 && p.timer % 30 === 0) { e.hp -= 2; e.fTick--; e.hit=5; }
        if(e.hit > 0) e.hit--;
    });

    // Projéteis
    projectiles.forEach((pr, i) => {
        if(Game.weapons[pr.type].type === 'homing' && enemies.length > 0) {
            let target = enemies[0];
            let ta = Math.atan2(target.y-pr.y, target.x-pr.x);
            pr.dx += Math.cos(ta)*0.1; pr.dy += Math.sin(ta)*0.1;
        }
        pr.x += pr.dx * 12; pr.y += pr.dy * 12; pr.life--;
        enemies.forEach(e => {
            if(pr.x > e.x && pr.x < e.x+e.w && pr.y > e.y && pr.y < e.y+e.h) {
                e.hp -= Game.weapons[pr.type].dmg * Game.dmgMult;
                if(pr.type === 'fire') e.fTick = 5;
                e.hit = 5;
                if(Game.ric > 0 && !pr.didRic) { pr.dx *= -1; pr.dy *= -1; pr.didRic=true; } else projectiles.splice(i,1);
            }
        });
        if(pr.life <= 0) projectiles.splice(i,1);
    });

    // Pedestais
    pedestals.forEach((ped, i) => {
        if(Math.hypot(p.x-ped.x, p.y-ped.y) < 60) {
            if(ped.type === 'fire') Game.hasFire=true;
            if(ped.type === 'shotgun') Game.hasShot=true;
            if(ped.type === 'staff') Game.hasStaff = true;
            pedestals.splice(i,1);
        }
    });

    // Portas
    if(enemies.length === 0 && Game.room > 0) {
        if(Math.hypot(p.x-Game.roomW/2, p.y) < 70) { Game.room++; initRoom(); }
    }

    if(p.iframe > 0) p.iframe--;
    p.timer++;
}

function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx.save();
    Game.camX += (p.x - canvas.width/2 - Game.camX) * 0.1;
    Game.camY += (p.y - canvas.height/2 - Game.camY) * 0.1;
    ctx.translate(-Game.camX, -Game.camY);

    // Chão Dinâmico (Sem Preto)
    ctx.fillStyle = "#2d2d5a";
    if(Game.room % 10 === 0) ctx.fillStyle = "#5a2d2d";
    ctx.fillRect(0,0, Game.roomW, Game.roomH);
    ctx.strokeStyle = "#3d3d7a"; ctx.lineWidth = 2;
    for(let i=0; i<Game.roomW; i+=80) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, Game.roomH); ctx.stroke(); }

    // Pedestais e Texto
    pedestals.forEach(ped => {
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(ped.x-20, ped.y-20, 40, 40);
        if(Math.hypot(p.x-ped.x, p.y-ped.y) < 150) {
            ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(ped.x-100, ped.y-80, 200, 40);
            ctx.fillStyle = "#fff"; ctx.font = "14px Arial"; ctx.fillText(ped.info, ped.x-90, ped.y-55);
        }
    });

    // Player com Pernas
    let ly = Math.sin(p.legPhase)*5;
    ctx.fillStyle = "#4ecca3"; ctx.fillRect(p.x+5, p.y+35+ly, 10, 10); ctx.fillRect(p.x+25, p.y+35-ly, 10, 10);
    ctx.fillStyle = p.iframe > 0 && p.timer % 4 < 2 ? "#ff4d6d" : "#fff";
    ctx.fillRect(p.x, p.y, 40, 40);

    // Inimigos
    enemies.forEach(e => {
        ctx.fillStyle = e.hit > 0 ? "#fff" : (e.type==='boss'?"#e74c3c":(e.type==='kamikaze'?"#f1c40f":"#3498db"));
        ctx.fillRect(e.x, e.y, e.w, e.h);
        if(e.type === 'boss') {
            ctx.fillStyle = "#222"; ctx.fillRect(e.x, e.y-20, e.w, 10);
            ctx.fillStyle = "red"; ctx.fillRect(e.x, e.y-20, (e.hp/e.max)*e.w, 10);
        }
    });

    // Drops
    drops.forEach(d => { ctx.fillStyle="#ff4d6d"; ctx.fillRect(d.x, d.y, 15, 15); });

    // Porta
    if(enemies.length === 0 && Game.room > 0) {
        ctx.fillStyle = "#4ecca3"; ctx.fillRect(Game.roomW/2-50, 0, 100, 20);
    }

    ctx.restore();

    // HUD
    ctx.fillStyle="#fff"; ctx.font="bold 20px Arial";
    ctx.fillText(`SALA: ${Game.room}`, 20, 40);
    ctx.fillText(`${Game.weapons[Game.weapon].name}: ${Game.weapons[Game.weapon].ammo}`, 20, 110);
    for(let i=0; i<Game.maxLives; i++) { ctx.fillStyle=i<Game.lives?"#ff4d6d":"#444"; ctx.beginPath(); ctx.arc(35+i*30, 75, 12, 0, Math.PI*2); ctx.fill(); }

    // Minimapa
    ctx.fillStyle="rgba(0,0,0,0.5)"; ctx.fillRect(canvas.width-160, 20, 140, 140);
    ctx.fillStyle="#fff"; ctx.fillRect(canvas.width-160 + (p.x/Game.roomW)*140, 20 + (p.y/Game.roomH)*140, 4, 4);

    requestAnimationFrame(() => { update(); draw(); });
}

function showUpgrade() {
    Game.paused = true; document.getElementById('card-screen').style.display = 'flex';
    const box = document.getElementById('cards-box'); box.innerHTML = '';
    const pool = [
        {n:"Triple Shot", d:"Atira mais", r:"c-rar", a:()=>Game.triple = Math.min(4, Game.triple+1)},
        {n:"Vampirism", d:"Cura ao matar", r:"c-inc", a:()=>Game.vamping++},
        {n:"Ricochete", d:"Balas quicam", r:"c-epi", a:()=>Game.ric++},
        {n:"Dual Wield", d:"2x Armas", r:"c-len", a:()=>Game.dual = true},
        {n:"Max HP", d:"+2 Corações", r:"c-com", a:()=>{Game.maxLives+=2; Game.lives+=2;}}
    ];
    for(let i=0; i<3; i++) {
        let u = pool[Math.floor(Math.random()*pool.length)];
        let d = document.createElement('div'); d.className = `card ${u.r}`;
        d.innerHTML = `<h3>${u.n}</h3><p>${u.d}</p>`;
        d.onclick = () => { u.a(); document.getElementById('card-screen').style.display='none'; Game.paused=false; };
        box.appendChild(d);
    }
}

// Mobile Controls
const jz = document.getElementById('joy-zone'), jb = document.getElementById('joy-bound'), js = document.getElementById('joy-stick');
jz.ontouchstart = (e) => { joy.active=true; let r=jb.getBoundingClientRect(); joy.sx=r.left+70; joy.sy=r.top+70; };
jz.ontouchmove = (e) => {
    if(!joy.active) return; let t=e.touches[0];
    let dx=t.clientX-joy.sx, dy=t.clientY-joy.sy;
    let d=Math.min(Math.hypot(dx,dy), 50); let a=Math.atan2(dy,dx);
    joy.x=(Math.cos(a)*d)/50; joy.y=(Math.sin(a)*d)/50;
    js.style.transform=`translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
};
jz.ontouchend = () => { joy.active=false; joy.x=0; joy.y=0; js.style.transform='translate(0,0)'; };

document.querySelectorAll('.atk-btn').forEach(b => {
    b.ontouchstart=()=>{ atkDir[b.dataset.dir]=true; }; b.ontouchend=()=>{ atkDir[b.dataset.dir]=false; };
});

function cycle() {
    const l = ['normal']; if(Game.hasFire) l.push('fire'); if(Game.hasShot) l.push('shotgun'); if(Game.hasStaff) l.push('staff');
    Game.weapon = l[(l.indexOf(Game.weapon)+1)%l.length]; p.reloading=false;
}
document.getElementById('swap-btn').onclick = cycle;
window.onkeydown = e => { keys.add(e.key.toLowerCase()); if(e.key==='q') cycle(); };
window.onkeyup = e => keys.delete(e.key.toLowerCase());

document.getElementById('btn-start').onclick = () => { Game.started=true; document.getElementById('start-screen').style.display='none'; initRoom(); draw(); };
function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
window.onresize = () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }; window.onresize();
</script>
</body>
</html>
