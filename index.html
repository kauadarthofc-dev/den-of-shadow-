<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow ðŸ’€</title>
    <style>
        :root {
            --c-comum: #3498db; --c-incomum: #2ecc71; --c-raro: #f1c40f; 
            --c-epico: #9b59b6; --c-lendario: linear-gradient(45deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
        }
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #05050a; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        canvas { display: block; image-rendering: pixelated; }

        /* UI Screens */
        .ui-screen { position: absolute; inset: 0; background: rgba(5, 5, 15, 0.98); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .title-box { border: 4px solid #fff; padding: 20px; border-radius: 15px; background: rgba(231, 76, 60, 0.1); margin-bottom: 20px; }
        .title-text { font-size: clamp(30px, 8vw, 60px); color: #e74c3c; margin: 0; text-transform: uppercase; letter-spacing: 5px; }
        .btn-main { padding: 15px 50px; background: #2ecc71; border: none; color: white; font-size: 22px; font-weight: bold; border-radius: 50px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px #1c8d4c; }

        /* HUD */
        #hud-top { position: absolute; top: 15px; left: 15px; pointer-events: none; z-index: 1000; }
        .hp-bar-container { width: 180px; height: 14px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 7px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: #ff4d6d; transition: 0.2s; }
        #ammo-hud { margin-top: 5px; font-weight: bold; font-size: 16px; color: #00eaff; text-shadow: 0 0 5px #000; }

        #minimap-container { position: absolute; top: 15px; right: 15px; width: 100px; height: 100px; background: rgba(0,0,0,0.8); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; }

        /* Mobile Controls */
        #mobile-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; width: 45px; height: 45px; background: #00eaff; border-radius: 50%; left: 32px; top: 32px; box-shadow: 0 0 15px #00eaff; }
        #atk-grid { position: absolute; bottom: 40px; right: 40px; display: grid; grid-template-columns: repeat(3, 70px); gap: 10px; pointer-events: auto; }
        .btn-atk { width: 70px; height: 70px; background: rgba(255,255,255,0.05); border: 2px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; }
        #swap-mob { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 100px; height: 45px; background: #f1c40f; border: 2px solid #fff; border-radius: 20px; pointer-events: auto; color: #000; font-weight: bold; display: flex; align-items: center; justify-content: center; }

        #weapon-tag { position: absolute; bottom: 200px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 2px solid #f1c40f; padding: 10px; border-radius: 8px; display: none; text-align: center; width: 200px; font-size: 13px; }
    </style>
</head>
<body>

<div id="hud-top">
    <div class="hp-bar-container"><div id="hp-fill"></div></div>
    <div id="ammo-hud">Iniciando...</div>
</div>

<div id="minimap-container">
    <canvas id="minimapCanvas" width="100" height="100"></canvas>
</div>

<div id="start-screen" class="ui-screen">
    <div class="title-box"><h1 class="title-text">Den of Shadow ðŸ’€</h1></div>
    <button class="btn-main" id="btn-play">ENTRAR NA MASMORRA</button>
</div>

<div id="upgrade-screen" class="ui-screen" style="display:none;">
    <h2 style="color:#f1c40f;">PODER ADQUIRIDO</h2>
    <div id="cards-container" style="display:flex; gap:15px;"></div>
</div>

<div id="weapon-tag"></div>
<canvas id="gameCanvas"></canvas>

<div id="mobile-hud">
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="atk-grid">
        <div></div><div class="btn-atk" data-dir="up">â–²</div><div></div>
        <div class="btn-atk" data-dir="left">â—€</div><div class="btn-atk" data-dir="down">â–¼</div><div class="btn-atk" data-dir="right">â–¶</div>
    </div>
    <div id="swap-mob">TROCAR ðŸ”„</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mCanvas = document.getElementById('minimapCanvas');
const mCtx = mCanvas.getContext('2d');
const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);

const G = {
    play: false, room: 0, w: 2400, h: 1800,
    hp: 12, maxHp: 12, weapon: 'magnum',
    inv: {
        magnum: { a: 20, m: 20, d: 15, c: "#00eaff", n: "Magnum", cd: 15, rld: 80 },
        fire: { a: 50, m: 50, d: 5, c: "#ff6a00", n: "LanÃ§a-Chamas", cd: 3, rld: 120 },
        shotgun: { a: 8, m: 8, d: 12, c: "#f1c40f", n: "Shotgun", cd: 45, rld: 100 },
        staff: { a: 15, m: 15, d: 8, c: "#9b59b6", n: "Cajado", cd: 25, rld: 90 }
    },
    owned: ['magnum']
};

let p = { 
    x: 1200, y: 900, r: 35, rot: 0, spd: 8, iframe: 0, t: 0, leg: 0,
    reloading: false, relTime: 0, lastShot: 0 
};
let enemies = [], projectiles = [], drops = [], pedestals = [], warns = [];
const keys = new Set();
const mobAtk = { up: false, down: false, left: false, right: false };
const joy = { active: false, x: 0, y: 0, sx: 0, sy: 0 };

function spawnRoom() {
    enemies = []; projectiles = []; drops = []; pedestals = []; warns = [];
    p.x = G.w/2; p.y = G.h/2;
    if(G.room === 0) return;

    if(G.room % 10 === 0) {
        enemies.push({ 
            type:'boss', x:G.w/2, y:400, hp:2500+G.room*150, max:2500+G.room*150, 
            r:130, t:0, state: 'idle', stateT: 0 
        });
    } else {
        let count = 6 + Math.floor(G.room/1.5);
        for(let i=0; i<count; i++) {
            let ex, ey;
            do { ex = 200+Math.random()*(G.w-400); ey = 200+Math.random()*(G.h-400); } while(Math.hypot(ex-p.x, ey-p.y)<600);
            enemies.push({ type: Math.random()<0.2?'kamikaze':'stalker', x:ex, y:ey, r:40, hp:100+G.room*20, hit:0 });
        }
    }
    if(G.room === 5 && !G.owned.includes('fire')) pedestals.push({x:G.w/2, y:300, type:'fire'});
    if(G.room === 12 && !G.owned.includes('shotgun')) pedestals.push({x:G.w/2, y:300, type:'shotgun'});
}

function update() {
    if(!G.play) return;

    // Recarregamento AutomÃ¡tico
    let w = G.inv[G.weapon];
    if(!p.reloading) {
        if(w.a <= 0 || (p.t - p.lastShot > 120 && w.a < w.m)) {
            p.reloading = true;
            p.relTime = 0;
        }
    } else {
        p.relTime++;
        if(p.relTime >= w.rld) {
            w.a = w.m;
            p.reloading = false;
        }
    }

    // Movimento
    let mx = joy.active ? joy.x : (keys.has('a')?-1:keys.has('d')?1:0);
    let my = joy.active ? joy.y : (keys.has('w')?-1:keys.has('s')?1:0);
    p.x = Math.max(80, Math.min(G.w-80, p.x + mx * p.spd));
    p.y = Math.max(80, Math.min(G.h-80, p.y + my * p.spd));

    // Tiro
    let ax = (keys.has('arrowleft')?-1:keys.has('arrowright')?1:0);
    let ay = (keys.has('arrowup')?-1:keys.has('arrowdown')?1:0);
    if(isMobile) { if(mobAtk.up) ay=-1; if(mobAtk.down) ay=1; if(mobAtk.left) ax=-1; if(mobAtk.right) ax=1; }

    if((ax || ay) && !p.reloading) {
        p.rot = Math.atan2(ay, ax);
        if(p.t % w.cd === 0 && w.a > 0) shoot(ax, ay);
    } else if(mx || my) {
        p.rot = Math.atan2(my, mx);
        p.leg += 0.25;
    }

    // IA Inimigos e Bosses Complexos
    enemies.forEach((e, i) => {
        let dist = Math.hypot(p.x-e.x, p.y-e.y);
        let ang = Math.atan2(p.y-e.y, p.x-e.x);

        if(e.type === 'boss') {
            e.stateT++;
            if(e.stateT > 150) { // Troca de fase a cada 2.5s
                const states = ['chase', 'meteors', 'spiral'];
                e.state = states[Math.floor(Math.random()*states.length)];
                e.stateT = 0;
            }

            if(e.state === 'chase') {
                e.x += Math.cos(ang) * 5; e.y += Math.sin(ang) * 5;
            } else if(e.state === 'meteors' && e.stateT % 30 === 0) {
                warns.push({x: p.x + (Math.random()-0.5)*200, y: p.y + (Math.random()-0.5)*200, t: 60});
            } else if(e.state === 'spiral' && e.stateT % 10 === 0) {
                let sAng = e.stateT * 0.2;
                projectiles.push({x:e.x, y:e.y, dx:Math.cos(sAng)*12, dy:Math.sin(sAng)*12, dmg:1, life:100, enemy:true});
            }
            e.x = Math.max(e.r, Math.min(G.w-e.r, e.x));
            e.y = Math.max(e.r, Math.min(G.h-e.r, e.y));
        } else {
            e.x += Math.cos(ang) * 3; e.y += Math.sin(ang) * 3;
        }

        if(dist < p.r + e.r && p.iframe <= 0) {
            G.hp -= (e.type==='kamikaze'?2:1); p.iframe = 60;
            if(e.type==='kamikaze') e.hp = 0;
        }
        if(e.hp <= 0) { if(e.type==='boss') showUpgrades(); enemies.splice(i, 1); }
    });

    // ProjÃ©teis e Avisos
    projectiles.forEach((pr, i) => {
        pr.x += pr.dx; pr.y += pr.dy; pr.life--;
        if(!pr.enemy) {
            enemies.forEach(e => {
                if(Math.hypot(pr.x-e.x, pr.y-e.y) < e.r+10) { e.hp -= pr.dmg; projectiles.splice(i, 1); }
            });
        } else if(Math.hypot(pr.x-p.x, pr.y-p.y) < p.r && p.iframe <= 0) {
            G.hp--; p.iframe = 60; projectiles.splice(i,1);
        }
        if(pr.life <= 0) projectiles.splice(i, 1);
    });

    warns.forEach((w, i) => {
        w.t--;
        if(w.t <= 0) {
            if(Math.hypot(p.x-w.x, p.y-w.y) < 100 && p.iframe <= 0) { G.hp-=2; p.iframe=60; }
            warns.splice(i, 1);
        }
    });

    if(enemies.length === 0 && Math.hypot(p.x-G.w/2, p.y-50) < 120) { G.room++; spawnRoom(); }
    if(p.iframe > 0) p.iframe--;
    p.t++;
    updateUI();
}

function shoot(ax, ay) {
    let w = G.inv[G.weapon];
    w.a--; p.lastShot = p.t;
    let ang = Math.atan2(ay, ax);
    if(G.weapon === 'shotgun') {
        for(let j=-1; j<=1; j++) projectiles.push({x:p.x, y:p.y, dx:Math.cos(ang+j*0.2)*20, dy:Math.sin(ang+j*0.2)*20, dmg:w.d, life:25});
    } else {
        projectiles.push({x:p.x, y:p.y, dx:Math.cos(ang)*22, dy:Math.sin(ang)*22, dmg:w.d, life:60});
    }
}

function updateUI() {
    document.getElementById('hp-fill').style.width = (G.hp/G.maxHp)*100 + "%";
    document.getElementById('ammo-hud').innerText = p.reloading ? "RECARREGANDO..." : `${G.inv[G.weapon].n}: ${G.inv[G.weapon].a}/${G.inv[G.weapon].m}`;
    
    mCtx.fillStyle = "rgba(0,0,0,0.8)"; mCtx.fillRect(0,0,100,100);
    let s = 100/G.w;
    mCtx.fillStyle = "#00eaff"; mCtx.fillRect(p.x*s, p.y*s, 4, 4);
    mCtx.fillStyle = "red"; enemies.forEach(e => mCtx.fillRect(e.x*s, e.y*s, 3, 3));
}

function draw() {
    ctx.fillStyle = "#05050a"; ctx.fillRect(0,0,canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-p.x + canvas.width/2, -p.y + canvas.height/2);

    // ChÃ£o Profissional
    ctx.fillStyle = "#0a0a15"; ctx.fillRect(0,0,G.w, G.h);
    ctx.strokeStyle = "rgba(255,255,255,0.05)";
    for(let i=0; i<G.w; i+=120) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,G.h); ctx.stroke(); }
    for(let i=0; i<G.h; i+=120) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(G.w,i); ctx.stroke(); }

    if(enemies.length === 0) { ctx.fillStyle = "#2ecc71"; ctx.fillRect(G.w/2-100, -10, 200, 30); }
    warns.forEach(w => { ctx.fillStyle = "rgba(255,0,0,0.3)"; ctx.beginPath(); ctx.arc(w.x, w.y, 100, 0, 7); ctx.fill(); });

    // Inimigos
    enemies.forEach(e => {
        ctx.fillStyle = e.type==='boss'?'#9b59b6':(e.type==='kamikaze'?'#e74c3c':'#34495e');
        ctx.fillRect(e.x-e.r, e.y-e.r, e.r*2, e.r*2);
        if(e.type==='boss') {
            ctx.fillStyle = "red"; ctx.fillRect(e.x-100, e.y-e.r-30, (e.hp/e.max)*200, 15);
        }
    });

    // LORD DA LUZ (Visual original)
    ctx.save();
    ctx.translate(p.x, p.y);
    let ly = Math.sin(p.leg)*12;
    ctx.fillStyle = "#fff"; ctx.fillRect(-22, 25+ly, 12, 18); ctx.fillRect(10, 25-ly, 12, 18);
    ctx.shadowBlur = 25; ctx.shadowColor = "#00eaff";
    ctx.fillStyle = (p.iframe>0 && p.t%4<2)?"#ff4d6d":"#fff";
    ctx.fillRect(-35, -40, 70, 75);
    ctx.shadowBlur = 0;
    // Barra de Recarga Circular
    if(p.reloading) {
        ctx.strokeStyle = "#00eaff"; ctx.lineWidth = 5;
        ctx.beginPath(); ctx.arc(0, 0, 50, 0, (p.relTime/G.inv[G.weapon].rld)*Math.PI*2); ctx.stroke();
    }
    // Arma
    ctx.rotate(p.rot); ctx.fillStyle = "#333"; ctx.fillRect(25, -8, 40, 16);
    ctx.restore();

    projectiles.forEach(pr => {
        ctx.fillStyle = pr.enemy ? "red" : G.inv[G.weapon].c;
        ctx.beginPath(); ctx.arc(pr.x, pr.y, 12, 0, 7); ctx.fill();
    });

    ctx.restore();
    if(G.play) requestAnimationFrame(draw);
}

// Upgrades, Inputs e Resize mantidos para suporte Mobile/Console
function showUpgrades() {
    G.play = false; document.getElementById('upgrade-screen').style.display = 'flex';
    const cont = document.getElementById('cards-container'); cont.innerHTML = '';
    const ups = [{n:"VIDA", d:"+4 HP MÃ¡ximo", a:()=>{G.maxHp+=4; G.hp+=4;}}, {n:"DANO", d:"+5 Dano Global", a:()=>{for(let k in G.inv) G.inv[k].d+=5;}}];
    ups.forEach(u => {
        let d = document.createElement('div'); d.className = 'btn-main'; d.innerHTML = `<b>${u.n}</b><br>${u.d}`;
        d.onclick = () => { u.a(); document.getElementById('upgrade-screen').style.display='none'; G.play=true; draw(); };
        cont.appendChild(d);
    });
}

function swap() { let idx = G.owned.indexOf(G.weapon); G.weapon = G.owned[(idx+1)%G.owned.length]; p.reloading = false; }
document.getElementById('swap-mob').onclick = swap;
window.onkeydown = e => { keys.add(e.key.toLowerCase()); if(e.key==='q') swap(); };
window.onkeyup = e => keys.delete(e.key.toLowerCase());

if(isMobile) {
    document.getElementById('mobile-hud').style.display = 'block';
    const b = document.getElementById('joy-base'), s = document.getElementById('joy-stick');
    b.ontouchstart = e => { joy.active=true; let r=b.getBoundingClientRect(); joy.sx=r.left+55; joy.sy=r.top+55; };
    b.ontouchmove = e => {
        if(!joy.active) return; let t=e.touches[0];
        let dx=t.clientX-joy.sx, dy=t.clientY-joy.sy;
        let d=Math.min(Math.hypot(dx,dy), 45); let a=Math.atan2(dy,dx);
        joy.x=(Math.cos(a)*d)/45; joy.y=(Math.sin(a)*d)/45;
        s.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    };
    b.ontouchend = () => { joy.active=false; joy.x=0; joy.y=0; s.style.transform='none'; };
    document.querySelectorAll('.btn-atk').forEach(btn => {
        btn.ontouchstart = () => mobAtk[btn.dataset.dir] = true;
        btn.ontouchend = () => mobAtk[btn.dataset.dir] = false;
    });
}

document.getElementById('btn-play').onclick = () => { G.play=true; document.getElementById('start-screen').
