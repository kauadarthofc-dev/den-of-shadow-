<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow üíÄ Definitive Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&family=Special+Elite&display=swap');
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { display: block; }
        
        #hud { position: absolute; top: 20px; left: 20px; z-index: 1000; }
        .stat-bar { width: 200px; height: 12px; background: #222; border: 1px solid #444; margin: 5px 0; border-radius: 6px; overflow: hidden; }
        .fill { height: 100%; transition: width 0.3s; }
        
        /* Minimapa */
        #minimap-container { 
            position: absolute; top: 20px; right: 20px; 
            width: 150px; height: 150px; 
            background: rgba(0,0,0,0.8); border: 2px solid #ff0000; 
            z-index: 1000; overflow: hidden;
        }
        #minimap-player { position: absolute; width: 6px; height: 6px; background: #fff; border-radius: 50%; }

        .ui-screen { position: absolute; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .upgrade-card { background: #111; border: 2px solid #444; padding: 20px; margin: 10px; cursor: pointer; transition: 0.3s; width: 200px; }
        .upgrade-card:hover { border-color: gold; transform: scale(1.1); }
    </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
    <h1 style="font-family:'Nosifer'; color:red;">DEN OF SHADOW</h1>
    <button onclick="startGame()" style="background:none; border:2px solid red; color:white; padding:10px 30px; cursor:pointer; font-family:'Orbitron';">JOGAR</button>
</div>

<div id="upgrade-screen" class="ui-screen" style="display:none;">
    <h2 style="color:gold">UPGRADES LEND√ÅRIOS</h2>
    <div id="upgrade-list" style="display:flex;"></div>
</div>

<div id="hud">
    VIDA <div class="stat-bar"><div id="hp-fill" class="fill" style="width:100%; background:red;"></div></div>
    ENERGIA <div class="stat-bar"><div id="ammo-fill" class="fill" style="width:100%; background:gold;"></div></div>
    <div id="wpn-name" style="color:red; font-weight:bold;">ESPADA DO REI</div>
    <div id="room-txt">ANDAR: 1</div>
</div>

<div id="minimap-container">
    <div id="minimap-player"></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const ROOM_SIZE = 2000; // Tamanho de cada sala quadrada
const G = {
    play: false, room: 1, hp: 100, ammo: 30, maxAmmo: 30,
    curWpn: 0, unlockedWeapons: [0, 1],
    rooms: {}, lastShot: 0
};

const weapons = [
    { name: "ESPADA DO REI", type: "melee", color: "#9932CC", dmg: 100, rate: 300 },
    { name: "LUZ", type: "range", color: "#fff", dmg: 35, rate: 200, spd: 18 },
    { name: "FOGO", type: "range", color: "#ff4500", dmg: 90, rate: 450, spd: 12 }
];

let player = { x: 1000, y: 1000, r: 25, spd: 8, angle: 0 };
let current = { enemies: [], projectiles: [], items: [], visuals: [], doors: [] };
const keys = {};

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    G.play = true;
    initRoom(1);
}

function initRoom(id) {
    if(G.rooms[G.room]) G.rooms[G.room] = {...current}; // Salva progresso da sala atual
    
    G.room = id;
    document.getElementById('room-txt').innerText = "ANDAR: " + G.room;

    if(G.rooms[id]) {
        current = G.rooms[id];
    } else {
        current = {
            enemies: [], projectiles: [], items: [], visuals: [],
            cleared: false,
            doors: [
                { x: ROOM_SIZE/2 - 75, y: 0, w: 150, h: 50, to: id + 1, active: false, label: "PR√ìXIMO" },
                { x: ROOM_SIZE/2 - 75, y: ROOM_SIZE-50, w: 150, h: 50, to: Math.max(1, id - 1), active: true, label: "VOLTAR" }
            ]
        };

        // Gerar Inimigos
        let count = 3 + Math.floor(id/2);
        if(id % 10 === 0) {
            current.enemies.push({ x: 1000, y: 500, hp: 1000 + id*50, r: 80, isBoss: true, spd: 3 });
        } else {
            for(let i=0; i<count; i++) {
                current.enemies.push({ x: Math.random()*1600+200, y: Math.random()*1600+200, hp: 50 + id*10, r: 30, spd: 2 + (id*0.1) });
            }
        }

        // Drop Magia de Fogo no 5
        if(id === 5) current.items.push({ x: 1000, y: 1000, type: 'weapon', id: 2, label: "FOGO" });

        G.rooms[id] = current;
    }
    // Posiciona player ao entrar
    player.x = 1000; player.y = 1800;
}

function update() {
    if(!G.play) return;

    // Movimento com colis√£o de parede
    let mx = 0, my = 0;
    if(keys['w']) my = -1; if(keys['s']) my = 1; if(keys['a']) mx = -1; if(keys['d']) mx = 1;
    
    player.x = Math.max(50, Math.min(ROOM_SIZE-50, player.x + mx * player.spd));
    player.y = Math.max(50, Math.min(ROOM_SIZE-50, player.y + my * player.spd));

    // Minimapa
    const mmP = document.getElementById('minimap-player');
    mmP.style.left = (player.x / ROOM_SIZE * 100) + "%";
    mmP.style.top = (player.y / ROOM_SIZE * 100) + "%";

    // Combate
    let ax = 0, ay = 0;
    if(keys['arrowup']) ay = -1; if(keys['arrowdown']) ay = 1; if(keys['arrowleft']) ax = -1; if(keys['arrowright']) ax = 1;
    if(ax || ay) player.angle = Math.atan2(ay, ax);

    const w = weapons[G.curWpn];
    if((ax || ay) && Date.now() - G.lastShot > w.rate) {
        if(w.type === "range" && G.ammo > 0) {
            current.projectiles.push({ 
                x: player.x, y: player.y, 
                vx: Math.cos(player.angle) * w.spd, 
                vy: Math.sin(player.angle) * w.spd, 
                color: w.color, dmg: w.dmg 
            });
            G.ammo--;
        } else if(w.type === "melee") {
            // ANIMA√á√ÉO DA ESPADA
            current.visuals.push({ type: 'slash', x: player.x, y: player.y, ang: player.angle, life: 12, color: w.color });
            current.enemies.forEach(en => {
                if(Math.hypot(en.x - player.x, en.y - player.y) < 160) {
                    en.hp -= w.dmg;
                    en.x += Math.cos(player.angle) * 60;
                }
            });
        }
        G.lastShot = Date.now();
    }

    // F√≠sica dos Proj√©teis
    current.projectiles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy;
        if(p.x < 0 || p.x > ROOM_SIZE || p.y < 0 || p.y > ROOM_SIZE) current.projectiles.splice(i, 1);
        current.enemies.forEach(en => {
            if(Math.hypot(p.x-en.x, p.y-en.y) < en.r) {
                en.hp -= p.dmg;
                current.projectiles.splice(i, 1);
            }
        });
    });

    // IA Inimigos
    current.enemies.forEach((en, i) => {
        let dist = Math.hypot(player.x-en.x, player.y-en.y);
        let ang = Math.atan2(player.y-en.y, player.x-en.x);
        en.x += Math.cos(ang) * en.spd; en.y += Math.sin(ang) * en.spd;
        if(dist < player.r + en.r) G.hp -= 0.5;
        if(en.hp <= 0) current.enemies.splice(i, 1);
    });

    // Portas e Itens
    if(current.enemies.length === 0) current.doors.forEach(d => d.active = true);
    current.doors.forEach(d => {
        if(d.active && Math.hypot(player.x - (d.x+d.w/2), player.y - (d.y+d.h/2)) < 80) initRoom(d.to);
    });

    current.items.forEach((it, i) => {
        if(Math.hypot(player.x-it.x, player.y-it.y) < 60) {
            if(it.type === 'weapon') G.unlockedWeapons.push(it.id);
            current.items.splice(i, 1);
        }
    });

    current.visuals.forEach((v, i) => { v.life--; if(v.life <= 0) current.visuals.splice(i, 1); });
    if(G.ammo < G.maxAmmo) G.ammo += 0.05;
}

function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    if(!G.play) { requestAnimationFrame(draw); return; }
    update();

    ctx.save();
    ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);

    // Paredes da Sala
    ctx.fillStyle = "#111"; ctx.fillRect(0,0,ROOM_SIZE, ROOM_SIZE);
    ctx.strokeStyle = "red"; ctx.lineWidth = 10; ctx.strokeRect(0,0,ROOM_SIZE, ROOM_SIZE);

    // Portas
    current.doors.forEach(d => {
        ctx.fillStyle = d.active ? "#0f0" : "#400";
        ctx.fillRect(d.x, d.y, d.w, d.h);
        ctx.fillStyle = "#fff"; ctx.fillText(d.label, d.x, d.y-10);
    });

    // Inimigos
    current.enemies.forEach(en => {
        ctx.fillStyle = en.isBoss ? "purple" : "red";
        ctx.beginPath(); ctx.arc(en.x, en.y, en.r, 0, Math.PI*2); ctx.fill();
    });

    // Anima√ß√£o Espada
    current.visuals.forEach(v => {
        ctx.strokeStyle = v.color; ctx.lineWidth = 8; ctx.beginPath();
        ctx.arc(v.x, v.y, 100, v.ang-1, v.ang+1); ctx.stroke();
    });

    // Proj√©teis
    current.projectiles.forEach(p => {
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
    });

    // Player
    ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();

    ctx.restore();

    document.getElementById('hp-fill').style.width = G.hp + "%";
    document.getElementById('ammo-fill').style.width = (G.ammo/G.maxAmmo*100) + "%";
    document.getElementById('wpn-name').innerText = weapons[G.curWpn].name;

    requestAnimationFrame(draw);
}

window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if(e.key.toLowerCase() === 'q') G.curWpn = G.unlockedWeapons[(G.unlockedWeapons.indexOf(G.curWpn)+1)%G.unlockedWeapons.length];
});
window.addEventListener('keyup', e => delete keys[e.key.toLowerCase()]);
draw();
</script>
</body>
</html>
