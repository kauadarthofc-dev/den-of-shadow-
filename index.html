<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Den of Shadow Corrigido</title>
    <style>
        /* CSS para manter o jogo centralizado e responsivo */
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #hud {
            position: absolute; top: 20px; left: 20px; color: white;
            pointer-events: none; text-shadow: 2px 2px #000;
        }

        /* Botão de troca para Mobile */
        #mobile-swap {
            position: absolute; bottom: 40px; right: 40px;
            width: 80px; height: 80px; background: rgba(255,0,0,0.3);
            border: 2px solid #ff4500; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="hud">
    <div>SALA: <span id="room-txt">1</span></div>
    <div>ARMA: <span id="weapon-txt" style="color: #fff;">LUZ</span></div>
    <div style="font-size: 12px; opacity: 0.7;">[Q] Trocar | [Espaço] Atacar | Analógico Console</div>
</div>

<div id="mobile-swap" onclick="swapWeapon()">SWAP</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Configurações do Mundo e Player
let ROOM_W = 2000;
let ROOM_H = 2000;
const G = {
    play: true,
    curWpn: 0,
    unlockedWeapons: [0, 1, 2], // 0: Luz, 1: Fogo, 2: Espada do Rei
    weapons: [
        { name: "LUZ", type: 'range', color: "#fff", dmg: 40, rate: 200 },
        { name: "FOGO", type: 'range', color: "#ff4500", dmg: 80, rate: 400 },
        { name: "REI", type: 'melee', color: "#9932CC", dmg: 150, rate: 500 }
    ],
    lastShot: 0
};

let player = { x: 1000, y: 1000, r: 25, spd: 7, angle: 0 };
let camera = { x: 0, y: 0 };
let keys = {};
let projectiles = [];
let enemies = [{x: 1200, y: 1200, r: 30, hp: 100}]; // Inimigo de teste

// --- INPUTS (MOBILE, CONSOLE, PC) ---
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => {
    if(e.key.toLowerCase() === 'q') swapWeapon(); // Troca no Q
    keys[e.key.toLowerCase()] = false;
});

function swapWeapon() {
    let currentIdx = G.unlockedWeapons.indexOf(G.curWpn);
    G.curWpn = G.unlockedWeapons[(currentIdx + 1) % G.unlockedWeapons.length];
    
    const w = G.weapons[G.curWpn];
    document.getElementById('weapon-txt').innerText = w.name;
    document.getElementById('weapon-txt').style.color = w.color;
}

function update() {
    if(!G.play) return;

    // Movimentação (Suporte a Console via Gamepad API)
    const gp = navigator.getGamepads()[0];
    let mx = 0, my = 0;

    if(keys['w'] || (gp && gp.axes[1] < -0.2)) my = -1;
    if(keys['s'] || (gp && gp.axes[1] > 0.2)) my = 1;
    if(keys['a'] || (gp && gp.axes[0] < -0.2)) mx = -1;
    if(keys['d'] || (gp && gp.axes[0] > 0.2)) mx = 1;

    if(mx !== 0 || my !== 0) {
        player.x += mx * player.spd;
        player.y += my * player.spd;
    }

    // --- CORREÇÃO DA CÂMERA (CENTRALIZAÇÃO TOTAL) ---
    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;

    // Lógica de Ataque (Espaço ou Botão Console)
    if(keys[' '] || (gp && gp.buttons[0].pressed)) {
        attack();
    }
}

function attack() {
    const w = G.weapons[G.curWpn];
    if(Date.now() - G.lastShot < w.rate) return;

    if(w.type === 'range') {
        projectiles.push({ x: player.x, y: player.y, vx: 10, vy: 0, r: 10, color: w.color });
    } else {
        // ATAQUE DA ESPADA (Visual e Dano)
        player.isAttacking = 10; // Frames de animação
        enemies.forEach(en => {
            let dist = Math.hypot(en.x - player.x, en.y - player.y);
            if(dist < 100) en.hp -= w.dmg; // Alcance da espada
        });
    }
    G.lastShot = Date.now();
}

function draw() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    // APLICA A CÂMERA
    ctx.translate(-camera.x, -camera.y);

    // Desenha Chão (Grid)
    ctx.strokeStyle = "#220000";
    for(let i=0; i<ROOM_W; i+=100) {
        ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, ROOM_H); ctx.stroke();
    }

    // Desenha Inimigos
    enemies.forEach(en => {
        if(en.hp > 0) {
            ctx.fillStyle = "red";
            ctx.beginPath(); ctx.arc(en.x, en.y, en.r, 0, Math.PI*2); ctx.fill();
        }
    });

    // --- DESENHA PLAYER E ESPADA ---
    ctx.fillStyle = "white";
    ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();

    if(G.weapons[G.curWpn].name === "REI") {
        ctx.strokeStyle = G.weapons[G.curWpn].color;
        ctx.lineWidth = 8;
        ctx.beginPath();
        // A espada agora aparece como um arco ao redor do player
        ctx.arc(player.x, player.y, 60, -0.5, 0.5);
        ctx.stroke();
    }

    ctx.restore();

    update();
    requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
