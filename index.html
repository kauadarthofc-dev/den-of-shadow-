<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fox of Isaac: Den of Shadows</title>
    <style>
        * { touch-action: none !important; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        html, body { background: #000; margin: 0; padding: 0; overflow: hidden; height: 100%; width: 100%; position: fixed; font-family: 'Courier New', monospace; color: #fff; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn-ui { padding: 20px 40px; border: 4px solid #ff4d6d; background: #111; color: #fff; font-size: 20px; font-weight: bold; border-radius: 12px; cursor: pointer; }
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        .mobile-ctrl { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1500; }
        #joy-bound { position: absolute; bottom: 15%; left: 8%; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; left: 35px; top: 35px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.4; }
        #shoot-ctrl { position: absolute; bottom: 15%; right: 8%; display: grid; grid-template-columns: repeat(3, 70px); gap: 10px; pointer-events: auto; }
        .atk-btn { width: 70px; height: 70px; background: rgba(52,152,219,0.1); border: 2px solid #3498db; border-radius: 50%; color: #3498db; display: flex; justify-content: center; align-items: center; font-size: 24px; }
        #swap-btn { position: absolute; bottom: 45%; right: 8%; width: 80px; height: 70px; background: rgba(241, 196, 15, 0.2); border: 3px solid #f1c40f; border-radius: 15px; color: #f1c40f; display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; pointer-events: auto; }
    </style>
</head>
<body>

<div id="start-screen" class="overlay">
    <h1 style="color:#ff4d6d; font-size:40px; text-shadow:0 0 20px red;">FOX OF ISAAC</h1>
    <div class="btn-ui" id="btn-start">DESCER AO COVIL</div>
</div>

<div id="death-screen" class="overlay" style="display:none;">
    <h1 style="color:red;">FIM DA JORNADA</h1>
    <div class="btn-ui" onclick="location.reload()">RECOMEÇAR</div>
</div>

<div id="game-container">
    <canvas id="game"></canvas>
    <div id="mobile-ui" class="mobile-ctrl">
        <div id="joy-bound"><div id="joy-stick"></div></div>
        <div id="shoot-ctrl">
            <div></div><div class="atk-btn" data-dir="up">▲</div><div></div>
            <div class="atk-btn" data-dir="left">◀</div><div class="atk-btn" data-dir="down">▼</div><div class="atk-btn" data-dir="right">▶</div>
        </div>
        <div id="swap-btn">ARMA</div>
    </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

const Game = { 
    started: false, paused: false, room: 0, roomW: 1000, roomH: 800, 
    camX: 0, camY: 0, lives: 6, maxLives: 6, weapon: 'normal', 
    hasFire: false, hasAcid: false, version: "v1.5.0",
    ammo: 5, maxAmmo: 5, reloading: false, reloadTimer: 0,
    doorPos: { x: 0, y: 0, side: 'top', open: false }
};

const Weapons = {
    normal: { dmg: 10, max: 5, color: "#0ff", name: "MAGNUM" },
    fire: { dmg: 15, max: 15, color: "#ff4500", name: "FOGO" },
    acid: { dmg: 20, max: 20, color: "#32cd32", name: "ÁCIDO" }
};

const Stats = { moveSpd: 4.8, atkSpd: 15 };
const keys = new Set();
let enemies = [], projectiles = [], particles = [], pools = [], pedestal = null;
let p = { x: 500, y: 400, iframe: 0, timer: 0, dead: false };

let audioCtx = null;
function playSfx(f, type, dur, vol=0.1) {
    if(!audioCtx) return;
    try {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    } catch(e){}
}

function explode(x, y, color, count=15) {
    for(let i=0; i<count; i++) {
        particles.push({ x, y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, life:1, color, size:Math.random()*4+2 });
    }
}

function randomizeDoor() {
    const sides = ['top', 'bottom', 'left', 'right'];
    Game.doorPos.side = sides[Math.floor(Math.random() * sides.length)];
    Game.doorPos.open = false;
    if(Game.doorPos.side === 'top') { Game.doorPos.x = Game.roomW/2 - 50; Game.doorPos.y = 0; }
    else if(Game.doorPos.side === 'bottom') { Game.doorPos.x = Game.roomW/2 - 50; Game.doorPos.y = Game.roomH - 15; }
    else if(Game.doorPos.side === 'left') { Game.doorPos.x = 0; Game.doorPos.y = Game.roomH/2 - 50; }
    else if(Game.doorPos.side === 'right') { Game.doorPos.x = Game.roomW - 15; Game.doorPos.y = Game.roomH/2 - 50; }
}

function cycleWeapon() {
    if(!Game.hasFire && !Game.hasAcid) return;
    if(Game.weapon === 'normal') Game.weapon = Game.hasFire ? 'fire' : 'acid';
    else if(Game.weapon === 'fire') Game.weapon = Game.hasAcid ? 'acid' : 'normal';
    else Game.weapon = 'normal';
    Game.maxAmmo = Weapons[Game.weapon].max;
    Game.ammo = Game.maxAmmo;
    Game.reloading = false;
    playSfx(400, 'triangle', 0.1);
}

function drawUI() {
    // 1. Barra de Vida (Hexágonos) - Canto Superior Esquerdo
    for(let i=0; i<Game.maxLives; i++) {
        let x = 35 + i * 42;
        let y = 35;
        ctx.fillStyle = i < Game.lives ? "#ff4d6d" : "#222";
        ctx.beginPath();
        for(let a=0; a<6; a++) ctx.lineTo(x + 16 * Math.cos(a * Math.PI/3), y + 16 * Math.sin(a * Math.PI/3));
        ctx.closePath(); ctx.fill();
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
    }

    // 2. Munição (ABAIXO DA VIDA)
    const wInfo = Weapons[Game.weapon];
    ctx.textAlign = "left";
    ctx.fillStyle = "#fff";
    ctx.font = "bold 14px Courier New";
    ctx.fillText(wInfo.name, 20, 75);
    
    ctx.fillStyle = "#333";
    ctx.fillRect(20, 85, 120, 10);
    ctx.fillStyle = Game.reloading ? "#f1c40f" : wInfo.color;
    ctx.fillRect(20, 85, (Game.ammo / Game.maxAmmo) * 120, 10);
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 1; ctx.strokeRect(20, 85, 120, 10);
    
    // 3. Minimapa (Canto Superior Direito)
    const mapS = 100;
    const mapX = canvas.width - mapS - 20;
    const mapY = 20;
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(mapX, mapY, mapS, mapS);
    ctx.strokeStyle = "rgba(255,255,255,0.3)";
    ctx.strokeRect(mapX, mapY, mapS, mapS);
    
    // Porta no mapa
    if(!Game.doorPos.open) ctx.fillStyle = "rgba(241,196,15,0.5)";
    else ctx.fillStyle = "#f1c40f";
    ctx.fillRect(mapX + (Game.doorPos.x/Game.roomW)*mapS, mapY + (Game.doorPos.y/Game.roomH)*mapS, 8, 8);

    // Jogador no mapa
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(mapX + (p.x/Game.roomW)*mapS, mapY + (p.y/Game.roomH)*mapS, 3, 0, Math.PI*2);
    ctx.fill();

    // 4. Sala e Versão
    ctx.textAlign = "center";
    ctx.font = "bold 20px Courier New";
    ctx.fillStyle = "#fff";
    ctx.fillText(`SALA ${Game.room}`, canvas.width/2, 35);
    
    ctx.font = "10px Arial"; ctx.textAlign = "right";
    ctx.fillText(Game.version, canvas.width - 10, canvas.height - 10);
}

// Loop Principal e Lógica de Jogo
function loop() {
    if(!Game.started || Game.paused) return requestAnimationFrame(loop);
    ctx.clearRect(0,0, canvas.width, canvas.height);
    
    ctx.save();
    Game.camX += (p.x - canvas.width/2 - Game.camX) * 0.1;
    Game.camY += (p.y - canvas.height/2 - Game.camY) * 0.1;
    ctx.translate(-Game.camX, -Game.camY);

    // Chão
    ctx.fillStyle = "#0a0a0a"; ctx.fillRect(-500,-500,Game.roomW+1000,Game.roomH+1000);
    ctx.strokeStyle = "#222"; ctx.lineWidth = 2;
    for(let x=0; x<Game.roomW; x+=100) for(let y=0; y<Game.roomH; y+=100) ctx.strokeRect(x,y,100,100);

    // Poças de Ácido (Dano nos Inimigos)
    pools.forEach((po, i) => {
        ctx.fillStyle = "rgba(50, 205, 50, 0.3)";
        ctx.beginPath(); ctx.arc(po.x, po.y, po.r, 0, Math.PI*2); ctx.fill();
        enemies.forEach(e => {
            if(Math.hypot(e.x-po.x, e.y-po.y) < po.r && p.timer % 20 === 0) { e.hp -= 3; e.hit = 3; }
        });
        po.life--; if(po.life <= 0) pools.splice(i,1);
    });

    // Porta
    if(enemies.length === 0 && !pedestal) {
        Game.doorPos.open = true;
        ctx.fillStyle = "#f1c40f";
        ctx.fillRect(Game.doorPos.x, Game.doorPos.y, 
            (Game.doorPos.side==='top'||Game.doorPos.side==='bottom'?100:15), 
            (Game.doorPos.side==='left'||Game.doorPos.side==='right'?100:15));
        
        let inDoor = false;
        if(Game.doorPos.side==='top' && p.y < 20 && Math.abs(p.x - Game.roomW/2) < 50) inDoor = true;
        if(Game.doorPos.side==='bottom' && p.y > Game.roomH-40 && Math.abs(p.x - Game.roomW/2) < 50) inDoor = true;
        if(Game.doorPos.side==='left' && p.x < 20 && Math.abs(p.y - Game.roomH/2) < 50) inDoor = true;
        if(Game.doorPos.side==='right' && p.x > Game.roomW-40 && Math.abs(p.y - Game.roomH/2) < 50) inDoor = true;
        if(inDoor) { Game.room++; initRoom(); }
    }

    // Player
    if(!p.dead) {
        let moveX = (keys.has('a')?-1:keys.has('d')?1:0);
        let moveY = (keys.has('w')?-1:keys.has('s')?1:0);
        p.x = Math.max(10, Math.min(Game.roomW-35, p.x + moveX * Stats.moveSpd));
        p.y = Math.max(10, Math.min(Game.roomH-35, p.y + moveY * Stats.moveSpd));
        if(p.iframe > 0) p.iframe--;
        ctx.fillStyle = p.iframe%4<2?"#fff":"#ff4d6d"; ctx.fillRect(p.x, p.y, 25, 25);
        
        p.timer++;
        if(Game.reloading) {
            Game.reloadTimer++;
            if(Game.reloadTimer > 50) { Game.ammo = Game.maxAmmo; Game.reloading = false; Game.reloadTimer = 0; }
        }
        let sX = (keys.has('arrowleft')?-1:keys.has('arrowright')?1:0);
        let sY = (keys.has('arrowup')?-1:keys.has('arrowdown')?1:0);
        if((sX || sY) && p.timer % Stats.atkSpd === 0 && !Game.reloading) {
            projectiles.push({x:p.x+10, y:p.y+10, dx:sX, dy:sY, type:Game.weapon, owner:'player'});
            Game.ammo--; if(Game.ammo <= 0) Game.reloading = true;
            playSfx(200, 'square', 0.05);
        }
    }

    // Inimigos (Atirador, Kamikaze, Perseguidor, Assassino)
    enemies.forEach((e, i) => {
        let ang = Math.atan2(p.y-e.y, p.x-e.x);
        let d = Math.hypot(p.y-e.y, p.x-e.x);
        let spd = e.type==='kamikaze'?2.8:e.type==='assassin'?3.2:2;
        e.x += Math.cos(ang)*spd; e.y += Math.sin(ang)*spd;

        if(e.type === 'shooter' && d < 300) { e.shootTimer++; if(e.shootTimer%80===0) projectiles.push({x:e.x+15, y:e.y+15, dx:Math.cos(ang), dy:Math.sin(ang), type:'normal', owner:'enemy'}); }
        
        ctx.fillStyle = e.hit > 0 ? "#fff" : (e.type==='kamikaze'?"#f1c40f":e.type==='assassin'?"#8e44ad":"#3498db");
        if(e.hit>0) e.hit--; ctx.fillRect(e.x, e.y, e.w, e.h);

        if(p.iframe <= 0 && d < 28) {
            if(e.type === 'kamikaze') { Game.lives -= 2; explode(e.x, e.y, "#f1c40f", 30); enemies.splice(i,1); }
            else { Game.lives -= 1; } p.iframe = 60;
        }
        if(e.hp <= 0) { explode(e.x, e.y, ctx.fillStyle, 20); enemies.splice(i,1); }
    });

    // Projéteis
    projectiles.forEach((pr, i) => {
        pr.x += pr.dx*9; pr.y += pr.dy*9;
        ctx.fillStyle = Weapons[pr.type]?.color || "#f00"; ctx.fillRect(pr.x, pr.y, 10, 10);
        if(pr.owner === 'player') {
            enemies.forEach(e => {
                if(pr.x > e.x && pr.x < e.x+e.w && pr.y > e.y && pr.y < e.y+e.h) {
                    e.hp -= Weapons[pr.type].dmg;
                    if(pr.type === 'acid') pools.push({x: pr.x, y: pr.y, r: 45, life: 200});
                    e.hit = 5; projectiles.splice(i,1);
                }
            });
        } else if(Math.hypot(pr.x-p.x, pr.y-p.y) < 22 && p.iframe <= 0) { Game.lives--; p.iframe = 60; projectiles.splice(i,1); }
        if(pr.x<0||pr.x>Game.roomW||pr.y<0||pr.y>Game.roomH) projectiles.splice(i,1);
    });

    // Partículas
    particles.forEach((pt, i) => { pt.x += pt.vx; pt.y += pt.vy; pt.life -= 0.03; ctx.globalAlpha = pt.life; ctx.fillStyle = pt.color; ctx.fillRect(pt.x, pt.y, 4, 4); if(pt.life <= 0) particles.splice(i,1); });
    ctx.globalAlpha = 1;

    // Pedestais
    if(pedestal) {
        ctx.fillStyle = pedestal.type==='fire'?"#ff4500":"#32cd32";
        ctx.fillRect(pedestal.x-15, pedestal.y-15, 30, 30);
        if(Math.hypot(p.x-pedestal.x, p.y-pedestal.y) < 35) { if(pedestal.type==='fire') Game.hasFire=true; else Game.hasAcid=true; pedestal=null; }
    }

    ctx.restore();
    drawUI(); // Renderiza UI por cima de tudo

    if(Game.lives <= 0) { Game.started = false; document.getElementById('death-screen').style.display='flex'; }
    requestAnimationFrame(loop);
}

// Controles e Inicialização
window.addEventListener('keydown', e => keys.add(e.key.toLowerCase()));
window.addEventListener('keyup', e => keys.delete(e.key.toLowerCase()));
document.getElementById('btn-start').onclick = () => { audioCtx = new AudioContext(); Game.started = true; document.getElementById('start-screen').style.display = 'none'; if(isMobile) document.getElementById('mobile-ui').style.display = 'block'; initRoom(); loop(); };

function initRoom() {
    enemies = []; projectiles = []; pools = []; pedestal = null;
    randomizeDoor();
    p.x = Game.roomW/2; p.y = Game.roomH/2;
    if(Game.room === 5 && !Game.hasFire) pedestal = { type: 'fire', x: Game.roomW/2, y: Game.roomH/2 };
    if(Game.room === 15 && !Game.hasAcid) pedestal = { type: 'acid', x: Game.roomW/2, y: Game.roomH/2 };
    if(Game.room > 0) {
        for(let i=0; i<4+Math.floor(Game.room/2); i++) {
            let r = Math.random();
            enemies.push({ type: r<0.2?'kamikaze':r<0.4?'shooter':r<0.7?'stalker':'assassin', x:Math.random()*Game.roomW, y:Math.random()*Game.roomH, hp:40+Game.room*5, w:30, h:30, hit:0, shootTimer:0 });
        }
    }
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.onresize = resize; resize();
</script>
</body>
</html>
