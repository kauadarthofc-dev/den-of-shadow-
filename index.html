<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
Â  Â  <title>Den of Shadow ğŸ’€ V2.3</title>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&display=swap');
Â  Â  Â  Â  * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
Â  Â  Â  Â  body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; width: 100vw; height: 100vh; }
Â  Â  Â  Â  canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; cursor: crosshair; }

Â  Â  Â  Â  .ui-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
Â  Â  Â  Â  .glass-panel { background: #110000; border: 2px solid #f00; padding: 20px; width: 95%; max-width: 600px; border-radius: 8px; box-shadow: 0 0 20px #f00; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* BotÃµes de Save */
Â  Â  Â  Â  .save-slot-container { position: relative; margin: 8px 0; }
Â  Â  Â  Â  .btn-main { padding: 15px; background: #300; border: 1px solid #f00; color: #fff; cursor: pointer; width: 100%; font-family: 'Orbitron'; font-weight: bold; transition: 0.2s; font-size: 14px; }
Â  Â  Â  Â  .btn-main:hover { background: #500; }
Â  Â  Â  Â  .btn-delete { position: absolute; right: 5px; top: 5px; background: #f00; color: #000; border: none; padding: 5px 10px; font-weight: bold; cursor: pointer; z-index: 9001; border-radius: 4px; }

Â  Â  Â  Â  #class-menu { display: none; width: 100%; flex-direction: column; }
Â  Â  Â  Â  .save-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin: 15px 0; }
Â  Â  Â  Â  @media (min-width: 600px) { .save-grid { grid-template-columns: 1fr 1fr 1fr; } }

Â  Â  Â  Â  #hud { position: absolute; top: 10px; left: 10px; z-index: 4000; pointer-events: none; }
Â  Â  Â  Â  .masks-container { display: flex; gap: 5px; margin-bottom: 5px; }
Â  Â  Â  Â  .mask { width: 20px; height: 25px; background: #f00; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); }
Â  Â  Â  Â  .mask.broken { background: #444; opacity: 0.3; }

Â  Â  Â  Â  #mobile-controls { position: absolute; inset: 0; z-index: 3000; display: none; pointer-events: none; }
Â  Â  Â  Â  #move-zone { position: absolute; bottom: 20px; left: 20px; width: 150px; height: 150px; pointer-events: auto; }
Â  Â  Â  Â  #joy-base { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; background: rgba(255,0,0,0.1); border: 2px solid #f00; border-radius: 50%; }
Â  Â  Â  Â  #stick { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: #f00; border-radius: 50%; transition: transform 0.1s; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .look-zone { position: absolute; inset: 0; z-index: 2900; pointer-events: auto; }
Â  Â  Â  Â  .action-btns { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 3100; pointer-events: auto; }
Â  Â  Â  Â  .btn-act { width: 80px; height: 80px; background: rgba(40,0,0,0.8); border: 3px solid #f00; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; touch-action: manipulation; }

Â  Â  Â  Â  #cross { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; border: 2px solid rgba(255,0,0,0.8); border-radius: 50%; pointer-events: none; z-index: 2000; }
Â  Â  Â  Â  #cross::after { content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: red; transform: translate(-50%, -50%); }
Â  Â  </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
Â  Â  <div class="glass-panel">
Â  Â  Â  Â  <h1 style="font-family:'Nosifer'; color:#f00; margin:0; font-size: 28px;">DEN OF SHADOW</h1>
Â  Â  Â  Â  <p style="font-size: 10px; color: #f66; margin-bottom: 20px;">V2.3 - FIX CONTROLS & SAVE MGR</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="save-menu">
Â  Â  Â  Â  Â  Â  <h3 style="font-size: 14px;">SELECIONE O SLOT</h3>
Â  Â  Â  Â  Â  Â  <div class="save-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="save-slot-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-main" onclick="selectSlot(1)">SLOT 1<br><small id="s1-info">Vazio</small></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-delete" onclick="deleteSave(1, event)">X</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="save-slot-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-main" onclick="selectSlot(2)">SLOT 2<br><small id="s2-info">Vazio</small></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-delete" onclick="deleteSave(2, event)">X</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="save-slot-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-main" onclick="selectSlot(3)">SLOT 3<br><small id="s3-info">Vazio</small></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-delete" onclick="deleteSave(3, event)">X</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="class-menu">
Â  Â  Â  Â  Â  Â  <h3 style="font-size: 14px;">ESCOLHA SUA CLASSE</h3>
Â  Â  Â  Â  Â  Â  <button class="btn-main" onclick="startWithClass('assassin')">ASSASSINO <br><small>VELOZ / FACA</small></button>
Â  Â  Â  Â  Â  Â  <button class="btn-main" onclick="startWithClass('soldier')">SOLDADO <br><small>EQUILIBRADO / PISTOLA</small></button>
Â  Â  Â  Â  Â  Â  <button class="btn-main" onclick="startWithClass('mage')">MAGO <br><small>DANO ÃREA / FEITIÃ‡O</small></button>
Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  <button class="btn-main" style="background:#111; font-size:10px;" onclick="location.reload()">VOLTAR</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="hud" style="display:none;">
Â  Â  <div class="masks-container" id="masks"></div>
Â  Â  <div id="stats-txt" style="font-size:12px; color:#f00; text-shadow: 1px 1px #000;">SALA: <span id="val-room">1</span> | ALMAS: <span id="val-souls">0</span></div>
</div>

<div id="mobile-controls">
Â  Â  <div id="look-zone" class="look-zone"></div>
Â  Â  <div id="move-zone"><div id="joy-base"><div id="stick"></div></div></div>
Â  Â  <div class="action-btns">
Â  Â  Â  Â  <div class="btn-act" id="btn-fire">ATACAR</div>
Â  Â  Â  Â  <div class="btn-act" id="btn-interact" style="border-color: #0f0;">USAR [E]</div>
Â  Â  Â  Â  <div class="btn-act" id="btn-jump" style="width:60px; height:60px; border-color: #aaa;">PULAR</div>
Â  Â  </div>
</div>

<div id="cross" style="display:none;"></div>
<canvas id="gameCanvas"></canvas>

<script>
// --- CONFIGURAÃ‡Ã•ES GLOBAIS ---
const G = {Â 
Â  Â  play: false, room: 1, hp: 5, maxHp: 5, souls: 0,Â 
Â  Â  weapon: 'knife', currentSlot: 1, class: '',
Â  Â  res: 4, isMobile: false, z: 0, jv: 0, recoil: 0,Â 
Â  Â  doorActive: false, doorPos: {x:0, y:0}, speed: 4,
Â  Â  lastHit: 0
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', {alpha: false});
const TILE = 64, MAP_SIZE = 24;
let map = [], enemies = [], bullets = [], keys = {};
let player = { x: 0, y: 0, angle: 0, pitch: 0, fov: Math.PI / 3 };

function updateSaveUI() {
Â  Â  for(let i=1; i<=3; i++) {
Â  Â  Â  Â  const data = localStorage.getItem('den_save_' + i);
Â  Â  Â  Â  const info = document.getElementById(`s${i}-info`);
Â  Â  Â  Â  if(info) info.innerText = data ? `Sala: ${JSON.parse(data).room}` : "Vazio";
Â  Â  }
}

function deleteSave(slot, event) {
Â  Â  event.stopPropagation();
Â  Â  if(confirm(`Deseja apagar o progresso do Slot ${slot}?`)) {
Â  Â  Â  Â  localStorage.removeItem('den_save_' + slot);
Â  Â  Â  Â  updateSaveUI();
Â  Â  }
}

function selectSlot(slot) {
Â  Â  G.currentSlot = slot;
Â  Â  const data = localStorage.getItem('den_save_' + slot);
Â  Â  if(data) {
Â  Â  Â  Â  const d = JSON.parse(data);
Â  Â  Â  Â  G.room = d.room; G.souls = d.souls; G.weapon = d.weapon; G.class = d.class;
Â  Â  Â  Â  initGame();
Â  Â  } else {
Â  Â  Â  Â  document.getElementById('save-menu').style.display = 'none';
Â  Â  Â  Â  document.getElementById('class-menu').style.display = 'flex';
Â  Â  }
}

function startWithClass(type) {
Â  Â  G.class = type;
Â  Â  if(type === 'assassin') { G.weapon = 'knife'; G.speed = 5.5; G.hp = G.maxHp = 4; }
Â  Â  if(type === 'soldier') { G.weapon = 'pistol'; G.speed = 4; G.hp = G.maxHp = 6; }
Â  Â  if(type === 'mage') { G.weapon = 'magic'; G.speed = 3.5; G.hp = G.maxHp = 5; }
Â  Â  initGame();
}

function setupRoom() {
Â  Â  saveGame();
Â  Â  document.getElementById('val-room').innerText = G.room;
Â  Â  document.getElementById('val-souls').innerText = G.souls;
Â  Â  updateMasks();
Â  Â Â 
Â  Â  map = Array(MAP_SIZE * MAP_SIZE).fill(0);
Â  Â  enemies = []; bullets = [];
Â  Â Â 
Â  Â  for(let i=0; i<MAP_SIZE; i++){Â 
Â  Â  Â  Â  map[i]=1; map[i+(MAP_SIZE*(MAP_SIZE-1))]=1;Â 
Â  Â  Â  Â  map[i*MAP_SIZE]=1; map[i*MAP_SIZE+(MAP_SIZE-1)]=1;Â 
Â  Â  }

Â  Â  for(let i=0; i<15; i++) {
Â  Â  Â  Â  let tx = Math.floor(Math.random()*(MAP_SIZE-4))+2;
Â  Â  Â  Â  let ty = Math.floor(Math.random()*(MAP_SIZE-4))+2;
Â  Â  Â  Â  if(tx !== 12) map[ty*MAP_SIZE+tx] = 1;
Â  Â  }

Â  Â  let count = Math.min(15, 3 + Math.floor(G.room / 2));
Â  Â  for(let i=0; i<count; i++) {
Â  Â  Â  Â  enemies.push({
Â  Â  Â  Â  Â  Â  x:(5+Math.random()*14)*TILE, y:(5+Math.random()*14)*TILE,Â 
Â  Â  Â  Â  Â  Â  hp: 40 + (G.room*5), alive: true,Â 
Â  Â  Â  Â  Â  Â  type: (G.room % 5 === 0 && i === 0) ? 'BOSS' : 'MOB',
Â  Â  Â  Â  Â  Â  speed: 1.5 + Math.random()
Â  Â  Â  Â  });
Â  Â  }

Â  Â  G.doorPos = { x: 12 * TILE + (TILE/2), y: 1 * TILE + (TILE/2) };
Â  Â  map[1*MAP_SIZE + 12] = 2;Â 
Â  Â Â 
Â  Â  player.x = 12*TILE; player.y = 21*TILE;
Â  Â  player.angle = -Math.PI/2;
}

function performInteract() {
Â  Â  let dx = player.x - G.doorPos.x;
Â  Â  let dy = player.y - G.doorPos.y;
Â  Â  let dist = Math.sqrt(dx*dx + dy*dy);
Â  Â  if(enemies.every(e => !e.alive) && dist < 120) {
Â  Â  Â  Â  G.room++;
Â  Â  Â  Â  setupRoom();
Â  Â  }
}

// --- RENDER ---
function draw() {
Â  Â  ctx.fillStyle = "#050000"; ctx.fillRect(0,0,canvas.width, canvas.height/2 + player.pitch + G.z);
Â  Â  ctx.fillStyle = "#150505"; ctx.fillRect(0,canvas.height/2 + player.pitch + G.z, canvas.width, canvas.height);

Â  Â  for(let i=0; i<canvas.width; i+=G.res) {
Â  Â  Â  Â  let a = (player.angle - player.fov/2) + (i/canvas.width)*player.fov;
Â  Â  Â  Â  let d=0, cos=Math.cos(a), sin=Math.sin(a), hit=0;
Â  Â  Â  Â  while(hit===0 && d<900) {
Â  Â  Â  Â  Â  Â  d += 4;
Â  Â  Â  Â  Â  Â  let tx = Math.floor((player.x+cos*d)/TILE), ty = Math.floor((player.y+sin*d)/TILE);
Â  Â  Â  Â  Â  Â  if(tx<0||tx>=MAP_SIZE||ty<0||ty>=MAP_SIZE) { hit=1; break; }
Â  Â  Â  Â  Â  Â  let wall = map[ty*MAP_SIZE+tx];
Â  Â  Â  Â  Â  Â  if(wall > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  hit = wall;
Â  Â  Â  Â  Â  Â  Â  Â  let dist = d * Math.cos(player.angle-a);
Â  Â  Â  Â  Â  Â  Â  Â  let h = (TILE * canvas.height) / dist;
Â  Â  Â  Â  Â  Â  Â  Â  let yPos = (canvas.height-h)/2 + player.pitch + G.z;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = hit === 2 ? (enemies.every(e=>!e.alive) ? "#0f0" : "#400") : `rgb(${Math.max(20, 150-dist/5)}, 0, 0)`;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(i, yPos, G.res, h);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  let sprites = [...enemies.filter(e=>e.alive), ...bullets];
Â  Â  sprites.sort((a,b) => Math.hypot(player.x-b.x, player.y-b.y) - Math.hypot(player.x-a.x, player.y-a.y));

Â  Â  sprites.forEach(s => {
Â  Â  Â  Â  let dx = s.x - player.x, dy = s.y - player.y;
Â  Â  Â  Â  let dist = Math.sqrt(dx*dx + dy*dy);
Â  Â  Â  Â  let ang = Math.atan2(dy, dx) - player.angle;
Â  Â  Â  Â  while(ang < -Math.PI) ang += Math.PI*2; while(ang > Math.PI) ang -= Math.PI*2;
Â  Â  Â  Â  if(Math.abs(ang) < player.fov && dist > 10) {
Â  Â  Â  Â  Â  Â  let sx = (0.5 * (ang/(player.fov/2)) + 0.5) * canvas.width;
Â  Â  Â  Â  Â  Â  let sh = (TILE * canvas.height) / dist;
Â  Â  Â  Â  Â  Â  let sy = (canvas.height/2) + player.pitch + G.z;
Â  Â  Â  Â  Â  Â  if(s.vx !== undefined) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = s.magic ? "#f0f" : "#ff0";
Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath(); ctx.arc(sx, sy, sh/8, 0, 7); ctx.fill();
Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = s.type === 'BOSS' ? "#f0f" : "#f00";
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(sx - sh/3, sy - sh/2, sh/1.5, sh);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
Â  Â  drawWeapon();
}

function drawWeapon() {
Â  Â  let sw = canvas.width, sh = canvas.height;
Â  Â  let bob = Math.sin(Date.now() * 0.008) * 6;
Â  Â  let rec = G.recoil * 4;
Â  Â  ctx.save();
Â  Â  if(G.weapon === 'knife') {
Â  Â  Â  Â  ctx.translate(sw * 0.7, sh - 100 + bob - rec);
Â  Â  Â  Â  ctx.fillStyle = '#aaa'; ctx.fillRect(-10, -100, 20, 120);
Â  Â  } else {
Â  Â  Â  Â  ctx.translate(sw * 0.55, sh - 100 + bob - rec);
Â  Â  Â  Â  ctx.fillStyle = G.weapon === 'magic' ? '#404' : '#222';
Â  Â  Â  Â  ctx.fillRect(-20, -20, 100, 40); ctx.fillRect(-20, -20, 30, 80);
Â  Â  }
Â  Â  ctx.restore();
}

// --- UPDATE ---
function update() {
Â  Â  if(!G.play) return;
Â  Â  if(G.recoil > 0) G.recoil -= 2;
Â  Â  G.z += G.jv; G.jv -= 0.8; if(G.z <= 0) { G.z = 0; G.jv = 0; }

Â  Â  let mx = 0, my = 0;
Â  Â  if(keys['w'] || keys['arrowup']) { mx += Math.cos(player.angle); my += Math.sin(player.angle); }
Â  Â  if(keys['s'] || keys['arrowdown']) { mx -= Math.cos(player.angle); my -= Math.sin(player.angle); }
Â  Â  if(keys['a'] || keys['arrowleft']) { mx += Math.cos(player.angle - Math.PI/2); my += Math.sin(player.angle - Math.PI/2); }
Â  Â  if(keys['d'] || keys['arrowright']) { mx += Math.cos(player.angle + Math.PI/2); my += Math.sin(player.angle + Math.PI/2); }
Â  Â Â 
Â  Â  if(mJoy.active) {
Â  Â  Â  Â  mx += Math.cos(player.angle) * (-mJoy.dy) + Math.cos(player.angle + Math.PI/2) * mJoy.dx;
Â  Â  Â  Â  my += Math.sin(player.angle) * (-mJoy.dy) + Math.sin(player.angle + Math.PI/2) * mJoy.dx;
Â  Â  }

Â  Â  let speed = G.speed;
Â  Â  let nx = player.x + mx * speed, ny = player.y + my * speed;
Â  Â  if(map[Math.floor(player.y/TILE)*MAP_SIZE + Math.floor(nx/TILE)] === 0) player.x = nx;
Â  Â  if(map[Math.floor(ny/TILE)*MAP_SIZE + Math.floor(player.x/TILE)] === 0) player.y = ny;

Â  Â  enemies.forEach(en => {
Â  Â  Â  Â  if(!en.alive) return;
Â  Â  Â  Â  let dx = player.x - en.x, dy = player.y - en.y;
Â  Â  Â  Â  let dist = Math.hypot(dx, dy);
Â  Â  Â  Â  if(dist < 400) {Â 
Â  Â  Â  Â  Â  Â  let ang = Math.atan2(dy, dx);
Â  Â  Â  Â  Â  Â  let ex = en.x + Math.cos(ang) * en.speed;
Â  Â  Â  Â  Â  Â  let ey = en.y + Math.sin(ang) * en.speed;
Â  Â  Â  Â  Â  Â  if(map[Math.floor(ey/TILE)*MAP_SIZE + Math.floor(ex/TILE)] === 0) { en.x = ex; en.y = ey; }
Â  Â  Â  Â  }
Â  Â  Â  Â  if(dist < 40 && Date.now() - G.lastHit > 1000) {
Â  Â  Â  Â  Â  Â  G.hp--; G.lastHit = Date.now(); updateMasks();
Â  Â  Â  Â  Â  Â  if(G.hp <= 0) location.reload();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  bullets = bullets.filter(b => {
Â  Â  Â  Â  b.x += b.vx; b.y += b.vy; b.life--;
Â  Â  Â  Â  let hit = false;
Â  Â  Â  Â  enemies.forEach(en => {
Â  Â  Â  Â  Â  Â  if(en.alive && Math.hypot(b.x-en.x, b.y-en.y) < 35) {
Â  Â  Â  Â  Â  Â  Â  Â  en.hp -= b.magic ? 50 : 30; b.life = 0; hit = true;
Â  Â  Â  Â  Â  Â  Â  Â  if(en.hp <= 0) { en.alive = false; G.souls += 15; document.getElementById('val-souls').innerText = G.souls; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return b.life > 0 && !hit && map[Math.floor(b.y/TILE)*MAP_SIZE + Math.floor(b.x/TILE)] === 0;
Â  Â  });
}

function shoot() {
Â  Â  if(G.recoil > 0) return;
Â  Â  G.recoil = 12;
Â  Â  if(G.weapon === 'knife') {
Â  Â  Â  Â  enemies.forEach(en => {
Â  Â  Â  Â  Â  Â  if(en.alive && Math.hypot(player.x-en.x, player.y-en.y) < 80) {
Â  Â  Â  Â  Â  Â  Â  Â  en.hp -= 60; if(en.hp<=0){ en.alive=false; G.souls+=15; document.getElementById('val-souls').innerText = G.souls; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  bullets.push({ x: player.x, y: player.y, vx: Math.cos(player.angle)*15, vy: Math.sin(player.angle)*15, life: 60, magic: G.weapon==='magic' });
Â  Â  }
}

// --- CONTROLES CORRIGIDOS ---
const mJoy = { active: false, sx:0, sy:0, dx:0, dy:0, id:null };
const moveZone = document.getElementById('move-zone');

moveZone.addEventListener('touchstart', e => {Â 
Â  Â  const t = e.changedTouches[0];
Â  Â  mJoy.active = true; mJoy.id = t.identifier;
Â  Â  mJoy.sx = t.clientX; mJoy.sy = t.clientY;
}, {passive: false});

moveZone.addEventListener('touchmove', e => {
Â  Â  e.preventDefault();
Â  Â  for(let t of e.changedTouches) {
Â  Â  Â  Â  if(t.identifier === mJoy.id) {
Â  Â  Â  Â  Â  Â  let dx = t.clientX - mJoy.sx;
Â  Â  Â  Â  Â  Â  let dy = t.clientY - mJoy.sy;
Â  Â  Â  Â  Â  Â  let dist = Math.min(40, Math.hypot(dx, dy));
Â  Â  Â  Â  Â  Â  let ang = Math.atan2(dy, dx);
Â  Â  Â  Â  Â  Â  mJoy.dx = (Math.cos(ang) * dist) / 40;
Â  Â  Â  Â  Â  Â  mJoy.dy = (Math.sin(ang) * dist) / 40;
Â  Â  Â  Â  Â  Â  document.getElementById('stick').style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
Â  Â  Â  Â  }
Â  Â  }
}, {passive: false});

moveZone.addEventListener('touchend', () => {
Â  Â  mJoy.active = false; mJoy.dx = 0; mJoy.dy = 0;
Â  Â  document.getElementById('stick').style.transform = `translate(0,0)`;
});

// Olhar Mobile
let lTouch = { id: null, x: 0, y: 0 };
document.getElementById('look-zone').addEventListener('touchstart', e => {
Â  Â  const t = e.changedTouches[0];
Â  Â  lTouch.id = t.identifier; lTouch.x = t.clientX; lTouch.y = t.clientY;
});

document.getElementById('look-zone').addEventListener('touchmove', e => {
Â  Â  for(let t of e.changedTouches) {
Â  Â  Â  Â  if(t.identifier === lTouch.id) {
Â  Â  Â  Â  Â  Â  player.angle += (t.clientX - lTouch.x) * 0.005;
Â  Â  Â  Â  Â  Â  player.pitch = Math.max(-150, Math.min(150, player.pitch - (t.clientY - lTouch.y) * 1.5));
Â  Â  Â  Â  Â  Â  lTouch.x = t.clientX; lTouch.y = t.clientY;
Â  Â  Â  Â  }
Â  Â  }
});

// Mouse e Cliques
window.addEventListener('mousedown', (e) => {
Â  Â  if(G.play) {
Â  Â  Â  Â  if(document.pointerLockElement === canvas) {
Â  Â  Â  Â  Â  Â  shoot();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  canvas.requestPointerLock();
Â  Â  Â  Â  }
Â  Â  }
});

window.addEventListener('mousemove', (e) => {
Â  Â  if(document.pointerLockElement === canvas && G.play) {
Â  Â  Â  Â  player.angle += e.movementX * 0.003;
Â  Â  Â  Â  player.pitch = Math.max(-200, Math.min(200, player.pitch - e.movementY * 1.5));
Â  Â  }
});

document.getElementById('btn-fire').onclick = e => { e.preventDefault(); shoot(); };
document.getElementById('btn-interact').onclick = e => { e.preventDefault(); performInteract(); };
document.getElementById('btn-jump').onclick = e => { e.preventDefault(); if(G.z===0) G.jv=10; };

window.onkeydown = e => {Â 
Â  Â  keys[e.key.toLowerCase()] = true;Â 
Â  Â  if(e.key.toLowerCase()==='e') performInteract();Â 
Â  Â  if(e.code==='Space' && G.z===0) G.jv=10;Â 
};
window.onkeyup = e => delete keys[e.key.toLowerCase()];

function saveGame() {
Â  Â  localStorage.setItem('den_save_' + G.currentSlot, JSON.stringify({ room: G.room, souls: G.souls, weapon: G.weapon, class: G.class }));
}

function updateMasks() {
Â  Â  const c = document.getElementById('masks');
Â  Â  c.innerHTML = '';
Â  Â  for(let i=0; i<G.maxHp; i++) {
Â  Â  Â  Â  let m = document.createElement('div'); m.className = i < G.hp ? 'mask' : 'mask broken';
Â  Â  Â  Â  c.appendChild(m);
Â  Â  }
}

function initGame() {
Â  Â  G.isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
Â  Â  document.getElementById('start-screen').style.display = 'none';
Â  Â  document.getElementById('hud').style.display = 'block';
Â  Â  document.getElementById('cross').style.display = 'block';
Â  Â  if(G.isMobile) document.getElementById('mobile-controls').style.display = 'block';
Â  Â  setupRoom();
Â  Â  G.play = true;
Â  Â  requestAnimationFrame(loop);
}

function loop() { update(); draw(); if(G.play) requestAnimationFrame(loop); }
window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize();
updateSaveUI();
</script>
</body>
</html>
