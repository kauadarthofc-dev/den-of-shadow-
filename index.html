<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow üíÄ V8.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&family=Special+Elite&display=swap');
        
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        
        canvas { display: block; width: 100vw; height: 100vh; }

        /* Interface Screens */
        .ui-screen { position: absolute; inset: 0; background: radial-gradient(circle, #1a0000 0%, #000 100%); z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-main { padding: 18px 50px; font-size: 20px; background: rgba(50,0,0,0.5); border: 2px solid #800; color: #fff; cursor: pointer; font-family: 'Orbitron'; margin-top: 30px; letter-spacing: 3px; box-shadow: 0 0 15px #400; }
        .btn-main:hover { background: #800; box-shadow: 0 0 30px #f00; }

        /* HUD Cl√°ssica Melhorada */
        #hud { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; width: 90%; max-width: 600px; pointer-events: none; }
        .hud-stats { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); padding: 15px 25px; border: 2px solid #500; border-radius: 15px; box-shadow: 0 0 25px rgba(255,0,0,0.1); }
        .stat-label { font-size: 10px; color: #888; margin-bottom: 5px; }
        .bar-container { width: 140px; height: 10px; background: #111; border: 1px solid #333; overflow: hidden; border-radius: 5px; }
        .bar-fill { height: 100%; transition: width 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        /* Minimapa Moderno */
        #minimap { position: absolute; top: 25px; right: 25px; width: 150px; height: 150px; border: 2px solid #800; background: rgba(0,0,0,0.8); z-index: 1000; display: none; border-radius: 10px; opacity: 0.7; }

        /* Mira Laser */
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: #f00; border-radius: 50%; box-shadow: 0 0 10px #f00, 0 0 20px #f00; z-index: 1500; display: none; pointer-events: none; }

        /* Arma Sprite Avan√ßado */
        #weapon-view { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 400px; height: 300px; pointer-events: none; z-index: 500; display: none; }
        .hand { position: absolute; bottom: 0; left: 50%; width: 120px; height: 200px; background: linear-gradient(to top, #000, #200); border-radius: 50% 50% 0 0; transform: translateX(-50%); filter: blur(2px); }
        .weapon-glow { position: absolute; top: 40px; left: 50%; width: 30px; height: 30px; background: radial-gradient(circle, #f00, transparent); transform: translateX(-50%); border-radius: 50%; }

        #interact-prompt { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); color: #fff; background: rgba(0,0,0,0.8); padding: 12px 25px; border-radius: 8px; display: none; z-index: 1100; border: 1px solid #f00; font-size: 14px; box-shadow: 0 0 20px #800; }
        #pause-mobile { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(255,255,255,0.05); border: 1px solid #800; border-radius: 10px; z-index: 2500; display: none; align-items: center; justify-content: center; font-size: 20px; }
    </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
    <h1 style="font-family:'Nosifer'; color:#f00; font-size: clamp(30px, 10vw, 60px);">DEN OF SHADOW</h1>
    <p style="font-size:14px; color:#666;">High Fidelity V8.0</p>
    <button class="btn-main" onclick="startGame()">INICIAR RITUAL</button>
</div>

<div id="pause-screen" class="ui-screen" style="display:none;">
    <h1 style="font-family:'Nosifer'; color:#f00;">PAUSADO</h1>
    <button class="btn-main" onclick="togglePause()">CONTINUAR</button>
    <button class="btn-main" onclick="location.reload()">SAIR</button>
</div>

<div id="death-screen" class="ui-screen" style="display:none;">
    <h1 style="font-family:'Nosifer'; color:#f00;">CONSUMIDO</h1>
    <button class="btn-main" onclick="location.reload()">REENCARNAR</button>
</div>

<div id="pause-mobile" onclick="togglePause()">‚öôÔ∏è</div>
<div id="interact-prompt">INTERAGIR</div>
<canvas id="minimap"></canvas>
<div id="crosshair"></div>

<div id="weapon-view">
    <div class="hand"></div>
    <div id="muzzle-flash" class="weapon-glow"></div>
</div>

<div id="hud">
    <div class="hud-stats">
        <div>
            <div class="stat-label">VITALIDADE</div>
            <div class="bar-container"><div id="hp-fill" class="bar-fill" style="background: linear-gradient(90deg, #600, #f00);"></div></div>
        </div>
        <div style="text-align:center;">
            <div class="stat-label">C√ÇMARA</div>
            <span id="room-txt" style="color:#f00; font-size: 24px; font-weight: bold;">0</span>
        </div>
        <div>
            <div class="stat-label">ALMA</div>
            <div class="bar-container"><div id="ammo-fill" class="bar-fill" style="background: linear-gradient(90deg, #880, #ff0);"></div></div>
        </div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
/**
 * ENGINE V8.0 - High Resolution Raycaster
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mCanvas = document.getElementById('minimap');
const mCtx = mCanvas.getContext('2d');

const TILE_SIZE = 64;
const MAP_SIZE = 24;
let map = [], enemies = [], heals = [], bullets = [];

const G = {
    play: false, paused: false, room: 0,
    hp: 100, ammo: 40, maxAmmo: 40, lastShot: 0
};

const player = {
    x: 0, y: 0, angle: 0, pitch: 0,
    moveDir: { x: 0, y: 0 }, fov: Math.PI / 3,
    bob: 0
};

// --- INITIALIZATION ---
function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.querySelectorAll('#hud, #minimap, #crosshair, #weapon-view').forEach(el => el.style.display = 'block');
    if('ontouchstart' in window) document.getElementById('pause-mobile').style.display = 'flex';
    else canvas.requestPointerLock();
    
    setupRoom();
    G.play = true;
    requestAnimationFrame(gameLoop);
}

function setupRoom() {
    // Gerar Mapa
    map = Array(MAP_SIZE * MAP_SIZE).fill(0);
    for(let i=0; i<MAP_SIZE; i++) {
        map[i] = 1; map[i + (MAP_SIZE*(MAP_SIZE-1))] = 1;
        map[i * MAP_SIZE] = 1; map[i * MAP_SIZE + (MAP_SIZE-1)] = 1;
    }
    map[Math.floor(MAP_SIZE/2)] = 2; // Sa√≠da
    map[MAP_SIZE*(MAP_SIZE-1) + Math.floor(MAP_SIZE/2)] = 3; // Entrada

    // Spawn Player - SEMPRE OLHANDO PARA O CENTRO
    player.x = (MAP_SIZE/2) * TILE_SIZE;
    player.y = (MAP_SIZE - 2.5) * TILE_SIZE;
    const centerX = (MAP_SIZE/2) * TILE_SIZE;
    const centerY = (MAP_SIZE/2) * TILE_SIZE;
    player.angle = Math.atan2(centerY - player.y, centerX - player.x);
    player.pitch = 0;

    spawnEntities();
}

function spawnEntities() {
    enemies = []; heals = [];
    let count = 4 + Math.floor(G.room * 0.7);
    for(let i=0; i<count; i++) {
        enemies.push({
            x: (6 + Math.random() * (MAP_SIZE-12)) * TILE_SIZE,
            y: (6 + Math.random() * (MAP_SIZE-12)) * TILE_SIZE,
            hp: 80, alive: true, s: 40 // Sprite size
        });
    }
    if(Math.random() > 0.3) heals.push({ x: (MAP_SIZE/2)*TILE_SIZE, y: (MAP_SIZE/2)*TILE_SIZE, active: true });
}

function togglePause() {
    G.paused = !G.paused;
    document.getElementById('pause-screen').style.display = G.paused ? 'flex' : 'none';
    if(!G.paused && !('ontouchstart' in window)) canvas.requestPointerLock();
}

// --- INPUTS (PC & MOBILE) ---
const keys = {};
window.onkeydown = e => { if(e.key === 'Escape') togglePause(); keys[e.key.toLowerCase()] = true; };
window.onkeyup = e => delete keys[e.key.toLowerCase()];

document.addEventListener('mousemove', e => {
    if(document.pointerLockElement === canvas && !G.paused) {
        player.angle += e.movementX * 0.0025;
        player.pitch = Math.max(-350, Math.min(350, player.pitch - e.movementY * 1.8));
    }
});

let tId = null, cId = null, lx, ly;
window.addEventListener('touchstart', e => {
    for(let t of e.changedTouches) {
        if(t.clientX < window.innerWidth/2) tId = t.identifier;
        else { cId = t.identifier; lx = t.clientX; ly = t.clientY; }
    }
});
window.addEventListener('touchmove', e => {
    if(!G.play || G.paused) return;
    for(let t of e.changedTouches) {
        if(t.identifier === tId) {
            player.moveDir = { x: (t.clientX - 100)/50, y: (t.clientY - (window.innerHeight-100))/50 };
        }
        if(t.identifier === cId) {
            player.angle += (t.clientX - lx) * 0.01;
            player.pitch = Math.max(-350, Math.min(350, player.pitch - (t.clientY - ly) * 1.8));
            lx = t.clientX; ly = t.clientY;
        }
    }
});
window.addEventListener('touchend', e => {
    for(let t of e.changedTouches) { if(t.identifier === tId) player.moveDir = {x:0,y:0}; if(t.identifier === cId) cId = null; }
});

document.addEventListener('mousedown', e => { if(G.play && !G.paused) e.button === 0 ? shoot() : interact(); });

// --- GAME LOGIC ---
function shoot() {
    if(G.ammo < 1 || Date.now() - G.lastShot < 200) return;
    G.ammo--; G.lastShot = Date.now();
    bullets.push({ x: player.x, y: player.y, vx: Math.cos(player.angle)*22, vy: Math.sin(player.angle)*22, life: 60 });
    
    // Anima√ß√£o de tiro
    const flash = document.getElementById('muzzle-flash');
    flash.style.opacity = "1"; flash.style.transform = "translateX(-50%) scale(2.5)";
    setTimeout(() => { flash.style.opacity = "0.4"; flash.style.transform = "translateX(-50%) scale(1)"; }, 50);
}

function interact() {
    let tx = Math.floor((player.x + Math.cos(player.angle)*70)/TILE_SIZE);
    let ty = Math.floor((player.y + Math.sin(player.angle)*70)/TILE_SIZE);
    
    if(map[ty*MAP_SIZE+tx] === 2 && enemies.filter(e=>e.alive).length === 0) {
        G.room++; setupRoom();
    } else if(map[ty*MAP_SIZE+tx] === 3 && G.room > 0) {
        G.room--; setupRoom();
    }

    heals.forEach(h => {
        if(h.active && G.hp < 100 && Math.hypot(player.x-h.x, player.y-h.y) < 70) {
            G.hp = Math.min(100, G.hp + 40); h.active = false;
        }
    });
}

function update() {
    if(!G.play || G.paused) return;

    let mx = 0, my = 0;
    if(keys['w']) { mx += Math.cos(player.angle); my += Math.sin(player.angle); }
    if(keys['s']) { mx -= Math.cos(player.angle); my -= Math.sin(player.angle); }
    if(keys['a']) { mx += Math.cos(player.angle-Math.PI/2); my += Math.sin(player.angle-Math.PI/2); }
    if(keys['d']) { mx += Math.cos(player.angle+Math.PI/2); my += Math.sin(player.angle+Math.PI/2); }
    
    // Movimento do Mobile
    mx += (Math.cos(player.angle)*-player.moveDir.y*5 + Math.cos(player.angle+Math.PI/2)*player.moveDir.x*5);
    my += (Math.sin(player.angle)*-player.moveDir.y*5 + Math.sin(player.angle+Math.PI/2)*player.moveDir.x*5);

    let nx = player.x + mx*4.5, ny = player.y + my*4.5;
    if(map[Math.floor(ny/TILE_SIZE)*MAP_SIZE + Math.floor(nx/TILE_SIZE)] === 0) { 
        player.x = nx; player.y = ny; 
        if(mx !== 0 || my !== 0) player.bob += 0.15;
    }

    // UI Interact
    const prompt = document.getElementById('interact-prompt');
    let hNear = heals.find(h => h.active && G.hp < 100 && Math.hypot(player.x-h.x, player.y-h.y) < 70);
    if(hNear) { prompt.innerText = "COLETAR ESS√äNCIA"; prompt.style.display='block'; }
    else prompt.style.display = 'none';

    bullets.forEach((b,i) => {
        b.x += b.vx; b.y += b.vy; b.life--;
        if(map[Math.floor(b.y/TILE_SIZE)*MAP_SIZE + Math.floor(b.x/TILE_SIZE)] > 0 || b.life <= 0) bullets.splice(i,1);
        enemies.forEach(en => { if(en.alive && Math.hypot(b.x-en.x, b.y-en.y) < 35) { en.hp -= 40; bullets.splice(i,1); if(en.hp<=0) en.alive=false; } });
    });

    enemies.forEach(en => {
        if(!en.alive) return;
        let d = Math.hypot(player.x-en.x, player.y-en.y);
        if(d < 45) G.hp -= 0.5;
        else { en.x += (player.x-en.x)/d*1.8; en.y += (player.y-en.y)/d*1.8; }
    });

    if(G.hp <= 0) { G.play = false; document.getElementById('death-screen').style.display='flex'; document.exitPointerLock(); }
    G.ammo = Math.min(G.maxAmmo, G.ammo + 0.007);
    
    // Weapon Bobbing
    document.getElementById('weapon-view').style.bottom = (-20 + Math.sin(player.bob)*10) + "px";
}

// --- RENDERING (HIGH RES) ---
function draw() {
    // Ceil/Floor
    ctx.fillStyle = "#0a0000"; ctx.fillRect(0,0,canvas.width, canvas.height/2 + player.pitch);
    ctx.fillStyle = "#1a0505"; ctx.fillRect(0,canvas.height/2 + player.pitch, canvas.width, canvas.height);

    const res = 1; // 1 ray per pixel horizontal
    const numRays = canvas.width / res;

    for(let i=0; i<numRays; i++) {
        let ang = (player.angle - player.fov/2) + (i * (player.fov/numRays));
        let d=0, hit=false, cos=Math.cos(ang), sin=Math.sin(ang);
        
        while(!hit && d < 1200) {
            d += 7;
            let tx=Math.floor((player.x+cos*d)/TILE_SIZE), ty=Math.floor((player.y+sin*d)/TILE_SIZE);
            let tile = map[ty*MAP_SIZE+tx];
            if(tile > 0) {
                hit = true;
                let h = (TILE_SIZE * canvas.height) / (d * Math.cos(player.angle-ang));
                let lum = Math.max(30, (tile === 2 ? 255 : 150) - d/6);
                ctx.fillStyle = `rgb(${lum}, 0, 0)`;
                ctx.fillRect(i*res, (canvas.height-h)/2 + player.pitch, res, h);
            }
        }
    }

    const drawSprite = (x,y,c,s,glow=false) => {
        let ang = Math.atan2(y-player.y, x-player.x)-player.angle;
        while(ang < -Math.PI) ang+=Math.PI*2; while(ang > Math.PI) ang-=Math.PI*2;
        if(Math.abs(ang) < player.fov) {
            let d = Math.hypot(player.x-x, player.y-y);
            let sx = (0.5 * (ang/(player.fov/2)) + 0.5) * canvas.width;
            let sh = (s * canvas.height)/d;
            if(glow) { ctx.shadowBlur = 20; ctx.shadowColor = c; }
            ctx.fillStyle = c;
            ctx.fillRect(sx-sh/2, (canvas.height-sh)/2+player.pitch, sh, sh);
            ctx.shadowBlur = 0;
        }
    };

    enemies.forEach(en => en.alive && drawSprite(en.x, en.y, "#000", 45, true));
    heals.forEach(h => h.active && drawSprite(h.x, h.y, "#0f0", 25, true));
    bullets.forEach(b => drawSprite(b.x, b.y, "#ff0", 8));

    renderMinimap();
    document.getElementById('hp-fill').style.width = G.hp+"%";
    document.getElementById('ammo-fill').style.width = (G.ammo/G.maxAmmo*100)+"%";
    document.getElementById('room-txt').innerText = G.room;
}

function renderMinimap() {
    mCtx.clearRect(0,0,150,150);
    const s = 150/MAP_SIZE;
    for(let y=0; y<MAP_SIZE; y++) {
        for(let x=0; x<MAP_SIZE; x++) {
            if(map[y*MAP_SIZE+x] === 1) { mCtx.fillStyle = "#300"; mCtx.fillRect(x*s, y*s, s, s); }
            if(map[y*MAP_SIZE+x] === 2) { mCtx.fillStyle = "#f00"; mCtx.fillRect(x*s, y*s, s, s); }
        }
    }
    mCtx.fillStyle = "#fff"; mCtx.fillRect((player.x/TILE_SIZE)*s-1, (player.y/TILE_SIZE)*s-1, 3, 3);
}

function gameLoop() { if(G.play) { update(); draw(); } requestAnimationFrame(gameLoop); }

window.onresize = () => { 
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    mCanvas.width = 150; mCanvas.height = 150;
};
window.onresize();
</script>
</body>
</html>
