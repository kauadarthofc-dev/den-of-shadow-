<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow üíÄ Darkest Soul</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&family=Special+Elite&display=swap');
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; }

        .ui-screen { position: absolute; inset: 0; background: radial-gradient(circle at center, #1a0000 0%, #000000 100%); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #start-screen h1 { font-family: 'Nosifer', cursive; font-size: clamp(30px, 8vw, 70px); color: #880000; text-shadow: 0 0 20px #f00; margin-bottom: 20px; }
        
        .btn-main { padding: 15px 50px; font-size: 18px; background: transparent; border: 2px solid #550000; color: #fff; cursor: pointer; font-family: 'Orbitron'; margin: 10px; transition: 0.3s; pointer-events: auto; }
        .btn-main:hover { background: #550000; box-shadow: 0 0 40px #ff0000; }
        
        #hud { position: absolute; top: 15px; left: 15px; z-index: 1000; display: none; pointer-events: none; width: calc(100% - 30px); }
        .hud-group { background: rgba(0,0,0,0.8); padding: 8px; border-left: 3px solid #f00; margin-bottom: 5px; width: 220px; }
        .bar-bg { width: 100%; height: 8px; background: #222; margin-top: 5px; }
        .bar-fill { height: 100%; transition: width 0.2s; }
        
        #room-ui { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.8); padding: 10px 20px; border-right: 3px solid #660; color: #fff; font-size: 18px; }

        #cutscene-screen { background: black; cursor: pointer; z-index: 5000; display:none; }
        #cutscene-text { font-family: 'Special Elite', serif; font-size: clamp(18px, 4vw, 24px); color: #bb0000; max-width: 800px; line-height: 1.6; }

        .upgrade-card { background: rgba(30, 0, 0, 0.9); border: 1px solid #500; padding: 20px; width: 220px; margin: 10px; cursor: pointer; pointer-events: auto; transition: 0.3s; }
        .upgrade-card:hover { border-color: #f00; background: #400; transform: translateY(-5px); }

        .mobile-ui { position: absolute; bottom: 40px; width: 100%; display: none; justify-content: space-between; align-items: flex-end; padding: 0 30px; z-index: 2500; pointer-events: none; }
        .joy-container { width: 130px; height: 130px; background: rgba(255,0,0,0.1); border: 2px solid rgba(255,0,0,0.3); border-radius: 50%; position: relative; pointer-events: auto; }
        .joy-stick { width: 50px; height: 50px; background: rgba(255,0,0,0.5); border: 2px solid red; border-radius: 50%; position: absolute; top: 40px; left: 40px; pointer-events: none; }
    </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
    <h1>DEN OF SHADOW</h1>
    <button class="btn-main" onclick="initGameFlow()">ACEITAR O FARDO</button>
    <button id="btn-continue" class="btn-main" style="display:none; border-color: #660;" onclick="loadGame()">CONTINUAR JORNADA</button>
</div>

<div id="cutscene-screen" class="ui-screen" onclick="advanceCutscene()">
    <div id="cutscene-text"></div>
</div>

<div id="upgrade-screen" class="ui-screen" style="display:none">
    <h2 style="font-family:'Nosifer'; color:#660;">RESTOS DE PODER</h2>
    <div id="upgrade-list" style="display:flex; flex-wrap: wrap; justify-content: center;"></div>
</div>

<div id="hud">
    <div class="hud-group">
        <div>VITALIDADE <span id="dev-tag" style="color:yellow; font-size:9px; display:none;">[KADTR]</span></div>
        <div class="bar-bg"><div id="hp-fill" class="bar-fill" style="background:#800; width: 100%;"></div></div>
    </div>
    <div class="hud-group" style="border-color:#660;">
        <div>ARMA: <span id="weapon-name" style="font-size:10px;">B√ÅSICA</span></div>
        <div class="bar-bg"><div id="ammo-fill" class="bar-fill" style="background:#660; width: 100%;"></div></div>
    </div>
    <div id="room-ui">SALA: <span id="room-txt">0</span> / 100</div>
</div>

<div id="mobile-controls" class="mobile-ui">
    <div class="joy-container" id="move-joy"><div class="joy-stick" id="move-stick"></div></div>
    <div class="joy-container" id="aim-joy"><div class="joy-stick" id="aim-stick"></div></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let audioCtx, bufferInimigo, bufferFilha;
const ROOM = { w: 1600, h: 1000, wall: 80 };
const G = {
    play: false, room: 0, hp: 100, maxHp: 100, ammo: 25, maxAmmo: 25,
    enemiesDefeated: false, inCutscene: false, kadtr: false, lastShot: 0,
    weapon: "B√°sica", weaponDmg: 50, weaponSpd: 200, dmgMult: 1, spdMult: 1
};

const STORY = {
    init: ["Voc√™ n√£o √© um her√≥i.", "O Rei das Sombras lhe tirou tudo.", "A torre √© o seu caminho.", "O topo √© a √∫nica sa√≠da."],
    boss10: ["O Guardi√£o foi silenciado.", "Ele tamb√©m j√° teve uma fam√≠lia.", "Voc√™ sente o peso de cada vida?"],
    boss20: ["A Filha do Rei implora por miseric√≥rdia...", "Mas aqui, apenas a morte √© real."],
    boss30: ["Eles imploram em l√≠nguas esquecidas.", "O Den of Shadow se alimenta da sua raiva."],
    boss40: ["O Arquiteto das Sombras caiu.", "Ele construiu esta torre para manter algo l√° fora...", "Ou para manter voc√™ aqui dentro?"],
    boss50: ["Metade da subida.", "N√£o h√° nada l√° atr√°s para voc√™."],
    boss60: ["O Carrasco das Almas n√£o tortura mais.", "Ele gritou exatamente como suas v√≠timas."],
    boss70: ["A Sombra do Passado foi dissipada.", "Voc√™ est√° matando suas pr√≥prias mem√≥rias para subir."],
    boss80: ["Voc√™ est√° quase l√°.", "Mas o que restar√° de voc√™ no topo?"],
    boss90: ["O Purgat√≥rio Final.", "A escurid√£o aqui √© t√£o densa que voc√™ quase pode toc√°-la.", "O √∫ltimo teste antes do Rei."],
    final: ["O REI DAS SOMBRAS CAIU.", "Voc√™ recuperou seu trono.", "Mas agora, voc√™ √© a coisa mais sombria neste lugar."]
};

let currentStory = [], storyIdx = 0, devCode = "";
const keys = {};
let player = { x: 800, y: 800, r: 25, spd: 7.5 };
let enemies = [], projectiles = [], joyInput = { moveX: 0, moveY: 0, aimX: 0, aimY: 0 };

async function setupAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const loadSound = async (url) => {
        try { const r = await fetch(url); return await audioCtx.decodeAudioData(await r.arrayBuffer()); } catch(e){ return null; }
    };
    if (!bufferInimigo) bufferInimigo = await loadSound('cry-of-pain-357978.mp3');
    if (!bufferFilha) bufferFilha = await loadSound('creepy-woman-cry-407580.mp3');
}

function playScream(isBoss, isDaughter) {
    if (!audioCtx || (!bufferInimigo && !isDaughter)) return;
    const s = audioCtx.createBufferSource();
    s.buffer = (isDaughter && bufferFilha) ? bufferFilha : bufferInimigo;
    s.playbackRate.value = isBoss ? 0.6 : 1.0;
    const g = audioCtx.createGain(); g.gain.value = 0.4;
    s.connect(g); g.connect(audioCtx.destination);
    s.start(0);
}

function saveGame() {
    localStorage.setItem('den_shadow_save', JSON.stringify({ room: G.room, maxHp: G.maxHp, dmg: G.dmgMult, spd: G.spdMult }));
}

function loadGame() {
    const saved = JSON.parse(localStorage.getItem('den_shadow_save'));
    if (saved) {
        G.room = saved.room; G.maxHp = saved.maxHp; G.hp = saved.maxHp;
        G.dmgMult = saved.dmg; G.spdMult = saved.spd;
        initGameFlow();
    }
}

function updateWeapon() {
    if (G.room >= 35) { G.weapon = "Vingan√ßa Final"; G.weaponDmg = 150; G.weaponSpd = 120; }
    else if (G.room >= 25) { G.weapon = "Grito do Vazio"; G.weaponDmg = 100; G.weaponSpd = 150; }
    else if (G.room >= 10) { G.weapon = "Alma Corrompida"; G.weaponDmg = 65; G.weaponSpd = 180; }
    document.getElementById('weapon-name').innerText = G.weapon.toUpperCase();
}

function initGameFlow() {
    setupAudio();
    document.getElementById('start-screen').style.display = 'none';
    if (G.room === 0) startCutscene('init');
    else startGame();
}

function startGame() {
    G.play = true; G.inCutscene = false;
    document.getElementById('hud').style.display = 'block';
    if('ontouchstart' in window) document.getElementById('mobile-controls').style.display = 'flex';
    initRoom();
}

function startCutscene(key) {
    G.play = false; G.inCutscene = true;
    storyIdx = 0;
    currentStory = STORY[key] || ["..."];
    document.getElementById('cutscene-screen').style.display = 'flex';
    advanceCutscene();
}

function advanceCutscene() {
    if (storyIdx < currentStory.length) {
        document.getElementById('cutscene-text').innerText = currentStory[storyIdx++];
    } else {
        document.getElementById('cutscene-screen').style.display = 'none';
        if (G.room > 0 && G.room % 10 === 0 && enemies.length === 0) openUpgradeMenu();
        else startGame();
    }
}

function openUpgradeMenu() {
    G.play = false;
    const list = document.getElementById('upgrade-list');
    list.innerHTML = '';
    document.getElementById('upgrade-screen').style.display = 'flex';
    const opts = [
        {n:"CARNE MORTA", d:"+50 Vida M√°x", f:()=>G.maxHp+=50},
        {n:"√ìDIO PURO", d:"+40% Dano", f:()=>G.dmgMult+=0.4},
        {n:"DESESPERO", d:"+20% Velocidade", f:()=>G.spdMult+=0.2}
    ];
    opts.forEach(o => {
        const card = document.createElement('div');
        card.className = 'upgrade-card';
        card.innerHTML = `<h3>${o.n}</h3><p>${o.d}</p>`;
        card.onclick = () => { o.f(); G.hp=G.maxHp; document.getElementById('upgrade-screen').style.display='none'; G.room++; startGame(); };
        list.appendChild(card);
    });
}

function initRoom() {
    enemies = []; projectiles = []; G.enemiesDefeated = false;
    player.x = ROOM.w/2; player.y = ROOM.h - 150;
    updateWeapon();
    saveGame();

    if (G.room > 0 && G.room % 10 === 0) {
        enemies.push({ x: ROOM.w/2, y: 300, hp: 1000 + (G.room * 60), r: 85, spd: 2, type: 'boss' });
    } else if (G.room > 0) {
        let n = 4 + Math.floor(G.room * 0.3);
        for(let i=0; i<n; i++) {
            let type = (G.room > 20 && Math.random() > 0.7) ? 'fast' : (G.room > 35 && Math.random() > 0.8 ? 'tank' : 'normal');
            enemies.push({ x: Math.random()*1400+100, y: Math.random()*400+100, hp: type==='tank'?300:80, r: type==='tank'?45:30, spd: type==='fast'?4:2, type: type });
        }
    } else G.enemiesDefeated = true;
}

function update() {
    if (!G.play || G.inCutscene) return;
    let mx = joyInput.moveX; let my = joyInput.moveY;
    if (keys['w']) my = -1; if (keys['s']) my = 1; if (keys['a']) mx = -1; if (keys['d']) mx = 1;
    player.x = Math.max(ROOM.wall, Math.min(ROOM.w-ROOM.wall, player.x + mx*player.spd*G.spdMult));
    player.y = Math.max(ROOM.wall, Math.min(ROOM.h-ROOM.wall, player.y + my*player.spd*G.spdMult));

    let ax = joyInput.aimX; let ay = joyInput.aimY;
    if (keys['arrowup']) ay = -1; if (keys['arrowdown']) ay = 1;
    if (keys['arrowleft']) ax = -1; if (keys['arrowright']) ax = 1;

    if ((Math.abs(ax)>0.3 || Math.abs(ay)>0.3) && G.ammo>0 && Date.now()-G.lastShot > G.weaponSpd) {
        projectiles.push({ x: player.x, y: player.y, vx: ax*18, vy: ay*18, dmg: (G.kadtr?9999:G.weaponDmg)*G.dmgMult });
        G.ammo--; G.lastShot = Date.now();
    } else if (mx===0 && my===0 && G.ammo<G.maxAmmo) G.ammo += 0.1;

    enemies.forEach((en, ei) => {
        let ang = Math.atan2(player.y-en.y, player.x-en.x);
        en.x += Math.cos(ang)*en.spd; en.y += Math.sin(ang)*en.spd;
        if (Math.hypot(player.x-en.x, player.y-en.y) < player.r+en.r && !G.kadtr) {
            G.hp -= 0.5; if(G.hp <= 0) location.reload();
        }
    });

    projectiles.forEach((p, pi) => {
        p.x += p.vx; p.y += p.vy;
        enemies.forEach((en, ei) => {
            if (Math.hypot(p.x-en.x, p.y-en.y)<en.r) {
                en.hp -= p.dmg; projectiles.splice(pi, 1);
                if (en.hp<=0) { playScream(en.type==='boss', G.room===20); enemies.splice(ei, 1); if(enemies.length===0) G.enemiesDefeated=true; }
            }
        });
    });

    if (G.enemiesDefeated && player.y < 100 && Math.abs(player.x-ROOM.w/2)<100) {
        if (G.room > 0 && G.room % 10 === 0) startCutscene('boss' + G.room);
        else { G.room++; if(G.room === 101) startCutscene('final'); else initRoom(); }
    }
}

function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    if (G.play) update();
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
    if (!G.play && !G.inCutscene) { requestAnimationFrame(draw); return; }
    ctx.save();
    let sc = Math.min(canvas.width/ROOM.w, canvas.height/ROOM.h)*0.95;
    ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(sc, sc); ctx.translate(-ROOM.w/2, -ROOM.h/2);
    ctx.fillStyle = "#050000"; ctx.fillRect(0,0,ROOM.w, ROOM.h);
    if(G.enemiesDefeated) { ctx.fillStyle = "#600"; ctx.fillRect(ROOM.w/2-100, 0, 200, 80); }
    ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();
    enemies.forEach(en => { ctx.fillStyle = en.type==='boss'?"#800":en.type==='fast'?"#f00":"#300"; ctx.beginPath(); ctx.arc(en.x, en.y, en.r, 0, Math.PI*2); ctx.fill(); });
    projectiles.forEach(p => { ctx.fillStyle = "cyan"; ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill(); });
    ctx.restore();
    document.getElementById('hp-fill').style.width = (G.hp/G.maxHp*100) + "%";
    document.getElementById('ammo-fill').style.width = (G.ammo/G.maxAmmo*100) + "%";
    document.getElementById('room-txt').innerText = G.room;
    requestAnimationFrame(draw);
}

function setupJoy(id, type) {
    const c = document.getElementById(id); const s = c.querySelector('.joy-stick');
    const h = (e) => { e.preventDefault(); const t = e.touches[0]; const r = c.getBoundingClientRect();
        let dx = t.clientX - (r.left + 65); let dy = t.clientY - (r.top + 65);
        const d = Math.hypot(dx, dy); if (d > 40) { dx *= 40/d; dy *= 40/d; }
        s.style.transform = `translate(${dx}px, ${dy}px)`; joyInput[type+'X'] = dx/40; joyInput[type+'Y'] = dy/40; };
    c.addEventListener('touchstart', h); c.addEventListener('touchmove', h);
    c.addEventListener('touchend', () => { s.style.transform = 'translate(0,0)'; joyInput[type+'X']=0; joyInput[type+'Y']=0; });
}

window.onload = () => { if(localStorage.getItem('den_shadow_save')) document.getElementById('btn-continue').style.display='block'; setupJoy('move-joy','move'); setupJoy('aim-joy','aim'); draw(); };
window.addEventListener('keydown', e => { const k = e.key.toLowerCase(); keys[k] = true; devCode += k; if (devCode.includes("kadtr")) { G.kadtr = true; document.getElementById('dev-tag').style.display = 'inline'; } if (devCode.length > 10) devCode = ""; });
window.addEventListener('keyup', e => delete keys[e.key.toLowerCase()]);
</script>
</body>
</html>
