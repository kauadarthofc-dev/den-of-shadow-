<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow üíÄ Lord of Light</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&family=Special+Elite&display=swap');
        
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        canvas { display: block; width: 100vw; height: 100vh; }

        /* HUD ESTILO ISAAC */
        #hud-container { position: absolute; inset: 0; pointer-events: none; z-index: 1000; display: none; padding: 15px; }
        
        .hud-left { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 5px; }
        .hud-right { position: absolute; top: 15px; right: 15px; text-align: right; }
        
        .stat-row { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 4px 10px; border-radius: 5px; }
        .bar-outer { width: 120px; height: 10px; background: #222; border: 1px solid #444; overflow: hidden; }
        .bar-inner { height: 100%; transition: width 0.3s; }

        /* MINIMAPA */
        #minimap-canvas { 
            width: 120px; height: 80px; 
            background: rgba(255, 0, 0, 0.05); 
            border: 2px solid rgba(255, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        /* CONTROLES MOBILE VISUAIS */
        .touch-zone { position: absolute; bottom: 0; width: 50%; height: 50%; pointer-events: auto; z-index: 2000; }
        #left-zone { left: 0; }
        #right-zone { right: 0; }
        
        /* Joystick Virtual */
        .joystick-base {
            position: absolute; width: 100px; height: 100px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; display: none; pointer-events: none;
            background: rgba(0,0,0,0.2);
            transform: translate(-50%, -50%);
        }
        .joystick-stick {
            position: absolute; width: 40px; height: 40px;
            background: rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255,0,0,0.5);
        }

        /* Bot√£o Trocar Arma (Mobile) */
        #mobile-swap-btn {
            position: absolute; bottom: 180px; right: 30px;
            width: 60px; height: 60px;
            background: rgba(0,0,0,0.6);
            border: 2px solid #ff4500; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 2100;
            font-size: 30px; color: #ff4500;
            display: none; /* S√≥ aparece via JS se touch */
        }
        #mobile-swap-btn:active { background: #ff4500; color: #000; }

        /* UI TELAS */
        .ui-screen { 
            position: absolute; inset: 0; 
            background: radial-gradient(circle at center, #4a0404 0%, #000000 100%);
            z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        #start-screen h1 { font-family: 'Nosifer', cursive; font-size: clamp(30px, 8vw, 60px); color: #ff0000; text-shadow: 0 0 20px #ff0000; margin: 10px; text-align: center; }
        .btn-main { padding: 15px 40px; font-size: 18px; background: transparent; border: 2px solid #ff0000; color: #fff; cursor: pointer; font-family: 'Orbitron'; margin: 10px; transition: 0.3s; z-index: 3100; }
        .social-links a { color: #ff0000; text-decoration: none; font-size: 12px; display: block; margin: 5px; }
        #cutscene-screen { background: #000; text-align: center; padding: 20px; display: none; }
        #msg-popup { position: absolute; top: 25%; width: 100%; text-align: center; font-size: 24px; color: #ff0000; display: none; z-index: 2000; font-family: 'Nosifer'; pointer-events: none; }

        /* TELA DE UPGRADE */
        #upgrade-screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 4000; display: none; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        .cards-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; padding: 20px; }
        .upg-card {
            width: 200px; height: 280px; background: #111;
            border: 2px solid #444; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 15px; cursor: pointer; text-align: center; transition: 0.2s;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .upg-card:hover { transform: scale(1.05); }
        .upg-rarity { font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .upg-name { font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .upg-desc { font-size: 12px; color: #ccc; }
        
        /* Cores de Raridade */
        .common { border-color: #999; box-shadow: 0 0 10px #999; } .common .upg-rarity { color: #999; }
        .rare { border-color: #00aaff; box-shadow: 0 0 10px #00aaff; } .rare .upg-rarity { color: #00aaff; }
        .epic { border-color: #a0f; box-shadow: 0 0 10px #a0f; } .epic .upg-rarity { color: #a0f; }
        .legendary { border-color: #ffd700; box-shadow: 0 0 20px #ffd700; } .legendary .upg-rarity { color: #ffd700; }

    </style>
</head>
<body>

<div id="hud-container">
    <div class="hud-left">
        <div class="stat-row">
            <span style="color:#ff0000; font-size:12px;">HP</span>
            <div class="bar-outer"><div id="hp-bar" class="bar-inner" style="background:#ff0000; width:100%;"></div></div>
        </div>
        <div class="stat-row">
            <span style="color:#f1c40f; font-size:12px;">AM</span>
            <div class="bar-outer"><div id="ammo-bar" class="bar-inner" style="background:#f1c40f; width:100%;"></div></div>
        </div>
        <div style="font-size: 14px; color: #ff0000; margin-top:5px;">SALA: <span id="room-txt">0</span></div>
        <div style="font-size: 12px; color: #aaa; margin-top:5px;">ARMA: <span id="weapon-txt">LUZ</span></div>
    </div>

    <div class="hud-right">
        <canvas id="minimap-canvas"></canvas>
    </div>

    <div id="left-zone" class="touch-zone"></div>
    <div id="right-zone" class="touch-zone"></div>
    
    <div id="joy-left" class="joystick-base"><div class="joystick-stick"></div></div>
    <div id="joy-right" class="joystick-base"><div class="joystick-stick"></div></div>

    <div id="mobile-swap-btn" onclick="swapWeapon()">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
            <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
            <path d="M16 21h5v-5"></path>
        </svg>
    </div>
</div>

<div id="start-screen" class="ui-screen">
    <h1>DEN OF SHADOW</h1>
    <p id="subtitle" style="letter-spacing: 5px; color: #ff0000; margin-bottom: 20px;">LORD OF LIGHT</p>
    <button class="btn-main" onclick="initCutscene()">JOGAR</button>
    <div class="social-links">
        <a href="mailto:kauaderthofc@gmail.com">kauaderthofc@gmail.com</a>
        <a href="https://youtube.com/@kaua_darth" target="_blank">YouTube: @kaua_darth</a>
    </div>
</div>

<div id="cutscene-screen" class="ui-screen" onclick="nextHistory()">
    <div id="cutscene-text" style="font-family: 'Special Elite'; font-size: 1.2rem; max-width: 80%; line-height: 1.5;"></div>
    <div style="position: absolute; bottom: 40px; font-size: 10px; opacity: 0.5;">TOQUE PARA CONTINUAR</div>
</div>

<div id="upgrade-screen">
    <h2 style="color: #fff; font-family: 'Nosifer'; margin-bottom: 20px;">ESCOLHA UMA D√ÅDIVA</h2>
    <div class="cards-container" id="upgrade-cards-area"></div>
</div>

<div id="msg-popup"></div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mCanvas = document.getElementById('minimap-canvas');
const mCtx = mCanvas.getContext('2d');

const ROOM = { w: 1600, h: 1000, wallSize: 70 };

// --- BANCO DE DADOS DE UPGRADES (25 ITENS) ---
const UPGRADES_DB = [
    // COMUM (50%)
    { id: 'hp1', name: 'Vitalidade Menor', desc: '+20 Max HP', rarity: 'common', apply: p => G.maxHp += 20 },
    { id: 'dmg1', name: 'For√ßa Bruta', desc: '+10% Dano', rarity: 'common', apply: p => p.dmgMult += 0.1 },
    { id: 'spd1', name: 'Botas Leves', desc: '+5% Velocidade', rarity: 'common', apply: p => player.spd *= 1.05 },
    { id: 'ammo1', name: 'Cartucheira', desc: '+5 Muni√ß√£o Max', rarity: 'common', apply: p => { G.maxAmmo += 5; G.ammo += 5; } },
    { id: 'rl1', name: 'M√£os √Ågeis', desc: '-10% Tempo Recarga', rarity: 'common', apply: p => G.reloadTime *= 0.9 },
    { id: 'size1', name: 'Proj√©til Denso', desc: '+15% Tamanho do Tiro', rarity: 'common', apply: p => p.sizeMult += 0.15 },
    { id: 'pspd1', name: 'Aerodin√¢mica', desc: '+10% Vel. Proj√©til', rarity: 'common', apply: p => p.projSpdMult += 0.1 },
    { id: 'heal1', name: 'Curativo', desc: 'Recupera 50 HP Agora', rarity: 'common', apply: p => G.hp = Math.min(G.maxHp, G.hp + 50) },
    
    // RARO (34%)
    { id: 'hp2', name: 'Cora√ß√£o de Pedra', desc: '+50 Max HP', rarity: 'rare', apply: p => G.maxHp += 50 },
    { id: 'dmg2', name: 'L√¢mina Sombria', desc: '+25% Dano', rarity: 'rare', apply: p => p.dmgMult += 0.25 },
    { id: 'spd2', name: 'Passo Fantasma', desc: '+15% Velocidade', rarity: 'rare', apply: p => player.spd *= 1.15 },
    { id: 'fr1', name: 'Gatilho R√°pido', desc: '+20% Cad√™ncia de Tiro', rarity: 'rare', apply: p => p.fireRateMult *= 0.8 },
    { id: 'ammo2', name: 'Caixa de Muni√ß√£o', desc: '+15 Muni√ß√£o Max', rarity: 'rare', apply: p => { G.maxAmmo += 15; G.ammo += 15; } },
    { id: 'vamp1', name: 'Sede de Sangue', desc: '1% Chance de Cura ao matar', rarity: 'rare', apply: p => p.lifesteal += 0.01 },
    { id: 'crt1', name: 'Olho Preciso', desc: '+10% Chance Cr√≠tico', rarity: 'rare', apply: p => p.critChance += 0.1 },

    // √âPICO (15%)
    { id: 'dmg3', name: 'Poder do Lorde', desc: '+50% Dano', rarity: 'epic', apply: p => p.dmgMult += 0.5 },
    { id: 'pierce', name: 'Balas Perfurantes', desc: 'Tiros atravessam 1 inimigo', rarity: 'epic', apply: p => p.pierce += 1 },
    { id: 'regen', name: 'Regenera√ß√£o', desc: 'Recupera 1 HP a cada 5s', rarity: 'epic', apply: p => p.regen = true },
    { id: 'explode', name: 'Muni√ß√£o Explosiva', desc: 'Inimigos explodem ao morrer', rarity: 'epic', apply: p => p.explode = true },
    { id: 'shield', name: 'Escudo Arcano', desc: 'Reduz dano recebido em 20%', rarity: 'epic', apply: p => p.dmgRed += 0.2 },
    
    // LEND√ÅRIO (1%)
    { id: 'multi', name: 'Tiro Duplo', desc: 'Dispara +1 proj√©til extra', rarity: 'legendary', apply: p => p.multishot += 1 },
    { id: 'god', name: 'Imortalidade Menor', desc: '+100 Max HP e +30% Dano', rarity: 'legendary', apply: p => { G.maxHp += 100; p.dmgMult += 0.3; G.hp = G.maxHp; } },
    { id: 'minigun', name: 'Minigun', desc: 'Muni√ß√£o Infinita, Dano Reduzido', rarity: 'legendary', apply: p => { G.infiniteAmmo = true; p.dmgMult *= 0.6; } },
    { id: 'sniper', name: 'Rifle de Elite', desc: 'Dano x3, Cad√™ncia lenta', rarity: 'legendary', apply: p => { p.dmgMult *= 3; p.fireRateMult *= 2; } },
    { id: 'nuke', name: 'Toque da Morte', desc: 'Inimigos morrem com 1 tiro (Boss sofre dano massivo)', rarity: 'legendary', apply: p => p.instakill = true }
];

const G = { 
    play: false, room: 0, hp: 100, maxHp: 100, ammo: 30, maxAmmo: 30, 
    reloading: false, enemiesDefeated: false, 
    lastShot: 0,
    clearedRooms: new Set(),
    reloadTime: 1000,
    infiniteAmmo: false,
    // Player Mods
    mods: { dmgMult: 1, sizeMult: 1, projSpdMult: 1, fireRateMult: 1, lifesteal: 0, critChance: 0, pierce: 0, multishot: 0, dmgRed: 0, instakill: false },
    // Weapons
    weapons: [
        { name: "LUZ", dmg: 40, spd: 20, rate: 200, color: "#fff", size: 10 },
        { name: "FOGO", dmg: 90, spd: 25, rate: 400, color: "#ff4500", size: 18 } // Desbloqueia sala 5
    ],
    curWpn: 0,
    hasFireWpn: false
};

// Controles Touch
let touchMove = { x: 0, y: 0, active: false, startX:0, startY:0 };
let touchShoot = { x: 0, y: 0, active: false, startX:0, startY:0 };

const texts = {
    pt: {
        sub: "LORDE DA LUZ", boss: "GUARDI√ÉO!", weapon: "REL√çQUIA OBTIDA!", upgrade: "PODER OBTIDO!",
        history: [
            "O Lorde da Luz foi tra√≠do por sua pr√≥pria sombra...",
            "Agora ele rasteja no Den of Shadow para recuperar seu poder.",
            "Na Sala 5, uma arma de fogo antiga o espera.",
            "Use o lado esquerdo para andar e o direito para atirar."
        ]
    }
};

let player = { x: 800, y: 800, r: 25, spd: 9 };
let enemies = [], projectiles = [], drops = [], objects = [];
const keys = {};

function initCutscene() {
    document.getElementById('start-screen').style.display='none';
    document.getElementById('cutscene-screen').style.display='flex';
    nextHistory();
    // Detecta mobile para mostrar bot√£o de troca
    if('ontouchstart' in window) document.getElementById('mobile-swap-btn').style.display = 'flex';
}

let hIdx = 0;
function nextHistory() {
    if (hIdx < texts.pt.history.length) {
        document.getElementById('cutscene-text').innerText = texts.pt.history[hIdx++];
    } else {
        startGame();
    }
}

function startGame() {
    document.getElementById('cutscene-screen').style.display='none';
    document.getElementById('hud-container').style.display='block';
    G.play = true;
    G.clearedRooms.add(0);
    initRoom('bottom');
    // Regenera√ß√£o passiva
    setInterval(() => { if(G.mods.regen && G.play && G.hp < G.maxHp) G.hp++; }, 5000);
}

function initRoom(entrySide) {
    enemies = []; projectiles = []; drops = []; objects = [];
    
    if (entrySide === 'bottom') {
        player.x = ROOM.w / 2; player.y = ROOM.h - ROOM.wallSize - 60;
    } else {
        player.x = ROOM.w / 2; player.y = ROOM.wallSize + 60;
    }

    if (G.clearedRooms.has(G.room)) {
        G.enemiesDefeated = true;
    } else {
        G.enemiesDefeated = false;
        if (G.room > 0) {
            let isBoss = G.room % 10 === 0;
            if (isBoss) {
                enemies.push({ x: ROOM.w/2, y: 300, hp: 1000 + (G.room * 100), maxHp: 1000+(G.room*100), r: 90, spd: 3, isBoss: true, offset: 0 });
                showPopup(texts.pt.boss);
            } else {
                let count = 4 + Math.floor(G.room * 0.8);
                for(let i=0; i<count; i++) {
                    enemies.push({ 
                        x: Math.random()*(ROOM.w-300)+150, y: Math.random()*(ROOM.h-500)+150, 
                        hp: 70 + G.room*20, maxHp: 70+G.room*20, r: 32, spd: 2 + (G.room*0.15), offset: Math.random()*10
                    });
                }
            }
        } else { G.enemiesDefeated = true; }
    }

    // Arma Sala 5
    if (G.room === 5 && !G.hasFireWpn && G.enemiesDefeated) {
        objects.push({ type: 'weapon', x: ROOM.w/2, y: ROOM.h/2, r: 40 });
    }
}

function showPopup(t) {
    const p = document.getElementById('msg-popup');
    p.innerText = t; p.style.display = 'block';
    setTimeout(() => p.style.display = 'none', 2000);
}

// --- L√ìGICA DE UPGRADE ---
function spawnUpgradeCrystal() {
    objects.push({ type: 'crystal', x: ROOM.w/2, y: ROOM.h/2, r: 40, angle: 0 });
}

function openUpgradeMenu() {
    G.play = false;
    const container = document.getElementById('upgrade-cards-area');
    container.innerHTML = '';
    
    // Gerar 3 op√ß√µes
    let options = [];
    for(let i=0; i<3; i++) options.push(getWeightedUpgrade());

    options.forEach(upg => {
        const div = document.createElement('div');
        div.className = `upg-card ${upg.rarity}`;
        div.innerHTML = `
            <div class="upg-rarity">${upg.rarity}</div>
            <div class="upg-name">${upg.name}</div>
            <div style="font-size:30px; margin:10px;">üîÆ</div>
            <div class="upg-desc">${upg.desc}</div>
        `;
        div.onclick = () => selectUpgrade(upg);
        container.appendChild(div);
    });

    document.getElementById('upgrade-screen').style.display = 'flex';
}

function getWeightedUpgrade() {
    const r = Math.random() * 100;
    let pool = [];
    let rarity = 'common';
    
    if (r <= 50) rarity = 'common';
    else if (r <= 84) rarity = 'rare';
    else if (r <= 99) rarity = 'epic';
    else rarity = 'legendary';

    pool = UPGRADES_DB.filter(u => u.rarity === rarity);
    if(pool.length === 0) pool = UPGRADES_DB.filter(u => u.rarity === 'common'); // Fallback
    return pool[Math.floor(Math.random() * pool.length)];
}

function selectUpgrade(upg) {
    upg.apply(G.mods);
    document.getElementById('upgrade-screen').style.display = 'none';
    G.play = true;
    showPopup(texts.pt.upgrade);
    requestAnimationFrame(draw); // Resume loop
}

function swapWeapon() {
    if(!G.hasFireWpn) return;
    G.curWpn = (G.curWpn === 0) ? 1 : 0;
    const w = G.weapons[G.curWpn];
    document.getElementById('weapon-txt').innerText = w.name;
    document.getElementById('weapon-txt').style.color = w.color;
}

// --- INPUTS ---
function updateJoystickVisual(id, obj, joyId) {
    const base = document.getElementById(joyId);
    const stick = base.querySelector('.joystick-stick');
    
    if (obj.active) {
        base.style.display = 'block';
        base.style.left = obj.startX + 'px';
        base.style.top = obj.startY + 'px';
        
        // Limitar movimento visual do stick
        let dx = obj.x; 
        let dy = obj.y;
        let dist = Math.hypot(dx, dy);
        let maxDist = 50; // Raio da base
        
        if (dist > maxDist) {
            dx = (dx / dist) * maxDist;
            dy = (dy / dist) * maxDist;
        }
        
        stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    } else {
        base.style.display = 'none';
    }
}

const setupTouch = (id, obj, joyId) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', e => { 
        e.preventDefault();
        obj.active = true;
        const t = e.changedTouches[0];
        obj.startX = t.clientX; obj.startY = t.clientY;
        obj.x = 0; obj.y = 0;
        updateJoystickVisual(id, obj, joyId);
    });
    el.addEventListener('touchmove', e => {
        e.preventDefault();
        // Encontrar o toque correto pelo ID se poss√≠vel, ou area
        for (let i=0; i<e.touches.length; i++) {
            const t = e.touches[i];
            // L√≥gica simples de zona
            let inZone = (id === 'left-zone' && t.clientX < window.innerWidth/2) || 
                         (id === 'right-zone' && t.clientX > window.innerWidth/2);
            
            if(inZone) {
                obj.x = t.clientX - obj.startX;
                obj.y = t.clientY - obj.startY;
                updateJoystickVisual(id, obj, joyId);
            }
        }
    });
    el.addEventListener('touchend', (e) => { 
        obj.active = false; obj.x = 0; obj.y = 0; 
        updateJoystickVisual(id, obj, joyId);
    });
};

setupTouch('left-zone', touchMove, 'joy-left');
setupTouch('right-zone', touchShoot, 'joy-right');

function update() {
    if(!G.play) return;

    // Tecla Q ou Space para trocar arma
    if(keys['q'] || keys[' ']) {
        if(!keys.blockSwap) { swapWeapon(); keys.blockSwap = true; }
    } else { keys.blockSwap = false; }

    // Movimento
    let mx = 0, my = 0;
    if(keys['w']) my = -1; if(keys['s']) my = 1; if(keys['a']) mx = -1; if(keys['d']) mx = 1;
    if(touchMove.active) {
        let dist = Math.hypot(touchMove.x, touchMove.y);
        if(dist > 10) { mx = touchMove.x/dist; my = touchMove.y/dist; }
    }
    player.x = Math.max(ROOM.wallSize+25, Math.min(ROOM.w-ROOM.wallSize-25, player.x + mx*player.spd));
    player.y = Math.max(ROOM.wallSize+25, Math.min(ROOM.h-ROOM.wallSize-25, player.y + my*player.spd));

    // Tiro
    let ax = 0, ay = 0;
    if(keys['arrowup']) ay = -1; if(keys['arrowdown']) ay = 1; if(keys['arrowleft']) ax = -1; if(keys['arrowright']) ax = 1;
    if(touchShoot.active) {
        let dist = Math.hypot(touchShoot.x, touchShoot.y);
        if(dist > 20) { ax = touchShoot.x/dist; ay = touchShoot.y/dist; }
    }

    if((ax || ay) && !G.reloading) {
        if(G.ammo > 0 || G.infiniteAmmo) {
            const wpn = G.weapons[G.curWpn];
            const fireDelay = wpn.rate * G.mods.fireRateMult;
            
            if(Date.now() - G.lastShot > fireDelay) {
                const baseDmg = wpn.dmg * G.mods.dmgMult;
                const baseSize = wpn.size * G.mods.sizeMult;
                const baseSpd = wpn.spd * G.mods.projSpdMult;

                const shoot = (vx, vy) => {
                    projectiles.push({ 
                        x: player.x, y: player.y, vx: vx, vy: vy, 
                        r: baseSize, dmg: baseDmg, color: wpn.color,
                        pierce: G.mods.pierce 
                    });
                };

                shoot(ax*baseSpd, ay*baseSpd);
                if(G.mods.multishot > 0) {
                    shoot((ax*0.9 - ay*0.2)*baseSpd, (ay*0.9 + ax*0.2)*baseSpd); // +Tiro torto
                }
                
                if(!G.infiniteAmmo) G.ammo--;
                G.lastShot = Date.now();
            }
        } else {
            G.reloading = true;
            setTimeout(() => { G.ammo = G.maxAmmo; G.reloading = false; }, G.reloadTime);
        }
    }

    // Inimigos
    enemies.forEach((en) => {
        let dx = player.x - en.x, dy = player.y - en.y, dist = Math.hypot(dx, dy);
        let mX = dx/dist, mY = dy/dist;
        if(!en.isBoss) { mX += Math.cos(Date.now()*0.005 + en.offset)*0.25; mY += Math.sin(Date.now()*0.005 + en.offset)*0.25; }
        en.x += mX * en.spd; en.y += mY * en.spd;
        if(dist < player.r + en.r) {
            let dmg = en.isBoss ? 0.9 : 0.6;
            if(G.mods.dmgRed > 0) dmg *= (1 - G.mods.dmgRed);
            G.hp -= dmg;
        }
    });

    // Colis√µes Proj√©teis
    projectiles.forEach((p, pi) => {
        p.x += p.vx; p.y += p.vy;
        
        // Remove fora da tela
        if(p.x < 0 || p.x > ROOM.w || p.y < 0 || p.y > ROOM.h) { projectiles.splice(pi, 1); return; }

        for (let ei = enemies.length - 1; ei >= 0; ei--) {
            let en = enemies[ei];
            if(Math.hypot(p.x-en.x, p.y-en.y) < en.r + p.r) {
                // Dano
                let finalDmg = p.dmg;
                // Cr√≠tico
                if(Math.random() < G.mods.critChance) finalDmg *= 2;
                // Instakill (Lend√°rio)
                if(G.mods.instakill && !en.isBoss) finalDmg = en.hp + 10;
                if(G.mods.instakill && en.isBoss) finalDmg *= 1.5;

                en.hp -= finalDmg;
                
                // Explos√£o (√âpico)
                if(G.mods.explode && en.hp <= 0) {
                    // Causa dano em √°rea (simulado)
                }

                // Vampirismo
                if(en.hp <= 0 && Math.random() < G.mods.lifesteal) G.hp = Math.min(G.maxHp, G.hp + 5);

                // Perfura√ß√£o
                if(p.pierce > 0) {
                    p.pierce--;
                } else {
                    projectiles.splice(pi, 1);
                }

                if(en.hp <= 0) {
                    if(Math.random() < 0.4) drops.push({x: en.x, y: en.y});
                    enemies.splice(ei, 1);
                }
                break; // Atingiu um inimigo, para loop (se n√£o perfurar)
            }
        }
    });

    drops.forEach((d, i) => { if(Math.hypot(player.x-d.x, player.y-d.y) < 50) { G.hp = Math.min(G.maxHp, G.hp+25); drops.splice(i, 1); } });

    // Objetos (Armas, Cristais)
    objects.forEach((o, i) => {
        if(o.type === 'crystal') o.angle += 0.05;
        if(Math.hypot(player.x-o.x, player.y-o.y) < o.r + player.r) {
            if(o.type === 'weapon') {
                G.hasFireWpn = true; 
                objects.splice(i, 1); 
                showPopup(texts.pt.weapon);
                document.getElementById('mobile-swap-btn').style.display = 'flex'; // Exibe bot√£o se mobile
            }
            if(o.type === 'crystal') {
                objects.splice(i, 1);
                openUpgradeMenu();
            }
        }
    });

    // Limpeza da Sala
    if(enemies.length === 0 && !G.enemiesDefeated) {
        G.enemiesDefeated = true;
        G.clearedRooms.add(G.room);
        
        // Spawn de Recompensa
        if(G.room > 0 && G.room % 10 === 0) {
            spawnUpgradeCrystal();
        }
    }

    // Portas
    if (G.enemiesDefeated && objects.length === 0) { // S√≥ libera porta se pegar recompensa
        const doorW = 200;
        if (player.y < ROOM.wallSize + 30 && player.x > ROOM.w/2 - doorW/2 && player.x < ROOM.w/2 + doorW/2) {
            G.room++; initRoom('bottom');
        }
        if (G.room > 0 && player.y > ROOM.h - ROOM.wallSize - 30 && player.x > ROOM.w/2 - doorW/2 && player.x < ROOM.w/2 + doorW/2) {
            G.room--; initRoom('top');
        }
    }

    if(G.hp <= 0) location.reload();
}

function drawMinimap() {
    mCtx.clearRect(0,0,mCanvas.width, mCanvas.height);
    const sw = mCanvas.width / ROOM.w;
    const sh = mCanvas.height / ROOM.h;

    mCtx.fillStyle = "#fff"; mCtx.fillRect(player.x * sw, player.y * sh, 4, 4);
    mCtx.fillStyle = "#f00"; enemies.forEach(en => mCtx.fillRect(en.x * sw, en.y * sh, 3, 3));
    
    // Objetos no mapa
    objects.forEach(o => {
        mCtx.fillStyle = o.type === 'crystal' ? '#0ff' : '#f1c40f';
        mCtx.fillRect(o.x * sw, o.y * sh, 5, 5);
    });

    if(G.enemiesDefeated && objects.length === 0) {
        mCtx.strokeStyle = "#f00";
        mCtx.strokeRect((ROOM.w/2-50)*sw, 0, 100*sw, 10*sh);
        if(G.room > 0) mCtx.strokeRect((ROOM.w/2-50)*sw, mCanvas.height - 10*sh, 100*sw, 10*sh);
    }
}

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
    if(!G.play && document.getElementById('upgrade-screen').style.display !== 'flex') { requestAnimationFrame(draw); return; }
    
    // Se tela de upgrade estiver aberta, n√£o atualiza l√≥gica, s√≥ desenha fundo
    if(document.getElementById('upgrade-screen').style.display !== 'flex') {
        update();
    }
    
    drawMinimap();

    ctx.save();
    let s = Math.min(canvas.width/ROOM.w, canvas.height/ROOM.h);
    ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(s,s); ctx.translate(-ROOM.w/2, -ROOM.h/2);

    // Cen√°rio
    ctx.fillStyle = "#0d0000"; ctx.fillRect(0,0,ROOM.w,ROOM.h);
    ctx.fillStyle = "#1a0000"; 
    ctx.fillRect(0,0,ROOM.w,ROOM.wallSize); ctx.fillRect(0,ROOM.h-ROOM.wallSize,ROOM.w,ROOM.wallSize);
    ctx.fillRect(0,0,ROOM.wallSize,ROOM.h); ctx.fillRect(ROOM.w-ROOM.wallSize,0,ROOM.wallSize,ROOM.h);

    if(G.enemiesDefeated && objects.length === 0) {
        ctx.fillStyle = "#ff0000"; ctx.shadowBlur = 30; ctx.shadowColor = "#f00";
        ctx.fillRect(ROOM.w/2-100, 0, 200, ROOM.wallSize + 15);
        if (G.room > 0) ctx.fillRect(ROOM.w/2-100, ROOM.h - ROOM.wallSize - 15, 200, ROOM.wallSize + 15);
        ctx.shadowBlur = 0;
    }

    // Objetos
    objects.forEach(o => {
        if(o.type === 'weapon') {
            ctx.fillStyle = "#333"; ctx.fillRect(o.x-50, o.y-40, 100, 80);
            ctx.fillStyle = "#ff4500"; ctx.font = "45px Arial"; ctx.fillText("üî´", o.x-22, o.y+15);
        }
        if(o.type === 'crystal') {
            ctx.save();
            ctx.translate(o.x, o.y); ctx.rotate(o.angle);
            ctx.fillStyle = "#00ffff"; ctx.shadowColor = "#00ffff"; ctx.shadowBlur = 20;
            ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(20, 0); ctx.lineTo(0, 30); ctx.lineTo(-20, 0); ctx.fill();
            ctx.restore();
        }
    });

    drops.forEach(d => { ctx.fillStyle = "#fff"; ctx.font = "35px Orbitron"; ctx.fillText("‚ûï", d.x-15, d.y+15); });

    enemies.forEach(en => {
        ctx.fillStyle = en.isBoss ? "#600" : "#f00";
        ctx.beginPath(); ctx.arc(en.x, en.y, en.r, 0, Math.PI*2); ctx.fill();
        let hpPct = en.hp / en.maxHp;
        ctx.fillStyle = "#222"; ctx.fillRect(en.x-40, en.y-en.r-20, 80, 8);
        ctx.fillStyle = "#f00"; ctx.fillRect(en.x-40, en.y-en.r-20, 80 * hpPct, 8);
    });

    ctx.fillStyle = G.reloading ? "#444" : "#fff";
    ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();
    // Indicador da arma atual
    ctx.strokeStyle = G.weapons[G.curWpn].color; ctx.lineWidth = 5; ctx.stroke();
    
    projectiles.forEach(p => { 
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill(); 
    });

    ctx.restore();
    
    document.getElementById('hp-bar').style.width = (G.hp/G.maxHp*100) + "%";
    document.getElementById('ammo-bar').style.width = G.infiniteAmmo ? "100%" : (G.ammo/G.maxAmmo*100) + "%";
    document.getElementById('room-txt').innerText = G.room;
    
    requestAnimationFrame(draw);
}

window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => delete keys[e.key.toLowerCase()]);
window.onresize = () => { 
    canvas.width = window.innerWidth; canvas.height = window.innerHeight; 
    mCanvas.width = 120; mCanvas.height = 80;
};
window.onresize(); draw();
</script>
</body>
</html>
