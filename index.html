<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow ðŸ’€</title>
    <style>
        :root {
            --comum: #3498db; --incomum: #2ecc71; --raro: #f1c40f; 
            --epico: #9b59b6; --lendario: linear-gradient(45deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
        }
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #0f172a; color: white; font-family: 'Segoe UI', Tahoma, sans-serif; overflow: hidden; }
        canvas { display: block; image-rendering: pixelated; }

        /* UI SCREENS */
        .screen { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .title-box { border: 4px solid #fff; padding: 20px; background: rgba(231, 76, 60, 0.1); box-shadow: 0 0 30px #e74c3c; border-radius: 15px; margin-bottom: 20px; }
        
        /* SAVE SLOTS */
        .save-container { display: flex; gap: 15px; margin: 20px 0; }
        .save-slot { width: 100px; height: 100px; border: 3px solid #444; background: #1e293b; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .save-slot.active { border-color: #2ecc71; transform: scale(1.1); box-shadow: 0 0 15px #2ecc71; }
        .save-slot span { font-size: 10px; color: #94a3b8; }

        /* HUD & MOBILE */
        #hud-top { position: absolute; top: 10px; left: 10px; z-index: 1000; pointer-events: none; }
        #boss-ui { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 60%; display: none; }
        .hp-bar { width: 200px; height: 20px; background: #334155; border: 2px solid #fff; border-radius: 10px; overflow: hidden; margin-bottom: 5px; }
        .hp-fill { height: 100%; background: #ef4444; width: 100%; transition: 0.2s; }
        
        #mobile-controls { position: absolute; inset: 0; pointer-events: none; display: none; }
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; width: 60px; height: 60px; background: #fff; border-radius: 50%; left: 38px; top: 38px; }
        #btn-grid { position: absolute; bottom: 40px; right: 40px; display: grid; grid-template-columns: repeat(3, 85px); gap: 10px; pointer-events: auto; }
        .btn-m { width: 85px; height: 85px; background: rgba(255,255,255,0.1); border: 3px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        #swap-mob { position: absolute; bottom: 40px; right: 350px; width: 90px; height: 90px; background: #f1c40f; border: 3px solid #fff; border-radius: 20px; pointer-events: auto; color: #000; font-weight: bold; }
        #fs-mob { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: #333; border: 2px solid #fff; border-radius: 20px; pointer-events: auto; z-index: 2500; }

        /* CARDS */
        .card-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .card { width: 220px; height: 320px; background: #1e293b; border: 4px solid #fff; border-radius: 15px; padding: 15px; cursor: pointer; position: relative; }
        .card::before { content: 'ðŸ’€'; position: absolute; opacity: 0.05; font-size: 100px; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        #weapon-info { position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px; border: 2px solid #f1c40f; display: none; border-radius: 10px; }
    </style>
</head>
<body>

<div id="fs-mob" onclick="toggleFS()">TELA CHEIA</div>

<div id="start-screen" class="screen">
    <div class="title-box">
        <h1 style="color:#e74c3c; margin:0; font-size: 50px;">Den of Shadow ðŸ’€</h1>
    </div>
    <div id="platform-tips" style="color:#f1c40f; font-weight:bold; margin-bottom:10px;"></div>
    
    <div class="save-container">
        <div class="save-slot active" onclick="selectSlot(0)" id="slot-0">SLOT 1<span id="txt-0">Vazio</span></div>
        <div class="save-slot" onclick="selectSlot(1)" id="slot-1">SLOT 2<span id="txt-2">Vazio</span></div>
        <div class="save-slot" onclick="selectSlot(2)" id="slot-2">SLOT 3<span id="txt-2">Vazio</span></div>
    </div>

    <button style="padding:15px 50px; background:#2ecc71; border:none; border-radius:30px; color:#fff; font-weight:bold; font-size:20px; cursor:pointer;" onclick="startGame()">JOGAR</button>
    
    <div style="margin-top:30px; font-size:14px;">
        <a href="mailto:kauadarthofc@gmail.com" style="color:#94a3b8; text-decoration:none;">ðŸ“§ kauadarthofc@gmail.com</a><br><br>
        <a href="https://youtube.com/@kaua_darth" target="_blank" style="color:#ff0000; text-decoration:none; font-weight:bold;">ðŸŽ¬ @kaua_darth</a>
    </div>
</div>

<div id="upgrade-screen" class="screen" style="display:none;">
    <h2 style="color:#f1c40f">ESCOLHA SEU DESTINO</h2>
    <div id="card-box" class="card-container"></div>
</div>

<div id="hud-top">
    <div class="hp-bar"><div id="hp-fill" class="hp-fill"></div></div>
    <div id="ammo-ui" style="font-weight:bold;">Magnum: 20/20</div>
    <div id="coins-ui" style="color:#f1c40f;">ðŸ’° Moedas: 0</div>
    <div id="room-ui">Sala: 0 (Tutorial)</div>
</div>

<div id="boss-ui">
    <div id="boss-name" style="color:#ef4444; font-weight:bold; text-align:center;">BOSS</div>
    <div class="hp-bar" style="width:100%;"><div id="boss-hp-fill" class="hp-fill"></div></div>
</div>

<div id="weapon-info"></div>
<canvas id="gameCanvas"></canvas>

<div id="mobile-controls">
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="btn-grid">
        <div></div><div class="btn-m" data-dir="up">â–²</div><div></div>
        <div class="btn-m" data-dir="left">â—€</div><div class="btn-m" data-dir="down">â–¼</div><div class="btn-m" data-dir="right">â–¶</div>
    </div>
    <button id="swap-mob">SWAP ðŸ”„</button>
</div>

<script>
/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const isMob = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// --- ESTADO DO JOGO ---
let G = {
    play: false, slot: 0, room: 0, coins: 0, mode: 'normal',
    w: 3000, h: 2200, cx: 0, cy: 0,
    hp: 12, maxHp: 12,
    weapon: 'magnum',
    owned: ['magnum'],
    inv: {
        magnum: { n: "Magnum", a: 20, m: 20, d: 15, cd: 18, type: 'pistol', c: '#3498db' },
        fire: { n: "LanÃ§a-Chamas", a: 40, m: 40, d: 4, burn: 2, cd: 3, type: 'flame', c: '#f97316' },
        shotgun: { n: "Shotgun", a: 8, m: 8, d: 10, cd: 65, type: 'shotgun', c: '#f1c40f' },
        staff: { n: "Cajado MÃ­stico", a: 12, m: 12, d: 8, cd: 35, type: 'staff', c: '#a855f7' },
        acid: { n: "LanÃ§a-Ãcido", a: 30, m: 30, d: 3, burn: 4, cd: 5, type: 'flame', c: '#22c55e' },
        minigun: { n: "Minigun", a: 100, m: 100, d: 5, cd: 4, type: 'pistol', c: '#94a3b8' },
        god_staff: { n: "Cajado Divino", a: 10, m: 10, d: 25, cd: 50, type: 'staff', c: '#fff' }
    },
    upgrades: { triple: 0, ric: 0, dual: false, vamp: 0 },
};

let p = { x: 1500, y: 1100, r: 60, spd: 9, rot: 0, leg: 0, iframe: 0, rel: false, relT: 0, alive: true, t: 0 };
let enemies = [], projectiles = [], drops = [], items = [], warns = [], particles = [], doors = [];

const keys = new Set();
const mobAtk = { up: false, down: false, left: false, right: false };
const joy = { active: false, x: 0, y: 0 };

// --- SALVAMENTO ---
function selectSlot(i) {
    G.slot = i;
    document.querySelectorAll('.save-slot').forEach(s => s.classList.remove('active'));
    document.getElementById(`slot-${i}`).classList.add('active');
}
function saveGame() {
    const data = { room: G.room, coins: G.coins, hp: G.hp, owned: G.owned, up: G.upgrades };
    localStorage.setItem(`dos_save_${G.slot}`, JSON.stringify(data));
}

// --- MECÃ‚NICAS DE SALA ---
function spawnRoom() {
    enemies = []; projectiles = []; drops = []; items = []; warns = []; doors = [];
    p.iframe = 60;
    
    // Gerar Portas (AleatÃ³rias)
    if(G.room > 0) {
        doors.push({ x: Math.random()*(G.w-400)+200, y: 50, type: 'next', r: 80 });
        if(G.room % 10 === 0) doors.push({ x: 50, y: G.h/2, type: 'heal', r: 80 });
        if(G.room % 11 === 0) doors.push({ x: G.w-50, y: G.h/2, type: 'shop', r: 80 });
    }

    if(G.room === 0) return; // Tutorial vazio

    // Boss
    if(G.room % 10 === 0) {
        let hp = 1500 + (G.room * 200);
        enemies.push({ type: 'boss', x: G.w/2, y: G.h/2-400, r: 200, hp: hp, mhp: hp, t: 0, name: "Sombra do Caos" });
        document.getElementById('boss-ui').style.display = 'block';
    } else {
        let count = 6 + Math.floor(G.room/2);
        for(let i=0; i<count; i++) {
            let ex, ey;
            do { ex = Math.random()*G.w; ey = Math.random()*G.h; } while(Math.hypot(ex-p.x, ey-p.y) < 800);
            let t = G.room < 2 ? 'stalker' : (Math.random()<0.2 ? 'kamikaze' : (Math.random()<0.2 ? 'dasher' : 'stalker'));
            enemies.push({ type: t, x: ex, y: ey, r: 60, hp: 120 + G.room*10, spd: (t==='kamikaze'?1.5:2.5), hit: 0, dt: 0, f: Math.floor(Math.random()*3) });
        }
    }
}

function shoot(dx, dy) {
    const w = G.inv[G.weapon];
    if(p.rel || w.a <= 0 || !p.alive) return;

    if(p.t % w.cd === 0) {
        p.rot = Math.atan2(dy, dx);
        let n = 1 + G.upgrades.triple;
        for(let i=0; i<n; i++) {
            let a = p.rot + (i - (n-1)/2) * 0.2;
            if(w.type === 'flame') {
                projectiles.push({ x: p.x, y: p.y, dx: Math.cos(a)*20, dy: Math.sin(a)*20, type: G.weapon, life: 18, dmg: w.d });
            } else if(w.type === 'shotgun') {
                for(let j=-1; j<=1; j++) projectiles.push({ x: p.x, y: p.y, dx: Math.cos(a+j*0.3)*25, dy: Math.sin(a+j*0.3)*25, type: G.weapon, life: 12, dmg: 17 });
            } else if(w.type === 'staff') {
                projectiles.push({ x: p.x, y: p.y, dx: Math.cos(a)*15, dy: Math.sin(a)*15, type: G.weapon, life: 100, dmg: w.d, home: true });
            } else {
                projectiles.push({ x: p.x, y: p.y, dx: Math.cos(a)*28, dy: Math.sin(a)*28, type: G.weapon, life: 80, dmg: w.d });
            }
        }
        w.a--; if(w.a <= 0) p.rel = true;
    }
}

function update() {
    if(!G.play || !p.alive) return;

    // Player Move
    let mx=0, my=0;
    if(keys.has('a')) mx=-1; if(keys.has('d')) mx=1;
    if(keys.has('w')) my=-1; if(keys.has('s')) my=1;
    if(joy.active) { mx=joy.x; my=joy.y; }
    p.x = Math.max(80, Math.min(G.w-80, p.x + mx * p.spd));
    p.y = Math.max(80, Math.min(G.h-80, p.y + my * p.spd));

    // Player Shoot
    let ax=0, ay=0;
    if(keys.has('arrowleft')) ax=-1; if(keys.has('arrowright')) ax=1;
    if(keys.has('arrowup')) ay=-1; if(keys.has('arrowdown')) ay=1;
    if(mobAtk.up) ay=-1; if(mobAtk.down) ay=1; if(mobAtk.left) ax=-1; if(mobAtk.right) ax=1;

    if(ax!==0 || ay!==0) { shoot(ax, ay); }
    else if(mx!==0 || my!==0) { p.rot = Math.atan2(my, mx); p.leg += 0.25; }

    if(p.rel) { p.relT++; if(p.relT > 50) { G.inv[G.weapon].a = G.inv[G.weapon].m; p.rel=false; p.relT=0; } }

    // Inimigos
    enemies.forEach((e, i) => {
        let dist = Math.hypot(p.x-e.x, p.y-e.y);
        let ang = Math.atan2(p.y-e.y, p.x-e.x);

        if(e.type === 'boss') {
            e.t++; e.x += Math.cos(e.t/40)*6;
            if(e.t % 90 === 0) warns.push({ x: p.x, y: p.y, t: 80 });
            document.getElementById('boss-hp-fill').style.width = (e.hp/e.mhp)*100 + "%";
        } else {
            let s = e.spd;
            if(e.type === 'dasher') { e.dt++; if(e.dt>70){ s=16; if(e.dt>85)e.dt=0; } }
            e.x += Math.cos(ang)*s; e.y += Math.sin(ang)*s;
        }

        // ColisÃ£o Player
        if(dist < p.r + e.r) {
            let kb = Math.atan2(e.y-p.y, e.x-p.x);
            e.x += Math.cos(kb)*50; e.y += Math.sin(kb)*50;
            if(p.iframe <= 0) { G.hp -= (e.type==='kamikaze'?2:1); p.iframe=60; if(e.type==='kamikaze') e.hp=0; }
        }

        if(e.hp <= 0) {
            if(e.type === 'kamikaze') {
                enemies.forEach(o => { if(Math.hypot(e.x-o.x, e.y-o.y) < 300) o.hp -= 200; });
                for(let k=0; k<10; k++) particles.push({ x: e.x, y: e.y, dx: (Math.random()-0.5)*15, dy: (Math.random()-0.5)*15, c: '#f00', l: 20 });
            }
            if(Math.random() < 0.2) drops.push({ x: e.x, y: e.y, type: (Math.random()<0.5?'heal':'ammo') });
            if(e.type === 'boss') document.getElementById('boss-ui').style.display='none';
            enemies.splice(i, 1);
        }
    });

    // ProjÃ©teis
    projectiles.forEach((pr, i) => {
        if(pr.home) {
            let t = enemies[0];
            if(t) { let ta = Math.atan2(t.y-pr.y, t.x-pr.x); pr.dx += Math.cos(ta)*0.9; pr.dy += Math.sin(ta)*0.9; }
        }
        pr.x += pr.dx; pr.y += pr.dy; pr.life--;
        enemies.forEach(e => {
            if(Math.hypot(pr.x-e.x, pr.y-e.y) < e.r + 20) {
                e.hp -= pr.dmg; e.hit = 10;
                projectiles.splice(i, 1);
            }
        });
        if(pr.life <= 0) projectiles.splice(i, 1);
    });

    // Portas & Itens
    if(enemies.length === 0) {
        doors.forEach(d => {
            if(Math.hypot(p.x-d.x, p.y-d.y) < d.r) {
                if(d.type === 'next') { G.room++; spawnRoom(); p.y = G.h-200; }
                if(d.type === 'heal') { G.hp = G.maxHp; G.room++; spawnRoom(); p.x = G.w-200; }
            }
        });
    }

    drops.forEach((d, i) => {
        if(Math.hypot(p.x-d.x, p.y-d.y) < 70) {
            if(d.type==='heal') G.hp = Math.min(G.maxHp, G.hp+2);
            if(d.type==='ammo') G.inv[G.weapon].a = G.inv[G.weapon].m;
            drops.splice(i,1);
        }
    });

    warns.forEach((w, i) => { w.t--; if(w.t <= 0) { projectiles.push({ x: w.x, y: w.y-1000, dx: 0, dy: 25, type: 'magnum', dmg: 3, life: 100 }); warns.splice(i, 1); } });

    document.getElementById('hp-fill').style.width = (G.hp/G.maxHp)*100 + "%";
    document.getElementById('ammo-ui').innerText = `${G.inv[G.weapon].n}: ${G.inv[G.weapon].a}/${G.inv[G.weapon].m}`;
    document.getElementById('room-ui').innerText = `Sala: ${G.room}`;

    if(G.hp <= 0) p.alive = false;
    p.t++;
}

// --- RENDER ---
function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    if(!G.play) return;

    ctx.save();
    G.cx += (p.x - canvas.width/2 - G.cx) * 0.1;
    G.cy += (p.y - canvas.height/2 - G.cy) * 0.1;
    ctx.translate(-G.cx, -G.cy);

    // Chao
    ctx.fillStyle = "#1e293b"; ctx.fillRect(0,0, G.w, G.h);
    ctx.strokeStyle = "#334155"; ctx.lineWidth=4;
    for(let x=0; x<G.w; x+=100) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,G.h); ctx.stroke(); }
    for(let y=0; y<G.h; y+=100) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(G.w,y); ctx.stroke(); }

    // Lorde da Luz
    if(p.alive) {
        let ly = Math.sin(p.t/4)*10;
        ctx.fillStyle="#fff"; ctx.fillRect(p.x-20, p.y+40+ly, 12, 18); ctx.fillRect(p.x+8, p.y+40-ly, 12, 18);
        ctx.shadowBlur=20; ctx.shadowColor="#00eaff";
        ctx.fillStyle = (p.iframe>0 && p.t%4<2) ? "#f00" : "#fff";
        ctx.fillRect(p.x-40, p.y-50, 80, 100); ctx.shadowBlur=0;
        // Arma
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot);
        ctx.fillStyle="#475569"; ctx.fillRect(35, -10, 50, 20); ctx.restore();
    }

    // Inimigos
    enemies.forEach(e => {
        ctx.fillStyle = e.type==='kamikaze'?'#ef4444':'#475569';
        ctx.fillRect(e.x-e.r, e.y-e.r, e.r*2, e.r*2);
        ctx.fillStyle='#000'; ctx.font="30px Arial";
        ctx.fillText(e.type==='kamikaze'?'Ã²_Ã³':'o_o', e.x-25, e.y+10);
    });

    // Portas
    if(enemies.length === 0) {
        doors.forEach(d => {
            ctx.fillStyle = d.type==='next'?'#f1c40f':(d.type==='shop'?'#2ecc71':'#22c55e');
            ctx.fillRect(d.x-d.r, d.y-d.r, d.r*2, d.r*2);
            if(d.type==='shop') { ctx.fillStyle="#000"; ctx.fillText("$", d.x-10, d.y+10); }
        });
    }

    projectiles.forEach(pr => { ctx.fillStyle=G.inv[pr.type].c; ctx.beginPath(); ctx.arc(pr.x, pr.y, 15, 0, 7); ctx.fill(); });
    drops.forEach(d => { ctx.fillStyle=d.type==='heal'?'#ef4444':'#f1c40f'; ctx.fillRect(d.x-20, d.y-20, 40, 40); });

    ctx.restore();

    // Minimapa
    const mx=canvas.width-220, my=20, ms=200;
    ctx.fillStyle="rgba(0,0,0,0.8)"; ctx.fillRect(mx, my, ms, ms);
    enemies.forEach(e => { ctx.fillStyle="red"; ctx.fillRect(mx+(e.x/G.w)*ms, my+(e.y/G.h)*ms, 4, 4); });
    if(enemies.length === 0) doors.forEach(d => { ctx.fillStyle="yellow"; ctx.fillRect(mx+(d.x/G.w)*ms, my+(d.y/G.h)*ms, 6, 6); });
    ctx.fillStyle="#00eaff"; ctx.fillRect(mx+(p.x/G.w)*ms, my+(p.y/G.h)*ms, 8, 8);

    requestAnimationFrame(() => { update(); draw(); });
}

// --- CONTROLES ---
function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    if(isMob) document.getElementById('mobile-controls').style.display = 'block';
    G.play = true; spawnRoom(); draw();
}

const jBase=document.getElementById('joy-base'), jStick=document.getElementById('joy-stick');
jBase.ontouchstart = () => joy.active = true;
jBase.ontouchmove = (e) => {
    let t = e.touches[0]; let r = jBase.getBoundingClientRect();
    let dx = t.clientX - (r.left+70), dy = t.clientY - (r.top+70);
    let d = Math.min(Math.hypot(dx,dy), 50); let a = Math.atan2(dy,dx);
    joy.x = (Math.cos(a)*d)/50; joy.y = (Math.sin(a)*d)/50;
    jStick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
};
jBase.ontouchend = () => { joy.active=false; joy.x=0; joy.y=0; jStick.style.transform='none'; };

document.querySelectorAll('.btn-m').forEach(b => {
    b.ontouchstart = (e) => { e.preventDefault(); mobAtk[b.dataset.dir]=true; };
    b.ontouchend = (e) => { e.preventDefault(); mobAtk[b.dataset.dir]=false; };
});

function swap() {
    let idx = G.owned.indexOf(G.weapon);
    G.weapon = G.owned[(idx + 1) % G.owned.length];
}
document.getElementById('swap-mob').onclick = swap;
window.onkeydown=e=>{ keys.add(e.key.toLowerCase()); if(e.key==='q') swap(); };
window.onkeyup=e=>keys.delete(e.key.toLowerCase());

function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
window.onresize = () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }; window.onresize();

if(!isMob) document.getElementById('platform-tips').innerText = "PC: WASD Mover | SETAS Atirar | Q Trocar Arma";
</script>
</body>
</html>
