<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow ðŸ’€ Lord of Light</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #05050a; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { display: block; background: #000; }

        /* HUD */
        #hud { position: absolute; top: 20px; left: 20px; z-index: 1000; display: none; flex-direction: column; gap: 10px; }
        .stat-container { background: rgba(0,0,0,0.8); padding: 8px; border-left: 4px solid #00eaff; border-radius: 5px; width: 220px; }
        .bar-bg { width: 100%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        #hp-fill { background: #ff0040; box-shadow: 0 0 10px #ff0040; }
        #ammo-fill { background: #00eaff; box-shadow: 0 0 10px #00eaff; }

        /* Telas */
        .ui-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        
        /* Loading Block */
        .loader-container { width: 300px; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; position: relative; overflow: hidden; margin-top: 20px; }
        .loading-block { position: absolute; width: 40px; height: 100%; background: #00eaff; box-shadow: 0 0 15px #00eaff; animation: moveBlock 2s linear infinite; }
        @keyframes moveBlock { 0% { left: -50px; } 100% { left: 350px; } }

        /* Mobile Controls */
        #mobile-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 2000; }
        #joy-base { position: absolute; bottom: 50px; left: 50px; width: 130px; height: 130px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; width: 60px; height: 60px; background: #00eaff; border-radius: 50%; left: 35px; top: 35px; box-shadow: 0 0 20px #00eaff; }
        #atk-grid { position: absolute; bottom: 40px; right: 40px; display: grid; grid-template-columns: repeat(3, 85px); gap: 10px; pointer-events: auto; }
        .btn-atk { width: 85px; height: 85px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; }
    </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
    <h1 style="color: #e74c3c; font-size: 50px; text-shadow: 0 0 20px #e74c3c;">DEN OF SHADOW</h1>
    <button id="btn-play" style="padding: 20px 60px; font-size: 25px; background: #2ecc71; color: #fff; border: none; border-radius: 50px; cursor: pointer;">INICIAR JORNADA</button>
</div>

<div id="loading-screen" class="ui-screen" style="display:none;">
    <h2 style="color: #00eaff;">CARREGANDO...</h2>
    <div class="loader-container"><div class="loading-block"></div></div>
</div>

<div id="hud">
    <div class="stat-container"><div>VIDA</div><div class="bar-bg"><div id="hp-fill" class="bar-fill" style="width: 100%;"></div></div></div>
    <div class="stat-container" style="border-color:#f1c40f;"><div>MUNIÃ‡ÃƒO</div><div class="bar-bg"><div id="ammo-fill" class="bar-fill" style="width: 100%;"></div></div></div>
    <div style="font-weight: bold; font-size: 20px; color: #00eaff;">SALA: <span id="room-txt">0</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="mobile-hud">
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="atk-grid">
        <div></div><div class="btn-atk" data-dir="up">â–²</div><div></div>
        <div class="btn-atk" data-dir="left">â—€</div><div class="btn-atk" data-dir="down">â–¼</div><div class="btn-atk" data-dir="right">â–¶</div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);

// ConfiguraÃ§Ã£o da Sala e Jogo
const ROOM = { w: 1400, h: 900, wallSize: 60 };
const G = {
    play: false, room: 0,
    hp: 100, maxHp: 100, ammo: 100, maxAmmo: 100,
    enemiesDefeated: false
};

// Player e Inputs
let player = { x: ROOM.w/2, y: ROOM.h/2, r: 25, spd: 7, iframe: 0 };
let enemies = [], projectiles = [], doors = [];
const keys = {}; // Objeto para mÃºltiplas teclas
const mobAtk = { up: false, down: false, left: false, right: false };
const joy = { active: false, x: 0, y: 0, sx: 0, sy: 0 };

function initRoom() {
    enemies = []; projectiles = []; doors = [];
    G.enemiesDefeated = false;
    player.x = ROOM.w/2; player.y = ROOM.h/2;

    if (G.room === 0) {
        G.enemiesDefeated = true; 
        spawnDoors();
    } else {
        spawnEnemies();
    }
}

function spawnEnemies() {
    let count = 4 + G.room;
    for(let i=0; i<count; i++) {
        enemies.push({
            x: 200 + Math.random() * (ROOM.w - 400),
            y: 200 + Math.random() * (ROOM.h - 400),
            hp: 50 + G.room * 10, r: 30, spd: 2 + Math.random()
        });
    }
}

function spawnDoors() {
    doors = [{ x: ROOM.w/2 - 60, y: 0, w: 120, h: 60 }]; // Porta Norte
}

function update() {
    if(!G.play) return;

    // MOVIMENTO (PC + Console + Mobile)
    let mx = 0, my = 0;
    
    // PC (Teclado)
    if(keys['w'] || keys['arrowup']) my = -1;
    if(keys['s'] || keys['arrowdown']) my = 1;
    if(keys['a'] || keys['arrowleft']) mx = -1;
    if(keys['d'] || keys['arrowright']) mx = 1;

    // Mobile (Joystick)
    if(joy.active) { mx = joy.x; my = joy.y; }

    // Aplica movimento com trava nas paredes
    player.x = Math.max(ROOM.wallSize + player.r, Math.min(ROOM.w - ROOM.wallSize - player.r, player.x + mx * player.spd));
    player.y = Math.max(ROOM.wallSize + player.r, Math.min(ROOM.h - ROOM.wallSize - player.r, player.y + my * player.spd));

    // LÃ³gica de portas
    if(G.enemiesDefeated) {
        doors.forEach(d => {
            if(player.x > d.x && player.x < d.x + d.w && player.y < d.y + d.h + 20) {
                G.room++;
                initRoom();
            }
        });
    }

    // Checar morte de inimigos
    if(enemies.length === 0 && !G.enemiesDefeated) {
        G.enemiesDefeated = true;
        spawnDoors();
    }
}

function draw() {
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if(!G.play) { requestAnimationFrame(draw); return; }
    update();

    ctx.save();
    let scale = Math.min(canvas.width/ROOM.w, canvas.height/ROOM.h) * 0.95;
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(scale, scale);
    ctx.translate(-ROOM.w/2, -ROOM.h/2);

    // Piso
    ctx.fillStyle = "#111";
    ctx.fillRect(0, 0, ROOM.w, ROOM.h);

    // Tutorial no ChÃ£o
    if(G.room === 0) {
        ctx.fillStyle = "rgba(255,255,255,0.1)";
        ctx.font = "bold 30px Orbitron";
        ctx.textAlign = "center";
        ctx.fillText("USE WASD OU JOYSTICK PARA MOVER", ROOM.w/2, ROOM.h/2 - 50);
        ctx.fillText("VÃ PARA O NORTE PARA COMEÃ‡AR", ROOM.w/2, ROOM.h/2 + 50);
    }

    // Paredes
    ctx.fillStyle = "#050505";
    ctx.fillRect(0,0,ROOM.w,ROOM.wallSize); // Top
    ctx.fillRect(0,ROOM.h-ROOM.wallSize,ROOM.w,ROOM.wallSize); // Bottom
    ctx.fillRect(0,0,ROOM.wallSize,ROOM.h); // Left
    ctx.fillRect(ROOM.w-ROOM.wallSize,0,ROOM.wallSize,ROOM.h); // Right

    // Portas
    if(G.enemiesDefeated) {
        ctx.fillStyle = "#00eaff";
        ctx.shadowBlur = 20; ctx.shadowColor = "#00eaff";
        doors.forEach(d => ctx.fillRect(d.x, d.y, d.w, d.h));
        ctx.shadowBlur = 0;
    }

    // Player
    ctx.fillStyle = "#00eaff";
    ctx.shadowBlur = 15; ctx.shadowColor = "#00eaff";
    ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;

    // Inimigos
    ctx.fillStyle = "#e74c3c";
    enemies.forEach(en => {
        ctx.beginPath(); ctx.arc(en.x, en.y, en.r, 0, Math.PI*2); ctx.fill();
    });

    ctx.restore();

    // HUD
    document.getElementById('hp-fill').style.width = G.hp + "%";
    document.getElementById('ammo-fill').style.width = G.ammo + "%";
    document.getElementById('room-txt').innerText = G.room;

    requestAnimationFrame(draw);
}

// Eventos de Teclado
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => delete keys[e.key.toLowerCase()]);

// Eventos Mobile (Joystick)
const knob = document.getElementById('joy-stick'), base = document.getElementById('joy-base');
base.addEventListener('touchstart', (e) => {
    joy.active = true;
    let r = base.getBoundingClientRect();
    joy.sx = r.left + r.width/2;
    joy.sy = r.top + r.height/2;
});
base.addEventListener('touchmove', (e) => {
    if(!joy.active) return;
    let t = e.touches[0];
    let dx = t.clientX - joy.sx, dy = t.clientY - joy.sy;
    let dist = Math.min(Math.hypot(dx, dy), 50);
    let ang = Math.atan2(dy, dx);
    joy.x = (Math.cos(ang) * dist) / 50;
    joy.y = (Math.sin(ang) * dist) / 50;
    knob.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
});
base.addEventListener('touchend', () => {
    joy.active = false; joy.x = 0; joy.y = 0;
    knob.style.transform = `translate(0,0)`;
});

// BotÃ£o Jogar
document.getElementById('btn-play').onclick = () => {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('loading-screen').style.display = 'flex';
    setTimeout(() => {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        if(isMobile) document.getElementById('mobile-hud').style.display = 'block';
        G.play = true;
        initRoom();
    }, 2000);
};

window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize();
draw();
</script>
</body>
</html>
