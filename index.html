<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow üíÄ V15.0 ULTIMATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&display=swap');
        
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; width: 100vw; height: 100vh; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        /* Interface Screens */
        .screen { position: absolute; inset: 0; background: radial-gradient(circle, #200 0%, #000 100%); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .panel { background: rgba(0,0,0,0.9); border: 2px solid #f00; padding: 30px; border-radius: 20px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 0 30px #f005; }
        
        .btn { padding: 15px; background: #100; border: 1px solid #f00; color: #fff; cursor: pointer; font-family: 'Orbitron'; margin: 8px 0; width: 100%; text-transform: uppercase; transition: 0.2s; }
        .btn:hover { background: #f00; color: #000; }

        /* HUD */
        #hud { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; width: 95%; max-width: 600px; pointer-events: none; }
        .hud-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; background: rgba(0,0,0,0.85); border: 1px solid #f00; padding: 10px; border-radius: 8px; text-align: center; font-size: 14px; text-shadow: 0 0 5px #f00; }

        /* Mobile Layout */
        #mobile-controls { position: absolute; inset: 0; z-index: 2000; display: none; pointer-events: none; }
        #look-zone { position: absolute; top: 0; right: 0; width: 65%; height: 100%; pointer-events: auto; }
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.05); border: 2px solid #f00; border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; background: #f00; border-radius: 50%; opacity: 0.6; }
        
        .action-btn { position: absolute; pointer-events: auto; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; background: rgba(200,0,0,0.2); border: 2px solid #f00; }
        #btn-atk { bottom: 40px; right: 40px; }
        #btn-use { bottom: 130px; right: 40px; width: 60px; height: 60px; border-color: #0f0; }

        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; border: 1px solid #f00; border-radius: 50%; z-index: 1500; display: none; }
        .links { margin-top: 20px; font-size: 10px; color: #666; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="menu" class="screen">
    <div class="panel">
        <h1 style="font-family:'Nosifer'; color:#f00; margin:0; font-size: 1.8rem;">DEN OF SHADOW</h1>
        <p style="font-size: 10px; letter-spacing: 2px;">V15.0 ULTIMATE CONVERGENCE</p>
        <button class="btn" onclick="startRitual()">INICIAR RITUAL</button>
        <button class="btn" onclick="alert('Discord: killzone1561\nYouTube: kaua_darth\nEmail: kauadarthofc@gmail.com')">CONTATOS</button>
        <div class="links">
            Desenvolvido por Kau√£ Darth
        </div>
    </div>
</div>

<div id="hud">
    <div class="hud-bar">
        <div>HP: <span id="val-hp" style="color:#f00">100</span></div>
        <div>AMMO: <span id="val-ammo" style="color:#0f0">40</span></div>
        <div>SOULS: <span id="val-souls" style="color:#ff0">0</span></div>
    </div>
    <div style="text-align:center; font-size:10px; margin-top:5px;">C√ÇMARA: <span id="val-room">1</span></div>
</div>

<div id="mobile-controls">
    <div id="look-zone"></div>
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div class="action-btn" id="btn-atk">üî•</div>
    <div class="action-btn" id="btn-use">üëÅÔ∏è</div>
</div>

<div id="crosshair"></div>
<canvas id="gameCanvas"></canvas>

<script>
/** * CONFIGURA√á√ïES GLOBAIS 
 */
const G = {
    play: false,
    room: 1,
    hp: 100,
    ammo: 40,
    souls: 0,
    res: 2, // Resolu√ß√£o de renderiza√ß√£o
    sens: 0.0025,
    isMobile: false,
    weapon: 'pistol'
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 64, MAP_SIZE = 24;

let map = [], enemies = [], bullets = [], shopItems = [];
let keys = {};

/**
 * GERA√á√ÉO DE MAPA (ESTILO V11 + SHOP V14)
 */
function buildRoom(roomNum) {
    G.room = roomNum;
    map = Array(MAP_SIZE * MAP_SIZE).fill(0);
    enemies = [];
    shopItems = [];

    // Paredes Externas
    for (let i = 0; i < MAP_SIZE; i++) {
        map[i] = 1; 
        map[i + (MAP_SIZE * (MAP_SIZE - 1))] = 1;
        map[i * MAP_SIZE] = 1; 
        map[i * MAP_SIZE + (MAP_SIZE - 1)] = 1;
    }

    if (roomNum % 5 === 0) {
        // SHOPPING (C√¢mara do Mercador)
        spawnShop(10, 10, 'dmg', 15);
        spawnShop(14, 10, 'ammo', 10);
    } else {
        // OBST√ÅCULOS ALEAT√ìRIOS (V11)
        for (let i = 0; i < 12; i++) {
            let rx = 5 + Math.floor(Math.random() * 14);
            let ry = 5 + Math.floor(Math.random() * 14);
            map[ry * MAP_SIZE + rx] = 1;
        }
        // INIMIGOS
        let count = 3 + Math.floor(roomNum * 0.5);
        for (let i = 0; i < count; i++) {
            enemies.push({ x: (8 + Math.random() * 8) * TILE, y: (8 + Math.random() * 8) * TILE, hp: 100, alive: true });
        }
    }

    // Sa√≠da (Porta)
    map[Math.floor(MAP_SIZE / 2)] = 2;
    
    // Player pos inicial
    player.x = (MAP_SIZE / 2) * TILE;
    player.y = (MAP_SIZE - 3) * TILE;
    player.angle = -Math.PI / 2;
}

function spawnShop(tx, ty, type, price) {
    shopItems.push({ x: tx * TILE, y: ty * TILE, type, price, active: true });
}

const player = { x: 0, y: 0, angle: 0, pitch: 0, fov: Math.PI / 3 };

/**
 * SISTEMA DE INPUTS
 */
let moveX = 0, moveY = 0, lookTouchId = null, lastLX = 0, lastLY = 0;

function setupInputs() {
    window.onkeydown = e => { 
        keys[e.key.toLowerCase()] = true;
        if(e.key === 'r') location.reload();
    };
    window.onkeyup = e => delete keys[e.key.toLowerCase()];

    // Mouse Look (PC)
    canvas.addEventListener('mousedown', e => {
        if (!document.pointerLockElement && !G.isMobile) canvas.requestPointerLock();
        if (e.button === 0) performAction('shoot');
        if (e.button === 2) performAction('use');
    });

    window.addEventListener('mousemove', e => {
        if (document.pointerLockElement) {
            player.angle += e.movementX * G.sens;
            player.pitch = Math.max(-350, Math.min(350, player.pitch - e.movementY * 2));
        }
    });

    // Mobile Stick
    const joyStick = document.getElementById('joy-stick');
    const joyBase = document.getElementById('joy-base');
    joyBase.addEventListener('touchmove', e => {
        const t = e.touches[0];
        const r = joyBase.getBoundingClientRect();
        moveX = Math.max(-1, Math.min(1, (t.clientX - (r.left + r.width / 2)) / 45));
        moveY = Math.max(-1, Math.min(1, (t.clientY - (r.top + r.height / 2)) / 45));
        joyStick.style.transform = `translate(${moveX * 30}px, ${moveY * 30}px)`;
    });
    joyBase.addEventListener('touchend', () => {
        moveX = 0; moveY = 0; joyStick.style.transform = 'translate(0,0)';
    });

    // Mobile Look
    const lookZone = document.getElementById('look-zone');
    lookZone.addEventListener('touchstart', e => {
        lookTouchId = e.changedTouches[0].identifier;
        lastLX = e.changedTouches[0].clientX;
        lastLY = e.changedTouches[0].clientY;
    });
    lookZone.addEventListener('touchmove', e => {
        for (let t of e.touches) {
            if (t.identifier === lookTouchId) {
                player.angle += (t.clientX - lastLX) * G.sens * 1.5;
                player.pitch += (lastLY - t.clientY) * 2;
                lastLX = t.clientX; lastLY = t.clientY;
            }
        }
    });

    document.getElementById('btn-atk').addEventListener('touchstart', e => { e.preventDefault(); performAction('shoot'); });
    document.getElementById('btn-use').addEventListener('touchstart', e => { e.preventDefault(); performAction('use'); });
}

function performAction(type) {
    if (type === 'shoot' && G.ammo > 0) {
        bullets.push({ x: player.x, y: player.y, vx: Math.cos(player.angle) * 18, vy: Math.sin(player.angle) * 18, life: 80 });
        G.ammo--;
    }
    if (type === 'use') {
        shopItems.forEach(item => {
            if (item.active && Math.hypot(player.x - item.x, player.y - item.y) < 100) {
                if (G.souls >= item.price) {
                    G.souls -= item.price;
                    item.active = false;
                    if (item.type === 'dmg') G.hp = Math.min(G.hp + 50, 100);
                    if (item.type === 'ammo') G.ammo += 40;
                }
            }
        });
    }
}

/**
 * LOOP DE L√ìGICA
 */
function update() {
    if (!G.play) return;

    let kx = 0, ky = 0;
    if (keys['w']) { kx += Math.cos(player.angle); ky += Math.sin(player.angle); }
    if (keys['s']) { kx -= Math.cos(player.angle); ky -= Math.sin(player.angle); }
    if (keys['a']) { kx += Math.cos(player.angle - Math.PI / 2); ky += Math.sin(player.angle - Math.PI / 2); }
    if (keys['d']) { kx += Math.cos(player.angle + Math.PI / 2); ky += Math.sin(player.angle + Math.PI / 2); }

    // Soma Movimento Mobile
    let mx = kx + (moveY * Math.cos(player.angle) - moveX * Math.sin(player.angle)) * -1;
    let my = ky + (moveY * Math.sin(player.angle) + moveX * Math.cos(player.angle)) * -1;

    let nx = player.x + mx * 4.5, ny = player.y + my * 4.5;
    if (map[Math.floor(ny / TILE) * MAP_SIZE + Math.floor(nx / TILE)] === 0) {
        player.x = nx; player.y = ny;
    }

    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy; b.life--;
        enemies.forEach(en => {
            if (en.alive && Math.hypot(b.x - en.x, b.y - en.y) < 35) {
                en.hp -= 40; bullets.splice(i, 1);
                if (en.hp <= 0) { en.alive = false; G.souls += 2; G.ammo += 2; }
            }
        });
        if (b.life < 0 || map[Math.floor(b.y / TILE) * MAP_SIZE + Math.floor(b.x / TILE)] > 0) bullets.splice(i, 1);
    });

    enemies.forEach(en => {
        if (!en.alive) return;
        let d = Math.hypot(player.x - en.x, player.y - en.y);
        if (d < 40) { G.hp -= 0.5; if(G.hp <= 0) location.reload(); }
        else if (d < 400) { en.x += (player.x - en.x) / d * 1.5; en.y += (player.y - en.y) / d * 1.5; }
    });

    // Pr√≥xima Sala
    if (map[Math.floor(player.y / TILE) * MAP_SIZE + Math.floor(player.x / TILE)] === 2 && enemies.every(e => !e.alive)) {
        buildRoom(G.room + 1);
    }

    document.getElementById('val-hp').innerText = Math.ceil(G.hp);
    document.getElementById('val-ammo').innerText = G.ammo;
    document.getElementById('val-souls').innerText = G.souls;
    document.getElementById('val-room').innerText = G.room;
}

/**
 * MOTOR DE RENDERIZA√á√ÉO (RAYCASTING V15)
 */
function draw() {
    // Teto e Ch√£o
    ctx.fillStyle = "#080000"; ctx.fillRect(0, 0, canvas.width, canvas.height / 2 + player.pitch);
    ctx.fillStyle = "#110505"; ctx.fillRect(0, canvas.height / 2 + player.pitch, canvas.width, canvas.height);

    const step = G.res;
    for (let i = 0; i < canvas.width; i += step) {
        let rayAng = (player.angle - player.fov / 2) + (i / canvas.width) * player.fov;
        let d = 0, hit = 0, cos = Math.cos(rayAng), sin = Math.sin(rayAng);

        while (hit === 0 && d < 1000) {
            d += 6;
            let tx = Math.floor((player.x + cos * d) / TILE), ty = Math.floor((player.y + sin * d) / TILE);
            if (map[ty * MAP_SIZE + tx] > 0) {
                hit = map[ty * MAP_SIZE + tx];
                let distNorm = d * Math.cos(player.angle - rayAng);
                let wallH = (TILE * canvas.height) / distNorm;
                
                let brightness = Math.max(0, 180 - d / 5);
                ctx.fillStyle = hit === 2 ? `rgb(0, ${brightness}, 0)` : `rgb(${brightness}, 0, 0)`;
                ctx.fillRect(i, (canvas.height - wallH) / 2 + player.pitch, step, wallH);
            }
        }
    }

    // Sprites (Inimigos e Shop)
    let sprites = [...enemies.filter(e => e.alive), ...shopItems.filter(s => s.active)];
    sprites.sort((a,b) => Math.hypot(player.x-b.x, player.y-b.y) - Math.hypot(player.x-a.x, player.y-a.y));

    sprites.forEach(s => {
        let ang = Math.atan2(s.y - player.y, s.x - player.x) - player.angle;
        while (ang < -Math.PI) ang += Math.PI * 2; while (ang > Math.PI) ang -= Math.PI * 2;
        if (Math.abs(ang) < player.fov) {
            let d = Math.hypot(player.x - s.x, player.y - s.y);
            let sx = (0.5 * (ang / (player.fov / 2)) + 0.5) * canvas.width;
            let sh = (TILE * 0.8 * canvas.height) / d;
            ctx.fillStyle = s.price ? "#ff0" : "#000";
            ctx.shadowBlur = 10; ctx.shadowColor = s.price ? "#ff0" : "#f00";
            ctx.fillRect(sx - sh / 2, (canvas.height - sh) / 2 + player.pitch, sh, sh);
            ctx.shadowBlur = 0;
        }
    });
}

/**
 * START
 */
function startRitual() {
    G.isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
    document.getElementById('menu').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    document.getElementById('crosshair').style.display = 'block';
    if (G.isMobile) document.getElementById('mobile-controls').style.display = 'block';
    
    setupInputs();
    buildRoom(1);
    G.play = true;
    (function frame() { update(); draw(); requestAnimationFrame(frame); })();
}

window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize();
</script>
</body>
</html>
