<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fox of Isaac: Den of Shadows</title>
    <style>
        * { touch-action: none !important; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body { background: #000; color: #fff; margin: 0; font-family: 'Courier New', monospace; overflow: hidden; height: 100vh; width: 100vw; display: flex; }
        
        .overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; z-index: 200; text-align: center; 
        }

        .btn-ui { 
            padding: 20px 40px; border: 3px solid #ff4d6d; background: #222; 
            color: #fff; cursor: pointer; font-size: 22px; margin: 10px; width: 280px; 
        }

        #upgrade-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .upgrade-card { 
            background: #111; border: 2px solid #f1c40f; padding: 20px; 
            width: 140px; cursor: pointer; transition: 0.2s;
        }
        .upgrade-card:hover { background: #f1c40f; color: #000; }

        #game-container { position: relative; flex: 1; height: 100%; width: 100%; display: flex; justify-content: center; align-items: center; }
        canvas { background: #0a0a0a; image-rendering: pixelated; width: 100%; height: 100%; object-fit: contain; }

        .mobile-ctrl { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #joy-bound { position: absolute; bottom: 10%; left: 5%; width: 140px; height: 140px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; left: 45px; top: 45px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.3; }
        #shoot-ctrl { position: absolute; bottom: 10%; right: 5%; display: grid; grid-template-columns: repeat(3, 70px); gap: 10px; pointer-events: auto; }
        .atk-btn { width: 70px; height: 70px; background: rgba(52,152,219,0.1); border: 2px solid #3498db; border-radius: 50%; color: #3498db; display: flex; justify-content: center; align-items: center; font-size: 22px; }
    </style>
</head>
<body>

<div id="start-screen" class="overlay">
    <h1 style="color:#ff4d6d; font-size: 40px;">COVIL DAS SOMBRAS</h1>
    <button class="btn-ui" id="start-btn">ENTRAR NO COVIL</button>
</div>

<div id="upgrade-screen" class="overlay" style="display:none">
    <h1 style="color:#f1c40f">UPGRADE DISPONÍVEL</h1>
    <div id="upgrade-container"></div>
</div>

<div id="death-screen" class="overlay" style="display:none">
    <h1 style="color:#ff4d6d; font-size: 50px;">FIM DA JORNADA</h1>
    <p>Você sucumbiu às sombras.</p>
    <button class="btn-ui" onclick="location.reload()">REENCARNAR</button>
</div>

<div id="game-container">
    <canvas id="game"></canvas>
    <div id="mobile-ui" class="mobile-ctrl">
        <div id="joy-bound"><div id="joy-stick"></div></div>
        <div id="shoot-ctrl">
            <div></div><div class="atk-btn" data-dir="up">▲</div><div></div>
            <div class="atk-btn" data-dir="left">◀</div><div class="atk-btn" data-dir="down">▼</div><div class="atk-btn" data-dir="right">▶</div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

function resize() { canvas.width = window.innerWidth / 2; canvas.height = window.innerHeight / 2; }
window.addEventListener('resize', resize);
resize();

const Game = { started: false, lives: 6, maxLives: 6, room: 0, roomW: 1000, roomH: 800, camX: 0, camY: 0, paused: false };
const Stats = { moveSpeed: 4.8, atkSpeed: 15, damage: 10 };
const input = { x: 0, y: 0 };
const attack = { up: false, down: false, left: false, right: false };

document.getElementById('start-btn').onclick = () => {
    document.getElementById('start-screen').style.display = 'none';
    if(isMobile) document.getElementById('mobile-ui').style.display = 'block';
    Game.started = true;
    initRoom();
    loop();
};

function showUpgradeMenu() {
    Game.paused = true;
    const container = document.getElementById('upgrade-container');
    container.innerHTML = '';
    const pool = [
        { n: "AGILIDADE", d: "+ Velocidade", e: () => Stats.moveSpeed += 1.2 },
        { n: "ADRENALINA", d: "+ Cadência", e: () => Stats.atkSpeed = Math.max(5, Stats.atkSpeed - 3) },
        { n: "VITALIDADE", d: "+ 2 Corações", e: () => { Game.maxLives += 2; Game.lives = Game.maxLives; } },
        { n: "FORÇA bruta", d: "+ Dano", e: () => Stats.damage += 10 }
    ];
    pool.sort(() => Math.random() - 0.5).slice(0, 3).forEach(opt => {
        const card = document.createElement('div');
        card.className = 'upgrade-card';
        card.innerHTML = `<strong>${opt.n}</strong><br><small>${opt.d}</small>`;
        card.onclick = () => { opt.e(); Game.paused = false; document.getElementById('upgrade-screen').style.display = 'none'; };
        container.appendChild(card);
    });
    document.getElementById('upgrade-screen').style.display = 'flex';
}

// --- CONTROLES ---
let joyTouchId = null;
if(isMobile) {
    window.addEventListener('touchstart', (e) => { e.preventDefault(); processTouches(e); }, { passive: false });
    window.addEventListener('touchmove', (e) => { e.preventDefault(); processTouches(e); }, { passive: false });
    window.addEventListener('touchend', (e) => { e.preventDefault(); endTouch(e); }, { passive: false });
}

function processTouches(e) {
    if(!Game.started || Game.paused) return;
    let curAtk = { up: false, down: false, left: false, right: false };
    const r = document.getElementById('joy-bound').getBoundingClientRect();
    for (let t of e.touches) {
        if (joyTouchId === t.identifier || (joyTouchId === null && t.clientX >= r.left && t.clientX <= r.right && t.clientY >= r.top && t.clientY <= r.bottom)) {
            joyTouchId = t.identifier;
            let dx = (t.clientX - (r.left + r.width/2)) / 60;
            let dy = (t.clientY - (r.top + r.height/2)) / 60;
            let d = Math.min(1, Math.hypot(dx, dy));
            let a = Math.atan2(dy, dx);
            input.x = Math.cos(a) * d; input.y = Math.sin(a) * d;
            document.getElementById('joy-stick').style.left = (45 + input.x * 35) + 'px';
            document.getElementById('joy-stick').style.top = (45 + input.y * 35) + 'px';
        }
        const target = document.elementFromPoint(t.clientX, t.clientY);
        if (target && target.classList.contains('atk-btn')) curAtk[target.getAttribute('data-dir')] = true;
    }
    Object.assign(attack, curAtk);
}

function endTouch(e) {
    for (let t of e.changedTouches) if (t.identifier === joyTouchId) {
        joyTouchId = null; input.x = 0; input.y = 0;
        document.getElementById('joy-stick').style.left = '45px'; document.getElementById('joy-stick').style.top = '45px';
    }
}

window.onkeydown = (e) => {
    let k = e.key.toLowerCase();
    if(k=='w') input.y = -1; if(k=='s') input.y = 1; if(k=='a') input.x = -1; if(k=='d') input.x = 1;
    if(k=='i' || e.key == 'ArrowUp') attack.up=true; if(k=='k' || e.key == 'ArrowDown') attack.down=true;
    if(k=='j' || e.key == 'ArrowLeft') attack.left=true; if(k=='l' || e.key == 'ArrowRight') attack.right=true;
};
window.onkeyup = (e) => {
    let k = e.key.toLowerCase();
    if(k=='w'||k=='s') input.y = 0; if(k=='a'||k=='d') input.x = 0;
    if(k=='i'||k=='k'||k=='j'||k=='l'||e.key.includes('Arrow')) { attack.up = attack.down = attack.left = attack.right = false; }
};

class Projectile {
    constructor(x, y, dx, dy, enemy=false) { this.x = x; this.y = y; this.dx = dx; this.dy = dy; this.enemy = enemy; this.active = true; }
    update() {
        this.x += this.dx * (this.enemy ? 3 : 8);
        this.y += this.dy * (this.enemy ? 3 : 8);
        if(this.x < 10 || this.x > Game.roomW-10 || this.y < 10 || this.y > Game.roomH-10) this.active = false;
    }
    draw() { ctx.fillStyle = this.enemy ? "#f0f" : "#0ff"; ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill(); }
}

class Enemy {
    constructor(type, x, y) {
        this.type = type; 
        this.x = x || Math.random() * (Game.roomW - 200) + 100;
        this.y = y || Math.random() * (Game.roomH - 200) + 100;
        this.hp = (type === 'bossT') ? 600 : 40;
        this.alive = true; this.stun = 0; this.timer = Math.random() * 50; this.seePlayer = false;
    }
    update() {
        if (this.stun > 0) { this.stun--; return; }
        let d = Math.hypot(p.x - this.x, p.y - this.y);
        if (this.type === 'bossT') {
            if (--this.timer <= 0) {
                for(let i=0; i<12; i++) {
                    let a = (Math.PI*2/12)*i;
                    projectiles.push(new Projectile(this.x+40, this.y+40, Math.cos(a), Math.sin(a), true));
                }
                this.timer = 110; this.stun = 30;
            }
        } else if (this.type === 'stalker') {
            let a = Math.atan2(p.y - this.y, p.x - this.x);
            this.x += Math.cos(a) * 2; this.y += Math.sin(a) * 2;
        } else if (this.type === 'kamikaze') {
            let a = Math.atan2(p.y - this.y, p.x - this.x);
            this.x += Math.cos(a) * 3.5; this.y += Math.sin(a) * 3.5;
        } else if (this.type === 'assassin') {
            if (d < 250) this.seePlayer = true;
            if (this.seePlayer) {
                let a = Math.atan2(p.y - this.y, p.x - this.x);
                this.x += Math.cos(a) * 4.5; this.y += Math.sin(a) * 4.5;
            }
        } else {
            if (--this.timer <= 0) {
                let a = Math.atan2(p.y - this.y, p.x - this.x);
                projectiles.push(new Projectile(this.x+15, this.y+15, Math.cos(a), Math.sin(a), true));
                this.timer = 120; this.stun = 90;
            }
        }
    }
    draw() {
        ctx.fillStyle = this.type === 'bossT' ? "#8e44ad" : (this.type === 'stalker' ? '#3498db' : this.type === 'kamikaze' ? '#f1c40f' : this.type === 'assassin' ? '#2ecc71' : '#ff4757');
        if(this.type === 'bossT') { ctx.fillRect(this.x, this.y, 80, 25); ctx.fillRect(this.x+27, this.y+25, 26, 60); }
        else ctx.fillRect(this.x, this.y, 30, 30);
    }
}

let p = { x: 500, y: 400, iframe: 0, atkTicks: 0 };
let enemies = [], projectiles = [];

function initRoom() {
    projectiles = []; enemies = []; 
    p.x = Game.roomW/2 - 12; p.y = Game.roomH - 120; 
    if (Game.room === 0) return;
    if (Game.room === 20) {
        enemies.push(new Enemy('bossT', 460, 200));
    } else {
        let n = 2 + Math.floor(Game.room/3);
        for(let i=0; i<n; i++) {
            let type = ['stalker', 'kamikaze', 'assassin', 'shooter'][Math.floor(Math.random()*4)];
            enemies.push(new Enemy(type));
        }
    }
}

function loop() {
    if (!Game.started || Game.paused) return requestAnimationFrame(loop);
    if (Game.lives <= 0) { document.getElementById('death-screen').style.display = 'flex'; return; }

    Game.camX += ((p.x - canvas.width/2) - Game.camX) * 0.1;
    Game.camY += ((p.y - canvas.height/2) - Game.camY) * 0.1;

    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx.save(); ctx.translate(-Game.camX, -Game.camY);
    
    // Parede Limitadora
    ctx.strokeStyle = "#222"; 
    for(let i=0; i<Game.roomW; i+=100) for(let j=0; j<Game.roomH; j+=100) ctx.strokeRect(i, j, 100, 100);
    ctx.strokeStyle = "#444"; ctx.lineWidth = 20; ctx.strokeRect(0,0, Game.roomW, Game.roomH);

    // Player c/ trava de parede
    p.x += input.x * Stats.moveSpeed; p.y += input.y * Stats.moveSpeed;
    p.x = Math.max(25, Math.min(Game.roomW-50, p.x));
    p.y = Math.max(25, Math.min(Game.roomH-50, p.y));
    
    if (p.iframe > 0) p.iframe--;
    ctx.fillStyle = (p.iframe % 4 < 2) ? "#e67e22" : "#fff";
    ctx.fillRect(p.x, p.y, 25, 25);

    if (--p.atkTicks <= 0) {
        let dx=0, dy=0;
        if(attack.up) dy=-1; else if(attack.down) dy=1; else if(attack.left) dx=-1; else if(attack.right) dx=1;
        if(dx||dy) { projectiles.push(new Projectile(p.x+10, p.y+10, dx, dy)); p.atkTicks = Stats.atkSpeed; }
    }

    for(let i = projectiles.length-1; i >= 0; i--){
        let pr = projectiles[i]; pr.update(); pr.draw();
        if (pr.enemy) {
            if (p.iframe <= 0 && Math.hypot(pr.x-p.x-12, pr.y-p.y-12) < 16) { Game.lives--; p.iframe = 60; pr.active = false; }
        } else {
            enemies.forEach(e => {
                if (e.alive && Math.hypot(pr.x-e.x-15, pr.y-e.y-15) < 30) { e.hp -= Stats.damage; pr.active = false; if(e.hp <= 0) e.alive = false; }
            });
        }
        if (!pr.active) projectiles.splice(i, 1);
    }

    enemies.forEach(e => { 
        if(e.alive) { 
            e.update(); e.draw(); 
            if(p.iframe <= 0 && Math.hypot(e.x-p.x, e.y-p.y) < 30) {
                if(e.type === 'kamikaze') { Game.lives -= 2; e.alive = false; }
                else Game.lives--;
                p.iframe = 60;
            }
        } 
    });

    if (enemies.filter(e => e.alive).length === 0) {
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(Game.roomW/2-40, 0, 80, 25);
        if (p.y < 40 && Math.abs(p.x - Game.roomW/2 + 20) < 50) { 
            Game.room++; 
            if (Game.room % 10 === 0) showUpgradeMenu();
            initRoom(); 
        }
    }

    ctx.restore();
    
    // --- HUD DE QUADRADOS ---
    for(let i=0; i<Game.maxLives; i++) {
        ctx.fillStyle = "#222"; ctx.fillRect(20 + (i*24), 20, 18, 18);
        if(i < Game.lives) { ctx.fillStyle = "#ff4d6d"; ctx.fillRect(20 + (i*24), 20, 18, 18); }
    }
    ctx.fillStyle = "#fff"; ctx.font = "bold 14px Arial";
    ctx.fillText("SALA " + Game.room, 20, 55);
    
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
