<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow ðŸ’€ V15.20 FIXED</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&display=swap');
        * { touch-action: none; user-select: none; box-sizing: border-box; outline: none; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }

        .ui-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .glass-panel { background: #0a0a0a; border: 2px solid #f00; padding: 25px; width: 90%; max-width: 450px; box-shadow: 0 0 20px #500; }
        .btn-main { padding: 12px; font-size: 13px; background: #111; border: 1px solid #f00; color: #fff; cursor: pointer; font-family: 'Orbitron'; margin: 5px 0; width: 100%; text-transform: uppercase; }

        #hud { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; width: 95%; max-width: 650px; pointer-events: none; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: rgba(0,0,0,0.85); padding: 12px; border: 1px solid #f00; }
        #hp-fill { height: 8px; width: 100%; background: #f00; transition: 0.2s; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; border: 1px solid rgba(255,0,0,0.5); border-radius: 50%; pointer-events: none; z-index: 1000; display: none; }
        #crosshair::after { content: ''; position: absolute; top: 50%; left: 50%; width: 2px; height: 2px; background: #f00; transform: translate(-50%, -50%); }

        #minimap { position: absolute; top: 15px; right: 15px; width: 100px; height: 100px; border: 2px solid #f00; background: rgba(0,0,0,0.8); border-radius: 50%; z-index: 1000; display: none; }

        /* Mobile Controls */
        #mobile-ui { position: absolute; inset: 0; z-index: 2000; display: none; pointer-events: none; }
        .joy-zone { position: absolute; bottom: 30px; left: 30px; width: 110px; height: 110px; background: rgba(255,0,0,0.1); border: 1px solid #444; border-radius: 50%; pointer-events: auto; }
        #stick { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: #f00; border-radius: 50%; opacity: 0.4; }
        .btn-circ { width: 70px; height: 70px; background: rgba(255,0,0,0.2); border: 2px solid #f00; border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; position: absolute; }
        #touch-look { position: absolute; top: 0; right: 0; width: 55%; height: 100%; pointer-events: auto; }
    </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
    <div class="glass-panel">
        <h1 style="font-family:'Nosifer'; color:#f00;">DEN OF SHADOW</h1>
        <button class="btn-main" onclick="showSaveSelection()">CARREGAR ALMA</button>
        <button class="btn-main" onclick="G.clicks=5; document.getElementById('cheat-trigger').click()">MODO KADTR</button>
    </div>
</div>

<div id="save-screen" class="ui-screen" style="display:none;">
    <div class="glass-panel">
        <h2 style="color:#f00;">SAVES</h2>
        <div id="save-list"></div>
        <button class="btn-main" onclick="document.getElementById('save-screen').style.display='none'">VOLTAR</button>
    </div>
</div>

<div id="crosshair"></div>
<canvas id="minimap"></canvas>

<div id="hud">
    <div class="stats-grid">
        <div>HP<div style="background:#200; height:8px;"><div id="hp-fill"></div></div></div>
        <div style="text-align:center;"><div id="biome-name" style="font-size:9px;">ABISMO</div><div id="room-txt" style="font-size:18px;">1</div></div>
        <div style="text-align:right;"><div id="cheat-trigger" style="color:#ff0; font-size:9px; cursor:pointer;">MUN / ALMAS</div><div><span id="ammo-hud">40</span> / <span id="soul-hud">0</span></div></div>
    </div>
</div>

<div id="mobile-ui">
    <div id="touch-look"></div>
    <div class="joy-zone" id="joy-base"><div id="stick"></div></div>
    <div class="btn-circ" id="btn-fire" style="bottom:40px; right:20px;">ðŸ”¥</div>
    <div class="btn-circ" id="btn-use" style="bottom:130px; right:35px; width:55px; height:55px; font-size:10px;">COMPRAR</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const G = { 
    play: false, room: 1, hp: 100, ammo: 40, maxAmmo: 40, souls: 0, 
    res: 4, god: false, isMobile: false, speed: 4.5, weaponType: 1, 
    fireRate: 400, lastShot: 0, pierce: false, shield: false, time: 0, clicks: 0, currentSlot: 1 
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const mCanvas = document.getElementById('minimap');
const mCtx = mCanvas.getContext('2d');

const TILE = 64, MAP_SIZE = 24;
let map = [], enemies = [], bullets = [], shopItems = [], keys = {};
let player = { x: 0, y: 0, angle: 0, pitch: 0, fov: Math.PI / 3 };
let lookTouch = { id: null, x: 0, y: 0 };

function showSaveSelection() {
    document.getElementById('save-screen').style.display = 'flex';
    const list = document.getElementById('save-list');
    list.innerHTML = '';
    for (let i = 1; i <= 3; i++) {
        const data = JSON.parse(localStorage.getItem(`dos_v20_save_${i}`)) || { room: 1, souls: 0 };
        list.innerHTML += `<div class="btn-main" onclick="loadAndStart(${i})">SLOT ${i} - SALA ${data.room}</div>`;
    }
}

function loadAndStart(slot) {
    G.currentSlot = slot;
    const data = JSON.parse(localStorage.getItem(`dos_v20_save_${slot}`));
    if(data) Object.assign(G, data);
    startGame();
}

function saveGame() {
    localStorage.setItem(`dos_v20_save_${G.currentSlot}`, JSON.stringify({ 
        room: G.room, souls: G.souls, weaponType: G.weaponType, speed: G.speed,
        fireRate: G.fireRate, pierce: G.pierce, shield: G.shield, maxAmmo: G.maxAmmo
    }));
}

function setupRoom() {
    map = Array(MAP_SIZE * MAP_SIZE).fill(0);
    enemies = []; shopItems = [];
    const isShop = (G.room % 5 === 0);
    G.wallColor = isShop ? '#222' : `hsl(${(G.room * 40) % 360}, 40%, 15%)`;

    for(let i=0; i<MAP_SIZE; i++){ map[i]=1; map[i+(MAP_SIZE*(MAP_SIZE-1))]=1; map[i*MAP_SIZE]=1; map[i*MAP_SIZE+(MAP_SIZE-1)]=1; }

    if(isShop) {
        document.getElementById('biome-name').innerText = "SHOP SOMBRIO";
        const pool = [
            {n:'VIDA FULL', p:10, t:'HP'}, {n:'PERFURANTE', p:20, t:'PIERCE'}, {n:'ESCUDO', p:25, t:'SHIELD'},
            {n:'VELOCIDADE', p:15, t:'SPEED'}, {n:'CADÃŠNCIA', p:20, t:'RATE'}, {n:'PENTE+', p:15, t:'CLIP'}, {n:'SUPER ARMA', p:40, t:'GUN'}
        ];
        pool.sort(()=>Math.random()-0.5).slice(0,3).forEach((u, i) => spawnItem(8+i*4, 12, u.n, u.p, u.t));
    } else {
        document.getElementById('biome-name').innerText = "ABISMO";
        for(let i=0; i<10; i++) map[Math.floor(Math.random()*map.length)] = 1;
        for(let i=0; i<2 + Math.floor(G.room/3); i++) enemies.push({x:(8+Math.random()*8)*TILE, y:(8+Math.random()*8)*TILE, hp: 50+(G.room*5), alive:true});
    }
    map[Math.floor(MAP_SIZE/2)] = 2;
    player.x = 12*TILE; player.y = 21*TILE; player.angle = -Math.PI/2;
    saveGame();
}

function spawnItem(tx, ty, name, price, type) { shopItems.push({ x: tx*TILE, y: ty*TILE, name, price, type, active: true }); }

function startGame() {
    G.isMobile = /Android|iPhone/i.test(navigator.userAgent);
    G.res = G.isMobile ? 6 : 4;
    document.querySelectorAll('.ui-screen').forEach(s => s.style.display = 'none');
    document.querySelectorAll('#hud, #crosshair, #minimap').forEach(s => s.style.display = 'block');
    if(G.isMobile) document.getElementById('mobile-ui').style.display = 'block';
    
    window.onkeydown = e => keys[e.key.toLowerCase()] = true;
    window.onkeyup = e => delete keys[e.key.toLowerCase()];
    canvas.onmousedown = e => { if(e.button===0) shoot(); if(e.button===2) interact(); };
    window.onmousemove = e => { if(document.pointerLockElement) { player.angle += e.movementX * 0.002; player.pitch = Math.max(-300, Math.min(300, player.pitch - e.movementY * 1.5)); } };
    
    // Mobile Touch
    const lookZone = document.getElementById('touch-look');
    lookZone.ontouchstart = e => { lookTouch.id = e.changedTouches[0].identifier; lookTouch.x = e.changedTouches[0].clientX; lookTouch.y = e.changedTouches[0].clientY; };
    lookZone.ontouchmove = e => {
        for(let t of e.changedTouches) if(t.identifier === lookTouch.id) {
            player.angle += (t.clientX - lookTouch.x) * 0.006;
            player.pitch = Math.max(-300, Math.min(300, player.pitch - (t.clientY - lookTouch.y) * 1.5));
            lookTouch.x = t.clientX; lookTouch.y = t.clientY;
        }
    };
    const joyBase = document.getElementById('joy-base');
    joyBase.ontouchmove = e => { const t = e.touches[0]; const r = joyBase.getBoundingClientRect(); window.mX = (t.clientX - (r.left+55))/50; window.mY = (t.clientY - (r.top+55))/50; };
    joyBase.ontouchend = () => { window.mX = 0; window.mY = 0; };
    document.getElementById('btn-fire').ontouchstart = e => { e.preventDefault(); shoot(); };
    document.getElementById('btn-use').ontouchstart = e => { e.preventDefault(); interact(); };
    document.getElementById('cheat-trigger').onclick = () => { if(++G.clicks >= 5) { G.god = true; G.hp = 999; G.souls = 999; alert("KADTR!"); } };

    if(!G.isMobile) canvas.onclick = () => canvas.requestPointerLock();
    setupRoom(); G.play = true; loop();
}

function shoot() {
    let now = Date.now();
    if(now - G.lastShot < G.fireRate) return;
    if(G.ammo <= 0 && !G.god) return;
    G.lastShot = now; if(!G.god) G.ammo--;
    const b = (a) => bullets.push({x: player.x, y: player.y, vx: Math.cos(a)*20, vy: Math.sin(a)*20, life: 60, p: G.pierce});
    b(player.angle);
    if(G.weaponType === 2) { b(player.angle-0.12); b(player.angle+0.12); }
}

function interact() {
    shopItems.forEach(s => {
        if(s.active && Math.hypot(player.x-s.x, player.y-s.y) < 100) {
            if(G.souls >= s.price || G.god) {
                G.souls -= s.price; s.active = false;
                if(s.type==='HP') G.hp=100;
                if(s.type==='GUN') G.weaponType=2;
                if(s.type==='PIERCE') G.pierce=true;
                if(s.type==='SHIELD') G.shield=true;
                if(s.type==='SPEED') G.speed+=1.2;
                if(s.type==='RATE') G.fireRate*=0.75;
                if(s.type==='CLIP') G.maxAmmo+=20;
                saveGame();
            }
        }
    });
}

function update() {
    if(!G.play) return;
    G.time += 0.05;
    if(Date.now() - G.lastShot > 1800 && G.ammo < G.maxAmmo) G.ammo += 0.1;

    let mx = 0, my = 0;
    // CORREÃ‡ÃƒO A E D: Adicionado suporte para strafe (movimento lateral)
    if(keys['w']) { mx += Math.cos(player.angle); my += Math.sin(player.angle); }
    if(keys['s']) { mx -= Math.cos(player.angle); my -= Math.sin(player.angle); }
    if(keys['a']) { mx += Math.cos(player.angle - Math.PI/2); my += Math.sin(player.angle - Math.PI/2); }
    if(keys['d']) { mx += Math.cos(player.angle + Math.PI/2); my += Math.sin(player.angle + Math.PI/2); }

    if(G.isMobile) {
        mx += (window.mY||0)*-Math.cos(player.angle) + (window.mX||0)*Math.cos(player.angle+1.57);
        my += (window.mY||0)*-Math.sin(player.angle) + (window.mX||0)*Math.sin(player.angle+1.57);
    }
    
    let nx = player.x + mx*G.speed, ny = player.y + my*G.speed;
    if(map[Math.floor(ny/TILE)*MAP_SIZE + Math.floor(nx/TILE)] !== 1) { player.x = nx; player.y = ny; }

    bullets = bullets.filter(b => {
        b.x += b.vx; b.y += b.vy; b.life--;
        if(map[Math.floor(b.y/TILE)*MAP_SIZE+Math.floor(b.x/TILE)]===1 || b.life <= 0) return false;
        let hit = false;
        enemies.forEach(en => { if(en.alive && Math.hypot(b.x-en.x, b.y-en.y) < 35) { en.hp -= 25; hit = !b.p; if(en.hp<=0){en.alive=false; G.souls+=3;} } });
        return !hit;
    });

    enemies.forEach(en => {
        if(!en.alive) return;
        let d = Math.hypot(player.x-en.x, player.y-en.y);
        if(d < 500) { en.x += (player.x-en.x)/d*2.2; en.y += (player.y-en.y)/d*2.2; }
        if(d < 45) { if(G.shield) { G.shield=false; en.alive=false; } else if(!G.god) { G.hp -= 0.5; if(G.hp<=0) location.reload(); } }
    });

    if(map[Math.floor(player.y/TILE)*MAP_SIZE+Math.floor(player.x/TILE)]===2 && enemies.every(e => !e.alive)) { G.room++; setupRoom(); }
    document.getElementById('hp-fill').style.width = G.hp + "%";
    document.getElementById('ammo-hud').innerText = Math.floor(G.ammo);
    document.getElementById('soul-hud').innerText = G.souls;
    document.getElementById('room-txt').innerText = G.room;
}

function draw() {
    ctx.fillStyle = "#020000"; ctx.fillRect(0,0,canvas.width, canvas.height/2+player.pitch);
    ctx.fillStyle = "#0a0505"; ctx.fillRect(0,canvas.height/2+player.pitch, canvas.width, canvas.height);
    const zBuffer = [];
    for(let i=0; i<canvas.width; i+=G.res) {
        let ang = (player.angle - player.fov/2) + (i/canvas.width)*player.fov;
        let d=0, hit=0, cos=Math.cos(ang), sin=Math.sin(ang);
        while(hit === 0 && d < 900) {
            d += 7;
            let tx = Math.floor((player.x + cos*d)/TILE), ty = Math.floor((player.y + sin*d)/TILE);
            if(map[ty*MAP_SIZE+tx] > 0) {
                hit = map[ty*MAP_SIZE+tx];
                let distNorm = d * Math.cos(player.angle-ang);
                zBuffer[i] = distNorm;
                let h = (TILE * canvas.height) / distNorm;
                ctx.fillStyle = hit === 2 ? "#0f0" : G.wallColor;
                ctx.fillRect(i, (canvas.height-h)/2 + player.pitch, G.res, h);
            }
        }
    }

    [...enemies, ...shopItems, ...bullets].forEach(s => {
        if(s.alive === false || s.active === false) return;
        let dx = s.x - player.x, dy = s.y - player.y;
        let dist = Math.hypot(dx, dy);
        let ang = Math.atan2(dy, dx) - player.angle;
        while(ang < -Math.PI) ang += Math.PI*2; while(ang > Math.PI) ang -= Math.PI*2;
        if(Math.abs(ang) < player.fov) {
            let sx = (0.5 * (ang/(player.fov/2)) + 0.5) * canvas.width;
            if(dist < (zBuffer[Math.floor(sx)] || 999)) {
                let sh = (TILE * canvas.height) / dist;
                let sy = (canvas.height/2) + player.pitch;
                if(s.price) { // Shop Pedestal
                    ctx.fillStyle = "#333"; ctx.fillRect(sx-sh/4, sy+sh/8, sh/2, sh/2);
                    let bob = Math.sin(G.time*2)*12;
                    ctx.fillStyle = "#ff0"; ctx.fillRect(sx-sh/10, sy-sh/4+bob, sh/5, sh/5);
                    ctx.fillStyle = "#fff"; ctx.font = "bold 10px Orbitron";
                    ctx.fillText(`${s.name}`, sx-20, sy-sh/2+bob);
                    ctx.fillStyle = "#ff0"; ctx.fillText(`$${s.price}`, sx-10, sy+sh/1.5);
                } else {
                    ctx.fillStyle = s.vx ? "#fff" : "#800";
                    ctx.fillRect(sx-sh/10, sy-sh/10, sh/5, sh/5);
                }
            }
        }
    });

    mCtx.clearRect(0,0,100,100);
    mCtx.fillStyle = "#111"; mCtx.beginPath(); mCtx.arc(50,50,48,0,Math.PI*2); mCtx.fill();
    const ms = 100/MAP_SIZE;
    for(let y=0; y<MAP_SIZE; y++) for(let x=0; x<MAP_SIZE; x++) {
        if(map[y*MAP_SIZE+x] === 1) { mCtx.fillStyle = "#444"; mCtx.fillRect(x*ms, y*ms, ms, ms); }
        if(map[y*MAP_SIZE+x] === 2) { mCtx.fillStyle = "#0f0"; mCtx.fillRect(x*ms, y*ms, ms, ms); }
    }
    mCtx.fillStyle = "#f00"; mCtx.fillRect((player.x/TILE)*ms-1, (player.y/TILE)*ms-1, 2, 2);
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; mCanvas.width=100; mCanvas.height=100; };
window.onresize();
</script>
</body>
</html>
