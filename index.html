<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow 3D ðŸ’€ Immersive</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Nosifer&family=Special+Elite&display=swap');
        
        * { touch-action: none; user-select: none; box-sizing: border-box; }
        body { margin: 0; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; width: 100vw; height: 100vh; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }

        /* Telas de UI */
        .ui-screen { position: absolute; inset: 0; background: radial-gradient(circle at center, #1a0000 0%, #000000 100%); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #death-screen { display: none; background: rgba(30, 0, 0, 0.9); z-index: 4000; }
        #death-screen h2 { font-family: 'Nosifer'; color: #f00; font-size: 50px; }
        
        .btn-main { padding: 15px 40px; font-size: 18px; background: transparent; border: 2px solid #a00; color: #fff; cursor: pointer; font-family: 'Orbitron'; margin-top: 20px; }

        /* HUD */
        #hud { position: absolute; top: 10px; left: 10px; z-index: 1000; display: none; }
        .hud-bar { width: 150px; height: 12px; background: #222; border: 1px solid #444; margin-bottom: 5px; }
        #hp-fill { height: 100%; background: #f00; width: 100%; transition: 0.2s; }
        #blood-overlay { position: absolute; inset: 0; background: radial-gradient(circle, transparent 50%, rgba(150,0,0,0.5) 100%); pointer-events: none; display: none; z-index: 2500; }

        /* Controles Mobile */
        .mobile-ui { position: absolute; inset: 0; display: none; z-index: 2000; pointer-events: none; }
        #joy-container { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: #f00; border-radius: 50%; opacity: 0.6; }
        #shoot-area { position: absolute; bottom: 50px; right: 50px; width: 100px; height: 100px; background: rgba(255,0,0,0.2); border: 2px solid #f00; border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: auto; font-weight: bold; }

        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #f00; font-size: 20px; pointer-events: none; z-index: 1500; opacity: 0.5; }
    </style>
</head>
<body>

<div id="start-screen" class="ui-screen">
    <h1 style="font-family:'Nosifer'; color:#800;">DEN OF SHADOW</h1>
    <button class="btn-main" onclick="initGame()">RECLAMAR ALMA</button>
</div>

<div id="death-screen" class="ui-screen">
    <h2>VOCÃŠ CAIU</h2>
    <p>As sombras consumiram o que restava.</p>
    <button class="btn-main" onclick="location.reload()">TENTAR NOVAMENTE</button>
</div>

<div id="blood-overlay"></div>

<div id="hud">
    <div>VITALIDADE</div>
    <div class="hud-bar"><div id="hp-fill"></div></div>
    <div style="font-size: 12px; color: #880;">ALMA: <span id="ammo-txt">40</span></div>
    <div style="font-size: 18px; color: #fff;">SALA: <span id="room-txt">0</span></div>
</div>

<div id="crosshair">âœ›</div>

<div id="mobile-controls" class="mobile-ui">
    <div id="joy-container"><div id="joy-stick"></div></div>
    <div id="shoot-area">FOGO</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- CONFIGURAÃ‡Ã•ES ---
const TILE_SIZE = 64;
const MAP_SIZE = 16;
let map = [];
let bullets = [];
let enemies = [];

const G = {
    play: false, room: 0, hp: 100, maxHp: 100, 
    ammo: 40, lastShot: 0, kadtr: false
};

const player = {
    x: 100, y: 100, angle: 0,
    moveX: 0, moveY: 0, // Joystick
    fov: Math.PI / 3,
    rotDir: 0
};

// --- MULTI-TOUCH MANAGER ---
let moveTouchId = null;
let camTouchId = null;
let lastCamX = 0;

function initGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    if('ontouchstart' in window) document.getElementById('mobile-controls').style.display = 'block';
    G.play = true;
    generateMap();
    spawnEnemies();
    loop();
}

function generateMap() {
    map = Array(MAP_SIZE * MAP_SIZE).fill(0);
    for(let i=0; i<MAP_SIZE; i++) {
        map[i] = 1; map[i + (MAP_SIZE*(MAP_SIZE-1))] = 1;
        map[i * MAP_SIZE] = 1; map[i * MAP_SIZE + (MAP_SIZE-1)] = 1;
    }
    map[Math.floor(MAP_SIZE/2)] = 2; // Porta de saÃ­da
}

function spawnEnemies() {
    enemies = [];
    let n = 3 + Math.floor(G.room * 0.7);
    for(let i=0; i<n; i++) {
        enemies.push({
            x: (3 + Math.random() * 10) * TILE_SIZE,
            y: (3 + Math.random() * 10) * TILE_SIZE,
            hp: 50 + (G.room * 15),
            alive: true,
            size: 30
        });
    }
}

// --- SISTEMA DE TIRO ---
function shoot() {
    if(!G.play || G.ammo <= 0 || Date.now() - G.lastShot < 250) return;
    G.ammo--;
    G.lastShot = Date.now();
    bullets.push({
        x: player.x, y: player.y,
        vx: Math.cos(player.angle) * 12,
        vy: Math.sin(player.angle) * 12,
        life: 60
    });
}

// --- INPUTS (CORRIGIDO PARA MULTI-TOUCH) ---
const joyContainer = document.getElementById('joy-container');
const joyStick = document.getElementById('joy-stick');

window.addEventListener('touchstart', e => {
    for(let t of e.changedTouches) {
        // Lado Esquerdo: Movimento
        if(t.clientX < window.innerWidth / 2 && moveTouchId === null) {
            moveTouchId = t.identifier;
            updateJoystick(t);
        } 
        // Lado Direito: CÃ¢mera (se nÃ£o for no botÃ£o de tiro)
        else if(t.clientX >= window.innerWidth / 2 && camTouchId === null) {
            if(t.target.id !== 'shoot-area') {
                camTouchId = t.identifier;
                lastCamX = t.clientX;
            }
        }
    }
}, {passive: false});

window.addEventListener('touchmove', e => {
    e.preventDefault();
    for(let t of e.changedTouches) {
        if(t.identifier === moveTouchId) updateJoystick(t);
        if(t.identifier === camTouchId) {
            let dx = t.clientX - lastCamX;
            player.angle += dx * 0.007;
            lastCamX = t.clientX;
        }
    }
}, {passive: false});

window.addEventListener('touchend', e => {
    for(let t of e.changedTouches) {
        if(t.identifier === moveTouchId) {
            moveTouchId = null;
            player.moveX = 0; player.moveY = 0;
            joyStick.style.transform = `translate(0,0)`;
        }
        if(t.identifier === camTouchId) camTouchId = null;
    }
});

function updateJoystick(t) {
    const rect = joyContainer.getBoundingClientRect();
    const centerX = rect.left + rect.width/2;
    const centerY = rect.top + rect.height/2;
    const dx = t.clientX - centerX;
    const dy = t.clientY - centerY;
    const dist = Math.min(40, Math.hypot(dx, dy));
    const ang = Math.atan2(dy, dx);
    
    joyStick.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
    player.moveX = Math.cos(ang) * (dist/40);
    player.moveY = Math.sin(ang) * (dist/40);
}

document.getElementById('shoot-area').addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });

// Teclado (Suporte Mobile/Console/PC)
const keys = {};
window.onkeydown = e => { 
    keys[e.key.toLowerCase()] = true; 
    if(e.key === ' ') shoot(); 
};
window.onkeyup = e => delete keys[e.key.toLowerCase()];

// --- LÃ“GICA DO JOGO ---
function update() {
    if(!G.play) return;

    // Movimento Relativo Ã  CÃ¢mera
    let speed = 4;
    let mvX = 0, mvY = 0;

    // Teclado
    if(keys['w']) { mvX += Math.cos(player.angle); mvY += Math.sin(player.angle); }
    if(keys['s']) { mvX -= Math.cos(player.angle); mvY -= Math.sin(player.angle); }
    if(keys['a']) player.angle -= 0.04;
    if(keys['d']) player.angle += 0.04;

    // Joystick (Frente/TrÃ¡s e Strafe)
    if(moveTouchId !== null) {
        // moveY do joystick controla frente/atrÃ¡s, moveX controla strafe (opcional, aqui controla direÃ§Ã£o)
        mvX += Math.cos(player.angle) * -player.moveY + Math.cos(player.angle + Math.PI/2) * player.moveX;
        mvY += Math.sin(player.angle) * -player.moveY + Math.sin(player.angle + Math.PI/2) * player.moveX;
    }

    let nX = player.x + mvX * speed;
    let nY = player.y + mvY * speed;

    // ColisÃ£o
    const getTile = (x, y) => map[Math.floor(y/TILE_SIZE)*MAP_SIZE + Math.floor(x/TILE_SIZE)];
    if(getTile(nX, nY) === 0) {
        player.x = nX; player.y = nY;
    } else if(getTile(nX, nY) === 2) {
        if(enemies.filter(e=>e.alive).length === 0) {
            G.room++; player.x = 100; player.y = 100; spawnEnemies();
        }
    }

    // Balas
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy; b.life--;
        if(getTile(b.x, b.y) > 0 || b.life <= 0) bullets.splice(i, 1);
        
        enemies.forEach(en => {
            if(en.alive && Math.hypot(b.x - en.x, b.y - en.y) < 25) {
                en.hp -= 50;
                bullets.splice(i, 1);
                if(en.hp <= 0) en.alive = false;
            }
        });
    });

    // Inimigos e Dano
    enemies.forEach(en => {
        if(!en.alive) return;
        let d = Math.hypot(player.x - en.x, player.y - en.y);
        if(d > 40) {
            en.x += (player.x - en.x)/d * 1.8;
            en.y += (player.y - en.y)/d * 1.8;
        } else {
            takeDamage(0.5);
        }
    });

    if(G.ammo < 40) G.ammo += 0.02;
}

function takeDamage(amt) {
    if(G.kadtr) return;
    G.hp -= amt;
    const overlay = document.getElementById('blood-overlay');
    overlay.style.display = 'block';
    setTimeout(() => overlay.style.display = 'none', 100);
    if(G.hp <= 0) { G.play = false; document.getElementById('death-screen').style.display = 'flex'; }
}

// --- RENDERIZAÃ‡ÃƒO ---
function draw() {
    // Fundo (Brilho aumentado)
    ctx.fillStyle = "#100"; ctx.fillRect(0,0,canvas.width, canvas.height/2);
    ctx.fillStyle = "#2a0a0a"; ctx.fillRect(0,canvas.height/2, canvas.width, canvas.height/2);

    const rays = canvas.width / 2;
    const step = player.fov / rays;

    for(let i=0; i<rays; i++) {
        let ang = (player.angle - player.fov/2) + (i * step);
        let dist = 0, hit = false;
        let cos = Math.cos(ang), sin = Math.sin(ang);

        while(!hit && dist < 900) {
            dist += 4;
            let tx = Math.floor((player.x + cos*dist)/TILE_SIZE);
            let ty = Math.floor((player.y + sin*dist)/TILE_SIZE);
            let tile = map[ty * MAP_SIZE + tx];
            if(tile > 0) {
                hit = true;
                let wallH = (TILE_SIZE * canvas.height) / (dist * Math.cos(player.angle - ang));
                let color = (tile === 2) ? 255 : 120; // Brilho aumentado nas paredes
                let lum = Math.max(20, color - (dist/5));
                ctx.fillStyle = `rgb(${lum}, ${lum/4}, ${lum/4})`;
                ctx.fillRect(i*2, (canvas.height-wallH)/2, 2, wallH);
            }
        }
    }

    // Inimigos
    enemies.forEach(en => {
        if(!en.alive) return;
        let ang = Math.atan2(en.y - player.y, en.x - player.x) - player.angle;
        while(ang < -Math.PI) ang += Math.PI*2;
        while(ang > Math.PI) ang -= Math.PI*2;
        if(Math.abs(ang) < player.fov) {
            let d = Math.hypot(player.x - en.x, player.y - en.y);
            let sx = (0.5 * (ang / (player.fov/2)) + 0.5) * canvas.width;
            let sh = (TILE_SIZE * canvas.height) / d;
            ctx.fillStyle = "#000";
            ctx.shadowBlur = 20; ctx.shadowColor = "#f00";
            ctx.fillRect(sx - sh/4, (canvas.height-sh)/2, sh/2, sh);
            ctx.shadowBlur = 0;
        }
    });

    // Balas
    bullets.forEach(b => {
        let ang = Math.atan2(b.y - player.y, b.x - player.x) - player.angle;
        while(ang < -Math.PI) ang += Math.PI*2;
        while(ang > Math.PI) ang -= Math.PI*2;
        if(Math.abs(ang) < player.fov) {
            let d = Math.hypot(player.x - b.x, player.y - b.y);
            let sx = (0.5 * (ang / (player.fov/2)) + 0.5) * canvas.width;
            let sz = 1500 / d;
            ctx.fillStyle = "#ff0";
            ctx.beginPath(); ctx.arc(sx, canvas.height/2, sz, 0, Math.PI*2); ctx.fill();
        }
    });

    document.getElementById('hp-fill').style.width = G.hp + "%";
    document.getElementById('ammo-txt').innerText = Math.floor(G.ammo);
    document.getElementById('room-txt').innerText = G.room;
}

function loop() {
    if(G.play) { update(); draw(); }
    requestAnimationFrame(loop);
}

window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize();
</script>
</body>
</html>
