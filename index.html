<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Den of Shadow üíÄ</title>
    <style>
        :root { --c-common: #3498db; --c-uncommon: #2ecc71; --c-rare: #f1c40f; --c-epic: #9b59b6; --c-legend: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet); }
        * { touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: 'Verdana', sans-serif; color: white; }
        canvas { display: block; image-rendering: pixelated; }

        /* UI de Telas */
        .overlay { position: absolute; inset: 0; background: rgba(20, 20, 35, 0.95); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn-ui { padding: 15px 40px; background: #4ecca3; border: none; color: #1a1a2e; font-size: 22px; font-weight: bold; border-radius: 12px; cursor: pointer; margin: 10px; }
        .social-link { color: #aaa; text-decoration: none; font-size: 14px; margin: 5px; transition: 0.3s; }
        .social-link:hover { color: #fff; }

        /* HUD Mobile */
        #mobile-hud { position: absolute; inset: 0; pointer-events: none; display: none; }
        #joy-zone { position: absolute; bottom: 40px; left: 40px; width: 150px; height: 150px; pointer-events: auto; }
        #joy-stick { width: 60px; height: 60px; background: rgba(255,255,255,0.3); border-radius: 50%; position: absolute; left: 45px; top: 45px; border: 2px solid #fff; }
        #atk-zone { position: absolute; bottom: 40px; right: 40px; display: grid; grid-template-columns: repeat(3, 80px); gap: 10px; pointer-events: auto; }
        .btn-atk { width: 80px; height: 80px; background: rgba(255,255,255,0.1); border: 3px solid rgba(255,255,255,0.4); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; }
        #swap-btn { position: absolute; bottom: 60px; right: 300px; width: 90px; height: 90px; background: #f1c40f; border-radius: 50%; border: 4px solid #fff; pointer-events: auto; display: flex; justify-content: center; align-items: center; color: #000; font-weight: bold; }
        #fs-btn { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); padding: 8px 15px; background: rgba(0,0,0,0.5); border: 1px solid #fff; border-radius: 20px; pointer-events: auto; z-index: 2100; font-size: 12px; }

        /* Cartas de Upgrade */
        #card-screen { display: none; z-index: 3000; flex-direction: row; }
        .card { width: 220px; height: 320px; margin: 10px; padding: 20px; border: 5px solid #fff; border-radius: 15px; background: #16213e; cursor: pointer; text-align: center; position: relative; overflow: hidden; }
        .card h3 { margin-top: 0; }
        .card p { font-size: 13px; line-height: 1.4; color: #ccc; }
        .card::after { content: 'üíÄ'; position: absolute; bottom: -20px; right: -20px; font-size: 100px; opacity: 0.1; }

        #info-box { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 2px solid #f1c40f; padding: 15px; border-radius: 10px; display: none; pointer-events: none; }
    </style>
</head>
<body>

<div id="fs-btn" onclick="toggleFS()">TELA CHEIA</div>

<div id="start-screen" class="overlay">
    <h1 style="font-size: 55px; color: #ff4d6d;">üíÄ DEN OF SHADOW</h1>
    <p id="platform-hint" style="color: #4ecca3; font-weight: bold;"></p>
    <div class="btn-ui" id="btn-start">JOGAR</div>
    <a href="mailto:kauadarthofc@gmail.com" class="social-link">üì© kauadarthofc@gmail.com</a>
    <a href="https://youtube.com/@kaua_darth" target="_blank" class="social-link">üé¨ YouTube: @kaua_darth</a>
</div>

<div id="card-screen" class="overlay">
    <h2 style="color: #f1c40f; margin-bottom: 20px;">MELHORIA DISPON√çVEL</h2>
    <div id="cards-container" style="display:flex;"></div>
</div>

<div id="death-screen" class="overlay" style="display:none;">
    <h1 style="color: #e74c3c;">FIM DA LINHA</h1>
    <div class="btn-ui" onclick="location.reload()">TENTAR NOVAMENTE</div>
</div>

<div id="info-box"></div>

<canvas id="game"></canvas>

<div id="mobile-hud">
    <div id="joy-zone"><div id="joy-stick"></div></div>
    <div id="atk-zone">
        <div></div><div class="btn-atk" data-dir="up">‚ñ≤</div><div></div>
        <div class="btn-atk" data-dir="left">‚óÄ</div><div class="btn-atk" data-dir="down">‚ñº</div><div class="btn-atk" data-dir="right">‚ñ∂</div>
    </div>
    <div id="swap-btn">SWAP</div>
</div>

<script>
/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

const G = {
    started: false, room: 0, isHealRoom: false,
    roomW: 1600, roomH: 1200, camX: 0, camY: 0,
    hp: 6, maxHp: 6, kills: 0,
    weapon: 'magnum', triple: 0, ric: 0, dual: false, vamp: 0, pets: 0,
    hasFire: false, hasShot: false, hasStaff: false,
    inv: {
        magnum: { a: 12, m: 12, d: 10, c: "#0ff", n: "Magnum", cd: 15, info: "Dano: 10 | Precis√£o: Alta" },
        fire: { a: 25, m: 25, d: 4, c: "#ff4500", n: "Baforada", cd: 3, info: "Dano: 4 + 2 Queima | Cad√™ncia: Extrema" },
        shotgun: { a: 5, m: 5, d: 17, c: "#f1c40f", n: "Shotgun", cd: 50, info: "Dano: 17x3 | Alcance: Baix√≠ssimo" },
        staff: { a: 10, m: 10, d: 15, c: "#9b59b6", n: "Cajado", cd: 20, info: "Dano: 15 | Tiros Teleguiados" }
    }
};

let enemies = [], projectiles = [], drops = [], pedestals = [], warnings = [], pets = [];
let p = { x: 800, y: 600, w: 40, h: 44, r: 22, iframe: 0, timer: 0, legAn: 0, rel: false, relT: 0, alive: true };
const keys = new Set();
const atkDir = { up: false, down: false, left: false, right: false };
const joy = { active: false, x: 0, y: 0, sx: 0, sy: 0 };

if(isMobile) {
    document.getElementById('mobile-hud').style.display = 'block';
    document.getElementById('platform-hint').innerText = "CONTROLES TOUCH ATIVOS";
} else {
    document.getElementById('platform-hint').innerText = "WASD: MOVER | SETAS: ATIRAR | Q: SWAP";
}

function initRoom() {
    enemies = []; projectiles = []; drops = []; pedestals = []; warnings = [];
    p.x = G.roomW/2; p.y = G.roomH/2; p.iframe = 40;

    if(G.room === 0) return; // Tutorial: Vazia

    if(G.room % 10 === 0) {
        enemies.push({ type:'boss', x:G.roomW/2, y:300, hp:1000+G.room*100, max:1000+G.room*100, r:80, w:160, h:160, hit:0, t:0, name: `BOSS: ANDAR ${G.room}` });
    } else if(!G.isHealRoom) {
        let n = 3 + Math.floor(G.room/3);
        for(let i=0; i<n; i++) {
            let ex, ey;
            do { ex = 200+Math.random()*(G.roomW-400); ey = 200+Math.random()*(G.roomH-400); } while(Math.hypot(ex-p.x, ey-p.y) < 500);
            let type = G.room < 2 ? 'stalker' : (Math.random() < 0.3 ? 'dasher' : (Math.random() < 0.2 ? 'kamikaze' : 'stalker'));
            enemies.push({ type, x:ex, y:ey, r:25, hp:60+G.room*15, w:50, h:50, hit:0, ft:0, dt:0, face: Math.floor(Math.random()*3) });
        }
    }

    if(G.room === 5 && !G.hasFire) pedestals.push({x:G.roomW/2, y:400, type:'fire'});
    if(G.room === 15 && !G.hasShot) pedestals.push({x:G.roomW/2, y:400, type:'shotgun'});
    if(G.room === 25 && !G.hasStaff) pedestals.push({x:G.roomW/2, y:400, type:'staff'});
}

function resolveCollision(a, b) {
    let dx = a.x - b.x, dy = a.y - b.y;
    let dist = Math.hypot(dx, dy);
    let min = a.r + b.r;
    if(dist < min) {
        let ang = Math.atan2(dy, dx);
        let overlap = min - dist;
        a.x += Math.cos(ang) * overlap * 0.5; a.y += Math.sin(ang) * overlap * 0.5;
        b.x -= Math.cos(ang) * overlap * 0.5; b.y -= Math.sin(ang) * overlap * 0.5;
    }
}

function fire(dx, dy) {
    const w = G.inv[G.weapon];
    if(p.rel || w.a <= 0) return;
    if(p.timer % w.cd === 0) {
        let ang = Math.atan2(dy, dx);
        let count = (1 + G.triple) * (G.dual ? 2 : 1);
        for(let i=0; i<count; i++) {
            let a = ang + (i - (count-1)/2) * 0.2;
            if(G.weapon==='fire') {
                projectiles.push({x:p.x, y:p.y, dx:Math.cos(a)*12, dy:Math.sin(a)*12, type:'fire', life:25, dmg:w.d});
            } else if(G.weapon==='shotgun') {
                for(let j=-1; j<=1; j++) projectiles.push({x:p.x, y:p.y, dx:Math.cos(a+j*0.3)*14, dy:Math.sin(a+j*0.3)*14, type:'shotgun', life:15, dmg:w.d});
            } else {
                projectiles.push({x:p.x, y:p.y, dx:Math.cos(a)*16, dy:Math.sin(a)*16, type:G.weapon, life:100, dmg:w.d});
            }
        }
        w.a--; if(w.a <= 0) p.rel = true;
    }
}

function update() {
    if(!G.started || !p.alive) return;

    let mx = joy.active ? joy.x : (keys.has('a')?-1:keys.has('d')?1:0);
    let my = joy.active ? joy.y : (keys.has('w')?-1:keys.has('s')?1:0);
    p.x = Math.max(50, Math.min(G.roomW-50, p.x + mx * 5.5));
    p.y = Math.max(50, Math.min(G.roomH-50, p.y + my * 5.5));
    if(mx||my) p.legAn += 0.25;

    if(p.rel) { p.relT++; if(p.relT > 60){ G.inv[G.weapon].a = G.inv[G.weapon].m; p.rel=false; p.relT=0; }}

    let ax = (keys.has('arrowleft')?-1:keys.has('arrowright')?1:0);
    let ay = (keys.has('arrowup')?-1:keys.has('arrowdown')?1:0);
    if(atkDir.up) ay=-1; if(atkDir.down) ay=1; if(atkDir.left) ax=-1; if(atkDir.right) ax=1;
    if(ax||ay) fire(ax, ay);

    // Inimigos
    enemies.forEach((e, i) => {
        let ang = Math.atan2(p.y-e.y, p.x-e.x);
        let dist = Math.hypot(p.x-e.x, p.y-e.y);

        if(e.type==='boss') {
            e.t++; e.x += Math.cos(e.t/50)*3; e.y += Math.sin(e.t/70)*2;
            if(G.room === 10 && e.t % 90 === 0) warnings.push({x:200+Math.random()*1200, y:200+Math.random()*800, t:90});
        } else {
            let s = e.type==='kamikaze'?1.2:2.2;
            if(e.type==='dasher') { e.dt++; if(e.dt>120){ e.x+=Math.cos(ang)*10; e.y+=Math.sin(ang)*10; if(e.dt>135)e.dt=0; } else { e.x+=Math.cos(ang)*s; e.y+=Math.sin(ang)*s; } }
            else { e.x+=Math.cos(ang)*s; e.y+=Math.sin(ang)*s; }
        }

        enemies.forEach((e2, j) => { if(i!==j) resolveCollision(e, e2); });
        resolveCollision(e, p);

        if(p.iframe <= 0 && dist < 50) { 
            G.hp -= (e.type==='kamikaze'?2:1); p.iframe=60; 
            if(e.type==='kamikaze') e.hp=0;
        }

        if(e.ft > 0 && p.timer % 30 === 0){ e.hp -= 2; e.ft--; e.hit=5; }
        if(e.hp <= 0) {
            if(e.type==='kamikaze') enemies.forEach(o => { if(o!==e && Math.hypot(e.x-o.x, e.y-o.y) < 200) o.hp -= 150; });
            G.kills++; if(G.vamp>0 && G.kills%10===0) G.hp = Math.min(G.maxHp, G.hp+1);
            if(Math.random()<0.2) drops.push({x:e.x, y:e.y, type:'heal'});
            if(Math.random()<0.1) drops.push({x:e.x, y:e.y, type:'ammo'});
            if(e.type==='boss') showUpgrades();
            enemies.splice(i,1);
        }
        if(e.hit>0) e.hit--;
    });

    // Proj√©teis
    projectiles.forEach((pr, i) => {
        if(pr.type==='staff' && !pr.enemy) {
            let target = enemies[0];
            if(target){ let ta = Math.atan2(target.y-pr.y, target.x-pr.x); pr.dx += Math.cos(ta)*0.8; pr.dy += Math.sin(ta)*0.8; }
        }
        pr.x += pr.dx; pr.y += pr.dy; pr.life--;
        if(!pr.enemy) {
            enemies.forEach(e => {
                if(Math.hypot(pr.x-e.x, pr.y-e.y) < e.r+10) {
                    e.hp -= pr.dmg; if(pr.type==='fire') e.ft=5; e.hit=5;
                    if(G.ric > 0 && !pr.rd) { pr.dx *= -1; pr.dy *= -1; pr.rd=true; } else projectiles.splice(i,1);
                }
            });
        } else if(Math.hypot(pr.x-p.x, pr.y-p.y) < 35 && p.iframe<=0) { G.hp--; p.iframe=60; projectiles.splice(i,1); }
        if(pr.life <= 0) projectiles.splice(i,1);
    });

    warnings.forEach((w, i) => { w.t--; if(w.t<=0){ projectiles.push({x:w.x, y:w.y-600, dx:0, dy:12, type:'rock', life:100, dmg:1, enemy:true}); warnings.splice(i,1); } });

    // Pedestais e Drops
    let hMsg = "";
    pedestals.forEach((ped, i) => {
        let d = Math.hypot(p.x-ped.x, p.y-ped.y);
        if(d < 150) hMsg = G.inv[ped.type].info;
        if(d < 60) { G['has'+ped.type.charAt(0).toUpperCase()+ped.type.slice(1)]=true; pedestals.splice(i,1); }
    });
    document.getElementById('info-box').innerText = hMsg;
    document.getElementById('info-box').style.display = hMsg ? 'block' : 'none';

    drops.forEach((d, i) => {
        if(Math.hypot(p.x-d.x, p.y-d.y) < 50) {
            if(d.type==='heal') G.hp = Math.min(G.maxHp, G.hp+1);
            if(d.type==='ammo') G.inv[G.weapon].a = G.inv[G.weapon].m;
            drops.splice(i,1);
        }
    });

    // Portas
    if(enemies.length === 0) {
        if(Math.hypot(p.x-G.roomW/2, p.y) < 70) { G.room++; G.isHealRoom=false; initRoom(); }
        if(G.room > 0 && G.room % 10 === 0 && Math.hypot(p.x, p.y-G.roomH/2) < 70) { G.isHealRoom=true; initRoom(); }
    }

    if(p.iframe > 0) p.iframe--;
    if(G.hp <= 0) { p.alive = false; document.getElementById('death-screen').style.display='flex'; }
    p.timer++;
}

function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    if(!p.alive) return;
    
    ctx.save();
    G.camX += (p.x - canvas.width/2 - G.camX) * 0.1; G.camY += (p.y - canvas.height/2 - G.camY) * 0.1;
    ctx.translate(-G.camX, -G.camY);

    // Cen√°rio (Leg√≠vel)
    ctx.fillStyle = G.isHealRoom ? "#2d5a27" : (G.room % 10 === 0 ? "#5a2d2d" : "#2c3e50");
    ctx.fillRect(0,0, G.roomW, G.roomH);
    ctx.strokeStyle = "rgba(255,255,255,0.1)";
    for(let i=0; i<G.roomW; i+=100) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, G.roomH); ctx.stroke(); }

    // Avisos
    warnings.forEach(w => { ctx.strokeStyle="red"; ctx.beginPath(); ctx.arc(w.x, w.y, 60, 0, 7); ctx.stroke(); });

    // Player
    let ly = Math.sin(p.legAn)*8;
    ctx.fillStyle="#fff"; ctx.fillRect(p.x-15, p.y+20+ly, 10, 8); ctx.fillRect(p.x+5, p.y+20-ly, 10, 8);
    ctx.fillStyle = (p.iframe>0 && p.timer%4<2)?"#ff4d6d":"#4ecca3";
    ctx.fillRect(p.x-20, p.y-22, 40, 42);
    ctx.fillStyle="#000"; ctx.fillRect(p.x-12, p.y-10, 6, 6); ctx.fillRect(p.x+6, p.y-10, 6, 6);

    // Inimigos
    enemies.forEach(e => {
        ctx.fillStyle = e.hit>0?"#fff":(e.type==='kamikaze'?"#f1c40f":(e.type==='boss'?"#e74c3c":"#3498db"));
        ctx.fillRect(e.x-e.w/2, e.y-e.h/2, e.w, e.h);
        if(e.type==='dasher'){ ctx.fillStyle="#fff"; ctx.fillRect(e.x-e.w/2-10, e.y-5, 10, 20); ctx.fillRect(e.x+e.w/2, e.y-5, 10, 20); }
        ctx.fillStyle = e.type==='kamikaze'?"red":"#000";
        ctx.fillRect(e.x-15, e.y-10, 5, 5); ctx.fillRect(e.x+10, e.y-10, 5, 5);
        if(e.type==='boss'){
            ctx.restore(); ctx.save();
            ctx.fillStyle="rgba(0,0,0,0.8)"; ctx.fillRect(canvas.width/2-200, 20, 400, 30);
            ctx.fillStyle="#ff4d6d"; ctx.fillRect(canvas.width/2-200, 20, (e.hp/e.max)*400, 30);
            ctx.restore(); ctx.save(); ctx.translate(-G.camX, -G.camY);
        }
    });

    // Proj√©teis e Drops
    projectiles.forEach(pr => { ctx.fillStyle=pr.enemy?"#777":G.inv[pr.type].c; ctx.fillRect(pr.x-5, pr.y-5, 12, 12); });
    drops.forEach(d => { ctx.fillStyle=d.type==='heal'?"#ff4d6d":"#f1c40f"; ctx.fillRect(d.x-10, d.y-10, 20, 20); });
    pedestals.forEach(ped => { ctx.fillStyle="#f1c40f"; ctx.fillRect(ped.x-20, ped.y-20, 40, 40); });

    // Portas
    if(enemies.length === 0){ ctx.fillStyle="#4ecca3"; ctx.fillRect(G.roomW/2-60, 0, 120, 20); if(G.room%10===0) { ctx.fillStyle="#f1c40f"; ctx.fillRect(0, G.roomH/2-60, 20, 120); } }

    ctx.restore();

    // HUD
    ctx.fillStyle="#fff"; ctx.font="bold 20px Arial"; ctx.fillText(`SALA: ${G.room}`, 20, 40);
    ctx.fillText(`${G.inv[G.weapon].n}: ${G.inv[G.weapon].a}/${G.inv[G.weapon].m}`, 20, 110);
    for(let i=0; i<G.maxHp; i++){ ctx.fillStyle=i<G.hp?"#ff4d6d":"#333"; ctx.beginPath(); ctx.arc(35+i*35, 75, 14, 0, 7); ctx.fill(); }

    // Minimapa
    const mx=canvas.width-160, my=20, ms=140;
    ctx.fillStyle="rgba(0,0,0,0.6)"; ctx.fillRect(mx, my, ms, ms);
    ctx.strokeStyle="#fff"; ctx.strokeRect(mx, my, ms, ms);
    enemies.forEach(e => { ctx.fillStyle="red"; ctx.fillRect(mx+(e.x/G.roomW)*ms, my+(e.y/G.roomH)*ms, 4, 4); });
    ctx.fillStyle="#fff"; ctx.fillRect(mx+(p.x/G.roomW)*ms, my+(p.y/G.roomH)*ms, 5, 5);

    requestAnimationFrame(() => { update(); draw(); });
}

function showUpgrades() {
    G.started = false; document.getElementById('card-screen').style.display='flex';
    const container = document.getElementById('cards-container'); container.innerHTML='';
    const pool = [
        {n:"TIRO TRIPLO", d:"Dispara em 3 dire√ß√µes. Acumula at√© 4x.", r:"common", c:"#3498db", a:()=>G.triple=Math.min(4, G.triple+1)},
        {n:"VAMPIRISMO", d:"Recupera 1 HP a cada 10 mortes.", r:"uncommon", c:"#2ecc71", a:()=>G.vamp++},
        {n:"RICOCHETE", d:"Balas quicam nas paredes.", r:"rare", c:"#f1c40f", a:()=>G.ric++},
        {n:"DUAL WIELD", d:"LEND√ÅRIO: Use duas armas ao mesmo tempo!", r:"legend", c:"#ff00ff", a:()=>G.dual=true}
    ];

    for(let i=0; i<3; i++) {
        let up = pool[Math.floor(Math.random()*pool.length)];
        let card = document.createElement('div'); card.className = 'card';
        card.style.borderColor = up.c;
        card.innerHTML = `<h3>${up.n}</h3><p>${up.d}</p><div style="margin-top:20px; color:${up.c}">${up.r.toUpperCase()}</div>`;
        card.onclick = () => { up.a(); document.getElementById('card-screen').style.display='none'; G.started=true; };
        container.appendChild(card);
    }
}

// Controles
const jz = document.getElementById('joy-zone'), js = document.getElementById('joy-stick');
jz.ontouchstart = (e) => { joy.active=true; let r=jz.getBoundingClientRect(); joy.sx=r.left+75; joy.sy=r.top+75; };
jz.ontouchmove = (e) => {
    if(!joy.active) return; let t=e.touches[0];
    let dx=t.clientX-joy.sx, dy=t.clientY-joy.sy;
    let d=Math.min(Math.hypot(dx,dy), 50); let a=Math.atan2(dy,dx);
    joy.x=(Math.cos(a)*d)/50; joy.y=(Math.sin(a)*d)/50;
    js.style.transform=`translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
};
jz.ontouchend = () => { joy.active=false; joy.x=0; joy.y=0; js.style.transform='none'; };

document.querySelectorAll('.btn-atk').forEach(b => {
    b.ontouchstart=(e)=>{ e.preventDefault(); atkDir[b.dataset.dir]=true; };
    b.ontouchend=(e)=>{ e.preventDefault(); atkDir[b.dataset.dir]=false; };
});

function swap() {
    let l = ['magnum']; if(G.hasFire) l.push('fire'); if(G.hasShot) l.push('shotgun'); if(G.hasStaff) l.push('staff');
    G.weapon = l[(l.indexOf(G.weapon)+1)%l.length]; p.rel=false;
}
document.getElementById('swap-btn').onclick = swap;
window.onkeydown=e=>{ keys.add(e.key.toLowerCase()); if(e.key==='q') swap(); };
window.onkeyup=e=>keys.delete(e.key.toLowerCase());
document.getElementById('btn-start').onclick = () => { G.started=true; document.getElementById('start-screen').style.display='none'; initRoom(); draw(); };
function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
window.onresize = () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }; window.onresize();
</script>
</body>
</html>
