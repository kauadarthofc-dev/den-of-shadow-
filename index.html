<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fox of Isaac: Den of Shadows</title>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; height: 100vh; touch-action: none; user-select: none; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        .overlay h1 { color: #ff4d6d; font-size: 30px; letter-spacing: 5px; margin-bottom: 20px; }
        .btn-ui { padding: 15px 30px; border: 3px solid #fff; background: none; color: #fff; cursor: pointer; font-size: 18px; margin: 10px; font-family: inherit; width: 280px; }
        .btn-ui:hover { background: #fff; color: #000; }
        
        #upgrade-screen { display: none; }
        .upgrade-desc { font-size: 12px; color: #aaa; margin-top: -8px; margin-bottom: 10px; }

        #game-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; background: #000; position: relative; }
        canvas { background: #111; image-rendering: pixelated; max-width: 100%; max-height: 100%; object-fit: contain; aspect-ratio: 4 / 3; }

        /* Controles - Escondidos por padrão via JS */
        #controls { height: 260px; background: #111; display: none; justify-content: space-around; align-items: center; border-top: 4px solid #333; padding-bottom: 20px; }
        .grid-pad { display: grid; grid-template-columns: repeat(3, 60px); gap: 10px; }
        .btn { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        .atk-btn { border-color: #3498db; color: #3498db; }
    </style>
</head>
<body>

<div id="start-screen" class="overlay">
    <h1>COVIL DAS<br>SOMBRAS</h1>
    <p id="mode-text" style="color:#666">Detectando plataforma...</p>
    <button class="btn-ui" onclick="startGame()">INICIAR JOGO</button>
</div>

<div id="upgrade-screen" class="overlay">
    <h1 style="color: #f1c40f;">UPGRADE DISPONÍVEL</h1>
    <div id="upgrade-container"></div>
</div>

<div id="death-screen" class="overlay" style="display:none;">
    <h1>VOCÊ CAIU</h1>
    <button class="btn-ui" onclick="location.reload()">RECOMECAR</button>
</div>

<div id="game-wrapper"><canvas id="game"></canvas></div>

<div id="controls">
    <div class="grid-pad">
        <div></div><div class="btn" id="uBtn">▲</div><div></div>
        <div class="btn" id="lBtn">◀</div><div class="btn" id="dBtn">▼</div><div class="btn" id="rBtn">▶</div>
    </div>
    <div class="grid-pad">
        <div></div><div class="btn atk-btn" id="fUp">▲</div><div></div>
        <div class="btn atk-btn" id="fLf">◀</div><div class="btn atk-btn" id="fDw">▼</div><div class="btn atk-btn" id="fRt">▶</div>
    </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = 400; canvas.height = 300;

const Game = { 
    started: false, lives: 6, maxLives: 6, room: 0, active: true, cleared: true, 
    roomW: 800, roomH: 600, camX: 0, camY: 0, isMobile: false, paused: false 
};

const Stats = { atkSpeed: 15, multiShot: false, moveSpeed: 4 };

// Detecção correta
function detectPlatform() {
    Game.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (window.innerWidth < 800);
    document.getElementById('mode-text').innerText = Game.isMobile ? "MODO MOBILE ATIVADO" : "MODO PC: USE WASD + IJKL";
}
detectPlatform();

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    if(Game.isMobile) document.getElementById('controls').style.display = 'flex';
    Game.started = true;
    initRoom();
    loop();
}

const input = { up: false, down: false, left: false, right: false };
const attack = { up: false, down: false, left: false, right: false };

// Inputs Teclado
window.onkeydown = (e) => {
    let k = e.key.toLowerCase();
    if(k=='w'||k=='arrowup') input.up=true; if(k=='s'||k=='arrowdown') input.down=true;
    if(k=='a'||k=='arrowleft') input.left=true; if(k=='d'||k=='arrowright') input.right=true;
    if(k=='i') attack.up=true; if(k=='k') attack.down=true; if(k=='j') attack.left=true; if(k=='l') attack.right=true;
};
window.onkeyup = (e) => {
    let k = e.key.toLowerCase();
    if(k=='w'||k=='arrowup') input.up=false; if(k=='s'||k=='arrowdown') input.down=false;
    if(k=='a'||k=='arrowleft') input.left=false; if(k=='d'||k=='arrowright') input.right=false;
    if(k=='i') attack.up=false; if(k=='k') attack.down=false; if(k=='j') attack.left=false; if(k=='l') attack.right=false;
};

// Inputs Touch
const bind = (id, obj, key) => {
    let el = document.getElementById(id);
    const set = (v) => (e) => { e.preventDefault(); if(!Game.paused) obj[key] = v; };
    el.addEventListener('touchstart', set(true)); el.addEventListener('touchend', set(false));
    el.addEventListener('mousedown', set(true)); el.addEventListener('mouseup', set(false));
};
bind('uBtn', input, 'up'); bind('dBtn', input, 'down'); bind('lBtn', input, 'left'); bind('rBtn', input, 'right');
bind('fUp', attack, 'up'); bind('fDw', attack, 'down'); bind('fLf', attack, 'left'); bind('fRt', attack, 'right');

class Projectile {
    constructor(x, y, dx, dy, enemy=false) { this.x = x; this.y = y; this.dx = dx; this.dy = dy; this.enemy = enemy; this.active = true; }
    update() {
        this.x += this.dx * (this.enemy ? 3 : 6);
        this.y += this.dy * (this.enemy ? 3 : 6);
        if(this.x < 0 || this.x > Game.roomW || this.y < 0 || this.y > Game.roomH) this.active = false;
    }
    draw() { ctx.fillStyle = this.enemy ? "#f0f" : "#0ff"; ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill(); }
}

class Player {
    constructor() { this.size = 20; this.x = 400; this.y = 300; this.iframe = 0; this.atkTicks = 0; }
    update() {
        if(input.up) this.y -= Stats.moveSpeed; if(input.down) this.y += Stats.moveSpeed;
        if(input.left) this.x -= Stats.moveSpeed; if(input.right) this.x += Stats.moveSpeed;
        this.x = Math.max(40, Math.min(this.x, Game.roomW - 60));
        this.y = Math.max(40, Math.min(this.y, Game.roomH - 60));
        
        if(this.atkTicks <= 0) {
            let dx=0, dy=0;
            if(attack.up) dy=-1; else if(attack.down) dy=1; else if(attack.left) dx=-1; else if(attack.right) dx=1;
            if(dx||dy) {
                projectiles.push(new Projectile(this.x+10, this.y+10, dx, dy));
                if(Stats.multiShot) {
                    let ang = Math.atan2(dy, dx);
                    projectiles.push(new Projectile(this.x+10, this.y+10, Math.cos(ang+0.2), Math.sin(ang+0.2)));
                }
                this.atkTicks = Stats.atkSpeed;
            }
        }
        if(this.atkTicks > 0) this.atkTicks--;
        if(this.iframe > 0) this.iframe--;
    }
    draw() { 
        ctx.fillStyle = (this.iframe > 0 && Math.floor(Date.now()/100)%2) ? "#fff" : "#e67e22"; 
        ctx.fillRect(this.x, this.y, this.size, this.size); 
    }
}

class Enemy {
    constructor(isBoss = false) {
        this.isBoss = isBoss; this.size = isBoss ? 60 : 24; this.hp = isBoss ? 200 : 20; this.alive = true;
        this.x = Math.random() * (Game.roomW - 200) + 100;
        this.y = Math.random() * (Game.roomH - 200) + 100;
        this.vx = (Math.random()-0.5)*3; this.vy = (Math.random()-0.5)*3;
        this.type = isBoss ? 'BOSS' : (Math.random() > 0.6 ? 'SHOOTER' : 'CHASER');
        this.shootTicks = 60;
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if(this.x < 40 || this.x > Game.roomW - 40 - this.size) this.vx *= -1;
        if(this.y < 40 || this.y > Game.roomH - 40 - this.size) this.vy *= -1;
        if((this.type === 'SHOOTER' || this.type === 'BOSS') && --this.shootTicks <= 0) {
            let a = Math.atan2(p.y - this.y, p.x - this.x);
            projectiles.push(new Projectile(this.x+this.size/2, this.y+this.size/2, Math.cos(a), Math.sin(a), true));
            this.shootTicks = this.isBoss ? 45 : 95;
        }
    }
    draw() { 
        ctx.fillStyle = this.isBoss ? "#8e44ad" : (this.type === 'SHOOTER' ? "#c0392b" : "#ff4757");
        ctx.fillRect(this.x, this.y, this.size, this.size);
        if(this.isBoss) {
            ctx.fillStyle = "#222"; ctx.fillRect(this.x, this.y-15, this.size, 6);
            ctx.fillStyle = "#f0f"; ctx.fillRect(this.x, this.y-15, this.size * (this.hp/200), 6);
        }
    }
}

let p = new Player();
let enemies = [], projectiles = [];

function initRoom() {
    projectiles = []; enemies = [];
    if(Game.room === 0) {
        Game.cleared = true; // Sala Segura
    } else if(Game.room % 10 === 0) {
        Game.cleared = false; enemies.push(new Enemy(true));
    } else {
        Game.cleared = false;
        let count = 2 + Math.floor(Game.room/3);
        for(let i=0; i<count; i++) enemies.push(new Enemy());
    }
}

function showUpgradeMenu() {
    Game.paused = true;
    const container = document.getElementById('upgrade-container');
    container.innerHTML = '';
    const options = [
        { t: 'DISPARO RÁPIDO', d: 'Intervalo menor entre tiros', f: () => { Stats.atkSpeed = Math.max(8, Stats.atkSpeed - 3); } },
        { t: 'TIRO DUPLO', d: 'Atira dois projéteis', f: () => { Stats.multiShot = true; } },
        { t: 'VIGOR EXTRA', d: 'Vida máxima +2 e cura', f: () => { Game.maxLives += 2; Game.lives = Game.maxLives; } },
        { t: 'AGILIDADE', d: 'Mais velocidade ao andar', f: () => { Stats.moveSpeed += 0.7; } }
    ];
    options.sort(() => 0.5 - Math.random()).slice(0, 3).forEach(opt => {
        const b = document.createElement('button');
        b.className = 'btn-ui';
        b.innerHTML = `${opt.t}<br><span class="upgrade-desc">${opt.d}</span>`;
        b.onclick = () => { opt.f(); Game.paused = false; document.getElementById('upgrade-screen').style.display = 'none'; };
        container.appendChild(b);
    });
    document.getElementById('upgrade-screen').style.display = 'flex';
}

function loop() {
    if(!Game.active || !Game.started || Game.paused) { requestAnimationFrame(loop); return; }
    
    Game.camX += ((p.x - canvas.width/2) - Game.camX) * 0.1;
    Game.camY += ((p.y - canvas.height/2) - Game.camY) * 0.1;

    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(Math.round(-Game.camX), Math.round(-Game.camY));

    // Chão de Ladrilhos
    for(let x=0; x<Game.roomW; x+=50) {
        for(let y=0; y<Game.roomH; y+=50) {
            ctx.fillStyle = (x+y)/50 % 2 == 0 ? "#111" : "#161616";
            ctx.fillRect(x,y,50,50);
            ctx.strokeStyle = "#000"; ctx.lineWidth = 0.5; ctx.strokeRect(x,y,50,50);
        }
    }
    ctx.strokeStyle = "#333"; ctx.lineWidth = 40; ctx.strokeRect(0,0, Game.roomW, Game.roomH);

    if(Game.cleared) {
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(Game.roomW/2 - 30, 0, 60, 20);
        if(p.y < 45 && Math.abs(p.x - Game.roomW/2) < 40) {
            if(Game.room > 0 && Game.room % 10 === 0) showUpgradeMenu();
            Game.room++; initRoom(); p.y = Game.roomH - 80; p.x = Game.roomW/2;
        }
    }

    p.update(); p.draw();
    projectiles.forEach((proj, i) => {
        proj.update(); proj.draw();
        if(!proj.enemy) {
            enemies.forEach(e => {
                if(e.alive && Math.hypot(proj.x-(e.x+e.size/2), proj.y-(e.y+e.size/2)) < e.size/1.5) {
                    e.hp -= 10; proj.active = false;
                    if(e.hp <= 0) e.alive = false;
                }
            });
        } else if(p.iframe <= 0 && Math.hypot(proj.x-(p.x+10), proj.y-(p.y+10)) < 12) {
            Game.lives--; p.iframe = 60; proj.active = false;
        }
        if(!proj.active) projectiles.splice(i, 1);
    });

    enemies.forEach(e => {
        if(!e.alive) return;
        e.update(); e.draw();
        if(p.iframe <= 0 && Math.hypot(p.x-e.x, p.y-e.y) < 20) { Game.lives--; p.iframe = 60; }
    });

    if(enemies.filter(e => e.alive).length === 0) Game.cleared = true;
    if(Game.lives <= 0) { Game.active = false; document.getElementById('death-screen').style.display='flex'; }

    ctx.restore();
    
    // HUD fixa
    ctx.fillStyle = "#fff"; ctx.font = "bold 12px Courier New";
    ctx.fillText(Game.room === 0 ? "ZONA SEGURA" : "SALA " + Game.room, 10, 20);
    for(let i=0; i<Game.lives; i++) {
        ctx.fillStyle = "#ff4d6d"; ctx.fillRect(10 + (i*10), 28, 7, 7);
    }
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
