<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Capivaras vs Estudantes: Final Fix</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --slot: #2d2d2d;
            --defense: #3d3d3d;
        }
        body {
            margin: 0;
            background: var(--bg);
            color: white;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #header { padding: 20px; text-align: center; }
        .stats { color: #ffd700; font-size: 24px; font-weight: bold; }

        #game-box {
            display: flex;
            gap: 15px;
            background: #333;
            padding: 15px;
            border-radius: 12px;
            border: 4px solid #444;
        }

        /* Grade de Merge */
        .inventory {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            gap: 8px;
        }

        /* Linha de Defesa */
        #defense-line {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: var(--defense);
            padding: 8px;
            border-radius: 8px;
        }

        /* Campo de Batalha */
        #field {
            width: 400px;
            height: 270px;
            background: #111;
            position: relative;
            overflow: hidden;
            border-radius: 0 8px 8px 0;
        }

        .slot {
            width: 80px;
            height: 80px;
            background: var(--slot);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Sprites corrigidos (Pixel Art) */
        .sprite {
            width: 64px;
            height: 64px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            image-rendering: pixelated;
            cursor: grab;
        }

        .student {
            position: absolute;
            width: 50px;
            height: 50px;
            right: -60px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/3468/3468192.png');
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 5;
        }

        .bullet {
            position: absolute;
            width: 12px;
            height: 6px;
            background: #ffcc00;
            border-radius: 3px;
            box-shadow: 0 0 5px orange;
        }

        #btn-buy {
            margin-top: 20px;
            padding: 15px 40px;
            background: #2ecc71;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px #27ae60;
        }
        #btn-buy:active { transform: translateY(2px); box-shadow: 0 2px #27ae60; }
    </style>
</head>
<body>

    <div id="header">
        <div class="stats">ðŸ’° <span id="money">100</span></div>
        <p>Arraste as capivaras para os slots de defesa Ã  direita!</p>
    </div>

    <div id="game-box">
        <div class="inventory" id="inv">
            <div class="slot merge-s"></div><div class="slot merge-s"></div><div class="slot merge-s"></div>
            <div class="slot merge-s"></div><div class="slot merge-s"></div><div class="slot merge-s"></div>
            <div class="slot merge-s"></div><div class="slot merge-s"></div><div class="slot merge-s"></div>
        </div>

        <div id="defense-line">
            <div class="slot def-s" data-row="0"></div>
            <div class="slot def-s" data-row="1"></div>
            <div class="slot def-s" data-row="2"></div>
        </div>

        <div id="field"></div>
    </div>

    <button id="btn-buy">COMPRAR CAPIVARA (20ðŸ’°)</button>

    <script>
        // Imagens Garantidas (Pixel Art)
        const IMGS = [
            'https://i.ibb.co/Vmq9fH0/capy1.png',
            'https://i.ibb.co/9H6S0m6/capy2.png',
            'https://i.ibb.co/L5pGz17/capy3.png',
            'https://i.ibb.co/Lkh6YmP/capy4.png'
        ];

        let coins = 100;
        let dragged = null;

        // --- SISTEMA DE CAPIVARAS ---
        function createCapi(lvl) {
            const div = document.createElement('div');
            div.className = 'sprite';
            div.style.backgroundImage = `url('${IMGS[lvl]}')`;
            div.dataset.lvl = lvl;
            div.dataset.lastShot = 0; // Para controlar a cadÃªncia
            div.draggable = true;
            
            div.ondragstart = () => { dragged = div; setTimeout(() => div.style.opacity = "0.5", 0); };
            div.ondragend = () => { div.style.opacity = "1"; dragged = null; };
            return div;
        }

        // --- DRAG AND DROP ---
        document.querySelectorAll('.slot').forEach(slot => {
            slot.ondragover = e => e.preventDefault();
            slot.ondrop = () => {
                if (!slot.hasChildNodes()) {
                    slot.appendChild(dragged);
                } else {
                    const target = slot.firstChild;
                    if (target.dataset.lvl == dragged.dataset.lvl && target.dataset.lvl < 3) {
                        const newLvl = parseInt(target.dataset.lvl) + 1;
                        target.remove();
                        dragged.remove();
                        slot.appendChild(createCapi(newLvl));
                    }
                }
            };
        });

        // --- COMPRA ---
        document.getElementById('btn-buy').onclick = () => {
            if (coins >= 20) {
                const empty = Array.from(document.querySelectorAll('.merge-s')).find(s => !s.hasChildNodes());
                if (empty) {
                    coins -= 20;
                    empty.appendChild(createCapi(0));
                    document.getElementById('money').innerText = coins;
                }
            }
        };

        // --- LÃ“GICA DE TIRO E INIMIGOS ---
        function spawnStudent() {
            const row = Math.floor(Math.random() * 3);
            const st = document.createElement('div');
            st.className = 'student';
            st.dataset.hp = 100;
            st.dataset.row = row;
            st.style.top = (row * 90 + 20) + 'px';
            document.getElementById('field').appendChild(st);
        }

        function update() {
            // Mover estudantes (lento)
            document.querySelectorAll('.student').forEach(st => {
                let r = parseFloat(st.style.right) || -60;
                st.style.right = (r + 1.2) + 'px';
                if (r > 400) st.remove();
            });

            // Atirar com CADÃŠNCIA CONTROLADA
            const now = Date.now();
            document.querySelectorAll('.def-s').forEach(slot => {
                if (slot.hasChildNodes()) {
                    const capi = slot.firstChild;
                    const cooldown = 1200 - (capi.dataset.lvl * 200); // Lvl 0 atira a cada 1.2s, Lvl 3 a cada 0.6s

                    if (now - capi.dataset.lastShot > cooldown) {
                        const target = Array.from(document.querySelectorAll('.student'))
                                            .find(s => s.dataset.row == slot.dataset.row);
                        if (target) {
                            shoot(slot, target, (parseInt(capi.dataset.lvl) + 1) * 20);
                            capi.dataset.lastShot = now;
                        }
                    }
                }
            });

            if (Math.random() > 0.98) spawnStudent();
        }

        function shoot(slot, target, dmg) {
            const b = document.createElement('div');
            b.className = 'bullet';
            b.style.top = (slot.dataset.row * 90 + 45) + 'px';
            b.style.left = '0px';
            document.getElementById('field').appendChild(b);

            let pos = 0;
            const moveB = setInterval(() => {
                pos += 8;
                b.style.left = pos + 'px';
                const tPos = 400 - parseFloat(target.style.right);
                
                if (pos >= tPos - 20) {
                    clearInterval(moveB);
                    b.remove();
                    target.dataset.hp -= dmg;
                    if (target.dataset.hp <= 0) {
                        target.remove();
                        coins += 10;
                        document.getElementById('money').innerText = coins;
                    }
                }
                if (pos > 400) { clearInterval(moveB); b.remove(); }
            }, 20);
        }

        setInterval(update, 50);
    </script>
</body>
</html>
